<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Los Santos Shop</title>
    <!-- Version check and cache nuke -->
    <script>
        // IMMEDIATE CACHE NUKE - Runs before anything else
        const APP_VERSION = '5.9-NO-WHITE-CIRCLE-HEADER-FIX';
        const lastVersion = localStorage.getItem('app_version_check');
        
        if(lastVersion !== APP_VERSION) {
            console.log('ðŸ”¥ NEW VERSION DETECTED - NUKING ALL CACHE');
            localStorage.clear();
            sessionStorage.clear();
            // Specifically clear locations cache (critical for map pins)
            localStorage.removeItem('locations_cache');
            localStorage.removeItem('shop_cache');
            localStorage.setItem('app_version_check', APP_VERSION);
            console.log('âœ… All cache destroyed including locations_cache');
        }
        
        // Visual confirmation this is the new page
        console.log(`âœ… Los Santos Shop ${APP_VERSION} loaded successfully`);
        
        // KILL ALL SERVICE WORKERS - Prevent service worker caching
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                if (registrations.length > 0) {
                    console.log('ðŸ”¥ Unregistering ' + registrations.length + ' service workers');
                    registrations.forEach(function(registration) {
                        registration.unregister();
                        console.log('âœ… Service worker unregistered:', registration.scope);
                    });
                }
            }).catch(function(err) {
                console.log('Service worker unregister error:', err);
            });
        }
        
        // FORCE RELOAD if old version detected in title
        // This catches cases where the HTML is cached but script runs
        if (document.title.includes('v2.3') || document.title.includes('v2.4') || document.title.includes('v2.5')) {
            console.log('ðŸ”„ OLD VERSION DETECTED IN TITLE - FORCING HARD RELOAD');
            localStorage.clear();
            sessionStorage.clear();
            window.location.reload(true); // Hard reload bypassing cache
        }
    </script>
    <link rel="preload" href="/webapp_fresh/intro.mp4?v=3.1" as="video" type="video/mp4">
    <link rel="preload" href="/webapp_fresh/ah_shit.mp3?v=3.1" as="audio">
    <link rel="preload" href="https://raw.githubusercontent.com/marcoguglie/css-smoke-effect/master/smoke.png" as="image">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- assets.js removed, embedded inline -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">
    <!-- Bungee as fallback for corrupted Pricedown font -->
    <link href="https://fonts.googleapis.com/css2?family=Bungee&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'Pricedown';
            src: url('/webapp_fresh/pricedown.woff2?v=4.3') format('woff2'),
                 url('pricedown.woff2?v=4.3') format('woff2'),
                 url('/webapp_fresh/pricedown.woff?v=4.3') format('woff'),
                 url('pricedown.woff?v=4.3') format('woff');
            font-display: swap;
        }
        
        @font-face {
            font-family: 'GraffitiTwo';
            src: url('/webapp_fresh/GraffitiW00Two.woff2?v=4.3') format('woff2'),
                 url('GraffitiW00Two.woff2?v=4.3') format('woff2'),
                 url('/webapp_fresh/Graffiti%20W00%20Two.woff2?v=4.3') format('woff2'),
                 url('Graffiti%20W00%20Two.woff2?v=4.3') format('woff2');
            font-display: swap;
        }
        
        @font-face {
            font-family: 'MeltdownPhantom';
            src: url('/webapp_fresh/MeltdownPhantom.ttf?v=4.3') format('truetype'),
                 url('MeltdownPhantom.ttf?v=4.3') format('truetype');
            font-display: swap;
        }
        
        /* Fallback font stack - Bungee as backup */
        .gta-font {
            font-family: 'Pricedown', 'Bungee', 'Impact', sans-serif;
        }
        
        :root {
            --gta-green: #ff0000;
            --gta-gold: #cfa936;
            --gta-black: #000000;
            --gta-grey: #a0a0a0;
            
            /* APPLE POLISH VARS */
            --spring-bounce: cubic-bezier(0.34, 1.56, 0.64, 1); 
            --spring-smooth: cubic-bezier(0.25, 0.8, 0.25, 1);
            --glass-bg: rgba(15, 20, 15, 0.85);
            --glass-border: 1px solid rgba(80, 255, 80, 0.15);
        }

        /* Staggered List Entry Animation */
        @keyframes slideInStagger {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Pulse Glow for Pins */
        @keyframes pulseGlow {
            0%, 100% { 
                box-shadow: 0 0 6px rgba(211, 0, 0, 0.7);
            }
            50% { 
                box-shadow: 0 0 12px rgba(211, 0, 0, 0.9), 
                            0 0 20px rgba(211, 0, 0, 0.4);
            }
        }
        
        @keyframes pulseGlowOld {
            0% { 
                box-shadow: 0 0 10px rgba(211, 0, 0, 0.8), 
                            0 2px 4px rgba(0, 0, 0, 0.6); 
            }
            50% { 
                box-shadow: 0 0 20px rgba(211, 0, 0, 1), 
                            0 0 30px rgba(211, 0, 0, 0.5),
                            0 2px 4px rgba(0, 0, 0, 0.6); 
            }
            100% { 
                box-shadow: 0 0 10px rgba(211, 0, 0, 0.8), 
                            0 2px 4px rgba(0, 0, 0, 0.6); 
            }
        }
        
        /* Pin Pulse Animation */
        @keyframes pinPulse {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(211, 0, 0, 0.8), 
                            0 0 40px rgba(211, 0, 0, 0.4),
                            inset 0 0 10px rgba(255, 255, 255, 0.3);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 30px rgba(211, 0, 0, 1), 
                            0 0 60px rgba(211, 0, 0, 0.6),
                            inset 0 0 15px rgba(255, 255, 255, 0.5);
                transform: scale(1.1);
            }
        }
        
        /* Smooth Red Glow Pulse */
        @keyframes redGlowPulse {
            0%, 100% { 
                filter: drop-shadow(0 0 15px rgba(211, 0, 0, 0.25))
                        drop-shadow(0 0 30px rgba(211, 0, 0, 0.15))
                        drop-shadow(0 0 45px rgba(211, 0, 0, 0.1));
            }
            50% { 
                filter: drop-shadow(0 0 20px rgba(211, 0, 0, 0.35))
                        drop-shadow(0 0 40px rgba(211, 0, 0, 0.2))
                        drop-shadow(0 0 60px rgba(211, 0, 0, 0.12));
            }
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--gta-black);
            color: #fff;
            font-family: 'Pricedown', 'Bungee', 'Impact', sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            user-select: none;
            overscroll-behavior: none;
            -webkit-font-smoothing: antialiased;
        }

        /* Background */
        .bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.8)), url('https://upload.wikimedia.org/wikipedia/commons/thumb/3/3e/Los_Angeles_from_Griffith_Observatory.jpg/1280px-Los_Angeles_from_Griffith_Observatory.jpg');
            background-size: cover;
            background-position: center;
            z-index: -2;
        }

        /* Scanline Effect */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            z-index: 100;
            pointer-events: none;
            opacity: 0.3;
        }

        /* App Header (Minimal Authentic) */
        .app-header {
            display: none !important; /* Hidden to use Custom Headers */
            background: #000;
            border-bottom: 2px solid #333;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            height: 60px;
            box-sizing: border-box;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        
        /* Center Only */
        .header-center { 
            text-align: center; 
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .zone-text {
            font-family: 'Pricedown', 'Bungee', 'Impact', sans-serif;
            font-size: 32px;
            color: #fff;
            letter-spacing: 2px;
            text-shadow: 3px 3px 0 #000;
            text-transform: uppercase;
            transform: scaleY(1.1);
        }
        
        .money {
            color: var(--gta-green);
            font-size: 26px;
            font-family: 'Pricedown', 'Bungee', 'Impact', sans-serif;
            text-shadow: 2px 2px 0 #000;
            letter-spacing: 1px;
        }

        /* Wanted Level */
        .wanted-stars {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .star {
            font-size: 20px;
            color: #333; /* Inactive */
        }
        
        .star.active {
            color: #fff;
            text-shadow: 0 0 5px #fff;
        }
        
        .star.flashing {
            animation: starFlash 0.5s infinite alternate;
        }
        
        @keyframes starFlash {
            from { color: #fff; opacity: 1; }
            to { color: #cfa936; opacity: 0.8; }
        }

        /* Navigation (HUD Style) */
        .bottom-nav {
            position: fixed;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 92%;
            max-width: 420px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border: 2px solid var(--gta-green);
            border-radius: 50px;
            display: flex;
            justify-content: space-evenly;
            padding: 12px 0;
            z-index: 10000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.9), 0 0 20px rgba(255, 0, 0, 0.2);
            backdrop-filter: blur(15px);
        }
        
        @media (max-width: 480px) {
            .bottom-nav {
                bottom: 10px;
                width: 95%;
                padding: 10px 0;
                border-width: 2px;
            }
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
            width: 70px;
            padding: 5px;
        }
        
        @media (max-width: 480px) {
            .nav-item {
                width: 60px;
                padding: 3px;
            }
        }
        
        .nav-icon {
            font-size: 24px;
            margin-bottom: 2px;
            filter: grayscale(100%) brightness(0.7);
            transition: all 0.2s;
        }
        
        @media (max-width: 480px) {
            .nav-icon {
                font-size: 20px;
            }
        }
        
        .nav-item span {
            font-family: 'GraffitiTwo', 'Impact', sans-serif;
            font-size: 11px;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }
        
        @media (max-width: 480px) {
            .nav-item span {
                font-size: 9px;
            }
        }
        
        .nav-item.active {
            color: var(--gta-green);
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }
        
        .nav-item.active .nav-icon {
            filter: grayscale(0%) brightness(1.2);
            transform: scale(1.2);
            text-shadow: 0 0 10px var(--gta-green);
        }

        /* Content Area */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            /* FIX: Extra padding so last row isn't blocked by bottom nav */
            padding-bottom: 120px;
            position: relative;
            z-index: 1;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
        }

        /* Sections */
        .section {
            display: none;
            animation: fadeIn 0.3s ease-in;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            overflow-y: auto;
        }
        
        #shop {
            background-image: url('2boys.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
        }
        
        #map {
            background-image: url('2boys.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* Force 2 columns ALWAYS */
            gap: 12px;
            padding: 10px;
            padding-bottom: 100px; /* Space for bottom navigation */
            margin-bottom: 20px;
        }
        
        @media (max-width: 480px) {
            .product-grid {
                gap: 8px;
                padding: 8px;
                padding-bottom: 100px;
            }
        }

        /* Cart Grid - Strictly Vertical Single Column */
        .cart-grid {
            display: flex;
            flex-direction: column;
            gap: 16px; /* Spacing between cards */
            padding: 20px;
            padding-bottom: 100px;
            overflow-y: auto;
            position: relative;
            z-index: 1;
        }

        /* Cart Container - Glass & Grid Theme (Fixed) */
        .cart-container {
            position: relative;
            width: 100%;
            height: 85vh;
            background: #181818; /* Fallback */
            background: rgba(25, 25, 30, 0.98); /* High Opacity */
            border-radius: 24px 24px 0 0;
            box-shadow: 0 -10px 50px rgba(0,0,0,0.9);
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 10;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-top: 2px solid var(--gta-green); /* High Visibility Border */
            will-change: transform;
        }

        /* ACTIVE STATE - Applied by JS */
        .cart-container.active {
            transform: translateY(0) !important;
        }

        /* "Deep Feeling" Grid Background */
        .cart-container::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 100%;
            /* Retro Cyber Grid Pattern */
            background-image: 
                linear-gradient(rgba(63, 165, 53, 0.15) 1px, transparent 1px),
                linear-gradient(90deg, rgba(63, 165, 53, 0.15) 1px, transparent 1px);
            background-size: 40px 40px;
            /* Fade out at bottom */
            mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 0%, rgba(0,0,0,0.2) 60%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 0%, rgba(0,0,0,0.2) 60%, transparent 100%);
            z-index: 0;
            pointer-events: none;
            opacity: 0.8; /* Increased visibility */
        }

        /* Cart Header Bar - Transparent */
        .cart-header-bar {
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            background: transparent; /* Transparent to show grid */
            position: relative;
            z-index: 2;
        }

        .cart-header-title {
            font-size: 28px;
            font-family: 'Pricedown', 'Bungee', 'Impact', sans-serif;
            color: #fff;
            text-shadow: 0 2px 15px rgba(63, 165, 53, 0.5);
            display: flex; align-items: center; gap: 10px;
        }

        .cart-header-close {
            width: 36px; height: 36px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            border: none;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.2s;
            backdrop-filter: blur(10px);
        }
        .cart-header-close:hover { background: rgba(255,255,255,0.2); }

        /* Staggered Entrance Animation */
        @keyframes slideInStagger {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* PRO ROW CARD (FINAL) */
        .cart-item {
            background: rgba(30, 30, 35, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-left: 4px solid var(--gta-green);
            border-radius: 12px;
            
            /* Layout */
            display: flex;
            flex-direction: row;
            align-items: center;
            padding: 10px 12px; /* Reduced Padding */
            gap: 12px; /* Reduced Gap */
            width: 100%; /* Ensure full width but constrained */
            box-sizing: border-box; /* Prevent padding overflow */
            min-height: 72px;
            
            /* Glow & Depth */
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), background 0.2s;
            position: relative;
            overflow: hidden;
            
            /* Initial state for animation */
            opacity: 0; 
            animation: slideInStagger 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }
        
        .cart-item:hover {
            background: rgba(40, 40, 45, 0.8);
            transform: scale(1.01) translateX(2px); /* Reduced scale to prevent overflow */
            z-index: 10;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        /* Card Hover Effect */
        .cart-item:active {
            background: rgba(255, 255, 255, 0.08);
            transform: scale(0.98);
        }

        /* Left: Icon Box (Floating) */
        .cart-item-left {
            width: 48px; /* Reduced Size */
            height: 48px;
            background: linear-gradient(135deg, #2c3e50, #000000);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            z-index: 2;
            flex-shrink: 0; /* Prevent shrinking */
        }
        
        .cart-item-icon {
            font-size: 24px; /* Adjusted Size */
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        /* Middle: Details */
        .cart-item-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 4px;
            z-index: 2;
            min-width: 0;
        }
        
        .cart-item-title {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 700;
            font-size: 17px;
            color: #fff;
            letter-spacing: 0.3px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .cart-item-sub {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Right: Price & Delete */
        .cart-item-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: center;
            gap: 8px;
            z-index: 2;
            flex-shrink: 0;
        }
        
        .cart-item-price {
            font-family: 'Pricedown', 'Bungee', 'Impact', sans-serif;
            font-size: 24px;
            color: var(--gta-green);
            text-shadow: 0 0 10px rgba(63, 165, 53, 0.4);
        }
        
        .btn-cart-remove {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: rgba(255, 59, 48, 0.15);
            border: 1px solid rgba(255, 59, 48, 0.3);
            color: #ff453a;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0; /* Hide text */
            padding: 0;
        }
        
        .btn-cart-remove:hover {
            background: rgba(255, 59, 48, 0.3);
            transform: scale(1.1);
        }

        .btn-cart-remove::after {
            content: 'âœ•';
            font-size: 14px;
            font-weight: bold;
            font-family: sans-serif;
            color: #ff453a;
        }
        
        /* GTA Accent Bar (Glow) */
        .cart-item::after {
            content: '';
            position: absolute;
            bottom: 0; left: 20px; right: 20px;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            z-index: 1;
        }
        
        .cart-item::before {
            display: none; /* Remove old green bar */
        }

        /* RETRO CYBER CARD (V2) */
        .product-card {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(211, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
            animation: cardSlideIn 0.4s ease-out backwards;
        }
        
        @media (max-width: 480px) {
            .product-card {
                padding: 10px;
                border-width: 2px;
            }
        }

        .product-card:hover {
            border-color: rgba(211, 0, 0, 0.8);
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 8px 25px rgba(211, 0, 0, 0.4), 
                        0 0 30px rgba(211, 0, 0, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.15);
            background: rgba(0, 0, 0, 0.7);
            z-index: 10;
        }
        
        /* Tech Accent Bar */
        .product-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 2px;
            background: linear-gradient(90deg, 
                                        transparent, 
                                        rgba(211, 0, 0, 0.6), 
                                        transparent);
            opacity: 0.5;
        }
        .product-card:hover::before {
            opacity: 1;
            box-shadow: 0 0 15px rgba(211, 0, 0, 0.6);
        }

        /* Clean Emoji Style (No Slot) */
        .product-emoji {
            font-size: 60px;
            margin: 15px 0;
            cursor: pointer;
            text-align: center;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5));
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .product-emoji:hover {
            transform: scale(1.2);
        }

        .product-name {
            font-family: 'GraffitiTwo', 'Impact', sans-serif;
            font-size: 16px;
            margin: 5px 0;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1.2;
            text-shadow: 0 0 10px rgba(211, 0, 0, 0.4),
                         2px 2px 4px rgba(0, 0, 0, 0.8);
        }
        
        @media (max-width: 480px) {
            .product-name {
                font-size: 13px;
                margin: 4px 0;
            }
        }

        .product-details {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #ccc;
            margin-bottom: 10px;
        }

        .product-price {
            font-size: 20px;
            color: #D30000;
            margin: 8px 0;
            text-shadow: 0 0 8px rgba(211, 0, 0, 0.5),
                         1px 1px 0 #000;
            font-weight: bold;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.6));
        }
        
        @media (max-width: 480px) {
            .product-price {
                font-size: 16px;
                margin: 6px 0;
            }
        }

        @keyframes cardSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .btn-buy {
            background: var(--gta-green);
            color: #000;
            border: 2px solid #000;
            border-radius: 4px;
            padding: 12px;
            font-family: 'GraffitiTwo', 'Impact', sans-serif;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.1s;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
            box-shadow: 0 3px 0 #000;
            font-weight: bold;
        }
        
        @media (max-width: 480px) {
            .btn-buy {
                padding: 10px;
                font-size: 12px;
            }
        }
        
        .btn-buy:hover {
            background: var(--gta-green);
            color: #000;
            filter: brightness(1.2);
            transform: translateY(-2px);
            box-shadow: 0 5px 0 #000, 0 0 15px var(--gta-green);
        }
        
        .btn-buy:active {
            transform: translateY(3px);
            box-shadow: 0 0 0 #000;
            filter: brightness(0.8);
        }

        /* Radio Toggle Button */
        .radio-pill {
            position: fixed;
            bottom: 160px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #444;
            border-radius: 30px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 9999;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0,0,0,0.6);
            transition: all 0.2s ease;
            pointer-events: auto;
        }
        
        .radio-pill:hover {
            background: #1a1a1a;
            border-color: #D30000;
        }
        
        .radio-pill:active {
            transform: scale(0.95);
            background: #222;
            border-color: #D30000;
        }
        
        .radio-visualizer {
            display: flex;
            align-items: flex-end;
            height: 16px;
            gap: 3px;
        }
        
        .viz-bar {
            width: 3px;
            background: #D30000;
            height: 20%;
            transition: height 0.2s;
            border-radius: 2px;
            box-shadow: 0 0 5px rgba(211, 0, 0, 0.5);
        }
        
        /* Animate only when active */
        .radio-visualizer.viz-active .viz-bar {
            animation: vizEq 0.5s infinite ease-in-out;
        }
        
        .viz-bar.b1 { animation-duration: 0.4s; }
        .viz-bar.b2 { animation-duration: 0.6s; }
        .viz-bar.b3 { animation-duration: 0.5s; }
        .viz-bar.b4 { animation-duration: 0.7s; }
        
        @keyframes vizEq {
            0%, 100% { height: 20%; opacity: 0.5; }
            50% { height: 100%; opacity: 1; }
        }
        
        .radio-text-scroll {
            color: #D30000;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 12px;
            white-space: nowrap;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        @media (max-width: 480px) {
            .radio-pill {
                bottom: 140px;
                right: 10px;
                padding: 6px 12px;
                gap: 8px;
            }
            
            .radio-text-scroll {
                font-size: 11px;
                max-width: 100px;
            }
        }

        /* GTA Street Sign Header */
        .street-sign-header {
            background: transparent;
            border: none;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 60px;
            pointer-events: none;
            position: relative;
            z-index: 100;
        }
        
        /* Fix Mobile Wobble */
        body, html {
            overflow-x: hidden;
            width: 100%;
            position: relative;
        }

        /* Street Sign Header - Full Scene */
        .street-sign-container {
            display: none;
        }

        /* Vertical Metal Pole */
        .sign-pole {
            width: 10px;
            height: 105px;
            margin-top: 12px;
            background: linear-gradient(to right, 
                #3a3a3a 0%, 
                #6a6a6a 30%, 
                #7a7a7a 50%,
                #5a5a5a 80%,
                #3a3a3a 100%
            );
            border-radius: 3px;
            box-shadow: 3px 3px 8px rgba(0,0,0,0.5);
            position: relative;
        }

        /* Rust spots on pole */
        .sign-pole::before {
            content: '';
            position: absolute;
            top: 30px;
            left: 2px;
            width: 5px;
            height: 12px;
            background: rgba(139, 90, 43, 0.4);
            border-radius: 50%;
            filter: blur(1px);
        }

        .sign-pole::after {
            content: '';
            position: absolute;
            bottom: 15px;
            right: 1px;
            width: 4px;
            height: 8px;
            background: rgba(120, 70, 30, 0.35);
            border-radius: 50%;
            filter: blur(1px);
        }

        /* Horizontal Bracket */
        .sign-bracket {
            width: 20px;
            height: 10px;
            background: linear-gradient(to bottom, 
                #6a6a6a 0%, 
                #5a5a5a 50%,
                #4a4a4a 100%
            );
            margin-top: 20px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.4);
            border-radius: 0 2px 2px 0;
        }

        /* The Sign Itself - BENT CORNER */
        .street-sign {
            background: #000000;
            border: 6px solid #ffffff;
            border-radius: 8px;
            padding: 10px 25px;
            margin-top: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.7);
            transform-origin: left center;
            position: relative;
            overflow: visible;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            min-width: 280px;
        }
        
        .street-sign::after {
            content: '';
            width: 0;
            height: 0;
            border-top: 20px solid transparent;
            border-bottom: 20px solid transparent;
            border-left: 30px solid #ffffff;
            margin-right: -10px;
        }

        /* Bent corner shadow */
        .bent-corner {
            display: none;
            width: 20px;
            height: 15px;
            background: linear-gradient(135deg, 
                transparent 40%,
                rgba(0,0,0,0.3) 50%,
                #e0e0e0 60%
            );
            border-radius: 0 0 0 3px;
            transform: rotate(-5deg);
        }

        /* Sitting Bird (Crow/Pigeon) */
        .bird {
            display: none;
        }

        .bird-body {
            width: 18px;
            height: 12px;
            background: linear-gradient(to bottom, #2a2a2a 0%, #1a1a1a 100%);
            border-radius: 50% 50% 40% 40%;
            position: relative;
        }

        .bird-head {
            position: absolute;
            top: -5px;
            left: -3px;
            width: 10px;
            height: 9px;
            background: linear-gradient(to bottom, #2a2a2a 0%, #1a1a1a 100%);
            border-radius: 50%;
        }

        .bird-beak {
            position: absolute;
            top: 1px;
            left: -5px;
            width: 6px;
            height: 3px;
            background: #4a4a4a;
            border-radius: 2px 0 0 2px;
            clip-path: polygon(0% 50%, 100% 0%, 100% 100%);
        }

        .bird-eye {
            position: absolute;
            top: 2px;
            left: 1px;
            width: 2px;
            height: 2px;
            background: #fff;
            border-radius: 50%;
        }

        .bird-tail {
            position: absolute;
            top: 2px;
            right: -8px;
            width: 10px;
            height: 5px;
            background: #1a1a1a;
            border-radius: 0 3px 3px 0;
            transform: rotate(-5deg);
        }

        .bird-legs {
            position: absolute;
            bottom: -4px;
            left: 5px;
            width: 8px;
            height: 5px;
            border-left: 2px solid #3a3a3a;
            border-right: 2px solid #3a3a3a;
        }

        /* Bird idle animation */
        .bird {
            animation: birdIdle 4s ease-in-out infinite;
        }

        @keyframes birdIdle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-1px); }
        }

        /* Bullet Holes */
        .bullet-hole {
            display: none;
            background: radial-gradient(circle, 
                #1a1a1a 0%, 
                #2a2a2a 40%, 
                transparent 60%
            );
            border-radius: 50%;
            box-shadow: 
                inset 0 1px 2px rgba(0,0,0,0.8),
                0 0 0 1px rgba(80,80,80,0.5);
        }

        .bullet-hole.h1 {
            top: 8px;
            right: 15px;
        }

        .bullet-hole.h2 {
            bottom: 15px;
            left: 20px;
            width: 6px;
            height: 6px;
        }

        /* Small Graffiti Tag */
        .graffiti-tag {
            display: none;
            font-family: 'Arial', sans-serif;
            font-size: 8px;
            font-weight: bold;
            color: rgba(255, 50, 50, 0.7);
            transform: rotate(-5deg);
            text-shadow: 0 0 2px rgba(0,0,0,0.5);
            letter-spacing: -1px;
        }

        /* Sticker Residue */
        .sticker-residue {
            display: none;
            width: 12px;
            height: 8px;
            background: rgba(200, 180, 150, 0.3);
            border-radius: 1px;
            transform: rotate(3deg);
        }

        /* Rust Stain */
        .rust-stain {
            display: none;
            transform: translateY(-50%);
            width: 15px;
            height: 10px;
            background: linear-gradient(to right, 
                rgba(139, 90, 43, 0.35) 0%,
                rgba(100, 60, 25, 0.15) 70%,
                transparent 100%
            );
            border-radius: 50%;
            filter: blur(2px);
        }

        .sign-text {
            font-family: 'Arial Black', 'Helvetica', sans-serif;
            font-size: 18px;
            font-weight: 900;
            color: #ffffff;
            text-transform: uppercase;
            white-space: nowrap;
            letter-spacing: 1px;
            line-height: 1.2;
            margin: 0;
            padding: 0;
            letter-spacing: 2px;
            text-shadow: 
                2px 2px 3px rgba(0,0,0,0.5),
                -1px -1px 0 rgba(0,0,0,0.2);
            white-space: nowrap;
            position: relative;
            z-index: 1;
        }

        .sign-text .st {
            font-size: 22px;
            margin-left: 5px;
            opacity: 0.9;
        }

        @keyframes signSway {
            0%, 100% { transform: rotate(0deg); }
            30% { transform: rotate(0.5deg); }
            70% { transform: rotate(-0.5deg); }
        }

        /* Search Container Adjustment - Merged into Main Definition */
        
        /* Removed Old Headers */
        .hood-header, .street-sign-header, .radio-faceplate-header, .spray-header, .tape-header-v3, .tape-header, .tape-strip, .tape-text, .wanted-header { display: none; }
        .header-title { display: none; }

        /* Shop Header - Big Company Bot */
        .shop-header {
            font-family: 'MeltdownPhantom', 'Impact', 'Arial Black', sans-serif;
            font-size: 48px;
            font-weight: bold;
            color: #D30000;
            text-shadow: 
                5px 5px 0 #000,
                -2px -2px 0 #000,
                2px -2px 0 #000,
                -2px 2px 0 #000,
                0 5px 15px rgba(0, 0, 0, 0.9);
            text-align: center;
            position: relative;
            background: transparent;
            padding: 18px 15px 12px 15px;
            margin: 12px 8px 8px 8px;
            letter-spacing: 2px;
            z-index: 61;
            white-space: nowrap;
            transform: scale(1.05);
            filter: drop-shadow(0 0 15px rgba(211, 0, 0, 0.25))
                    drop-shadow(0 0 30px rgba(211, 0, 0, 0.15))
                    drop-shadow(0 0 45px rgba(211, 0, 0, 0.1));
            animation: redGlowPulse 3s ease-in-out infinite;
            overflow: visible;
        }
        
        @media (max-width: 480px) {
            .shop-header {
                font-size: 30px;
                padding: 12px 10px 8px 10px;
                margin: 10px 5px 6px 5px;
                line-height: 1.1;
                letter-spacing: 1px;
            }
        }
        
        /* Search Bar (LSPD Terminal - Minimal) */
        .search-container {
            margin-top: 10px;
            margin-bottom: 15px; 
            margin-left: 10px;
            margin-right: 10px;
            border: 1px solid rgba(255, 0, 0, 0.4);
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(8px);
            padding: 8px 10px;
            display: flex;
            align-items: center;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.2), inset 0 0 10px rgba(255, 0, 0, 0.05);
            position: relative;
            border-radius: 4px;
            z-index: 60;
        }
        
        @media (max-width: 480px) {
            .search-container {
                margin-top: 8px;
                margin-bottom: 12px;
                padding: 6px 8px;
                font-size: 11px;
                background: rgba(0,0,0,0.6);
            }
        }
        
        .search-container::after {
            content: 'LSPD_DB';
            position: absolute;
            right: 5px; top: -8px;
            background: #000;
            font-size: 9px; 
            color: #ffffff;
            padding: 0 4px;
            font-family: monospace;
            text-shadow: 0 0 8px rgba(255, 0, 0, 0.6);
        }
        
        .search-input {
            background: transparent;
            border: none;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            width: 100%;
            outline: none;
            text-transform: uppercase;
            font-weight: bold;
            padding: 0;
            border-radius: 0;
            letter-spacing: 0.5px;
        }
        
        @media (max-width: 480px) {
            .search-input {
                font-size: 10px;
            }
        }
        
        .search-input::placeholder { color: rgba(255, 255, 255, 0.3); }
        
        .search-label {
            color: rgba(255, 255, 255, 0.9);
            font-family: 'Courier New', monospace;
            margin-right: 8px;
            font-weight: bold;
            display: block;
            font-size: 11px;
            text-shadow: 0 0 8px rgba(255, 0, 0, 0.4);
            white-space: nowrap;
        }
        
        @media (max-width: 480px) {
            .search-label {
                font-size: 9px;
                margin-right: 5px;
            }
        }

        /* Map Zoom */
        /* District Selection Modal (GTA SA Style) */
        .district-modal {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 85%;
            max-width: 380px;
            background: rgba(0, 0, 0, 0.95);
            border: 4px solid var(--gta-gold);
            z-index: 1000;
            padding: 20px;
            text-align: center;
            box-shadow: 0 10px 50px rgba(0,0,0,1);
            animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes modalPop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .district-header {
            font-family: 'Pricedown', 'Bungee', 'Impact', sans-serif;
            font-size: 42px;
            color: var(--gta-gold);
            margin-bottom: 20px;
            text-shadow: 3px 3px 0 #000;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        .district-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 280px;
            overflow-y: auto;
            padding-right: 5px;
            margin-bottom: 15px;
        }

        .district-list::-webkit-scrollbar { width: 5px; }
        .district-list::-webkit-scrollbar-track { background: #111; }
        .district-list::-webkit-scrollbar-thumb { background: var(--gta-gold); }
        
        .district-item {
            background: #222;
            color: #fff;
            padding: 15px;
            font-family: 'Impact', sans-serif;
            font-size: 20px;
            letter-spacing: 1px;
            border-left: 6px solid #444;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        
        .district-item:hover {
            background: var(--gta-gold);
            color: #000;
            border-left-color: #fff;
            padding-left: 25px;
            transform: scale(1.02);
        }
        
        .district-item.grove { border-left-color: var(--gta-green); }
        .district-item.grove:hover { background: var(--gta-green); color: #fff; border-left-color: #fff; }
        
        .district-item.ballas { border-left-color: #d0a; }
        .district-item.ballas:hover { background: #d0a; color: #fff; border-left-color: #fff; }
        
        .district-item.vagos { border-left-color: #fb0; }
        .district-item.vagos:hover { background: #fb0; color: #000; border-left-color: #fff; }

        /* --- GTA SA SATELLITE MAP THEME --- */
        .map-container {
            position: relative;
            height: 100vh; /* Full Screen */
            width: 100%;
            background-color: transparent;
            overflow: hidden;
            border: none;
            border-radius: 0;
            font-family: 'Courier New', monospace;
        }

        /* 1. Grid Overlay (Moving) */
        .map-grid {
            display: none !important;
        }

        @keyframes gridPan {
            0% { transform: perspective(500px) rotateX(20deg) translateY(0); }
            100% { transform: perspective(500px) rotateX(20deg) translateY(40px); }
        }

        /* 2. CRT Scanline */
        .scanline-bar {
            display: none !important;
        }

        @keyframes scanlineMove {
            0% { top: -10%; }
            100% { top: 110%; }
        }

        /* 3. Noise Overlay */
        .noise-overlay {
            display: none !important;
        }

        /* 4. Map Layers (Depth) */
        .map-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        /* Outline Layer (Thick Black) */
        .map-layer.outline path {
            stroke: #000;
            stroke-width: 60px;
            fill: none;
            stroke-linejoin: round;
        }
        
        /* Dark Terrain Layer (Shadow) */
        .map-layer.dark path {
            fill: #2a3a2a; 
            transform: translate(8px, 8px);
        }

        /* Mid Terrain Layer */
        .map-layer.mid path {
            fill: #3a4e3a;
            transform: translate(4px, 4px);
        }

        /* Top/Light Terrain Layer (Main) */
        .map-layer.main path {
            fill: #5c7a5c; /* GTA Grass Green */
            stroke: #1a2a1a;
            stroke-width: 2px;
        }

        /* 5. Radar Sweep */
        .radar-beam {
            position: absolute;
            top: 50%; left: 50%;
            width: 60%; height: 60%;
            background: conic-gradient(from 0deg, transparent 300deg, rgba(0, 255, 0, 0.2) 360deg);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: radarRotate 4s linear infinite;
            pointer-events: none;
            z-index: 5;
        }
        
        @keyframes radarRotate {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }


        /* CRT Scanline Overlay */
        /* Map Header - Shop Style */
        .map-header {
            font-family: 'MeltdownPhantom', 'Impact', 'Arial Black', sans-serif;
            font-size: 48px;
            font-weight: bold;
            color: #D30000;
            text-shadow: 
                5px 5px 0 #000,
                -2px -2px 0 #000,
                2px -2px 0 #000,
                -2px 2px 0 #000,
                0 5px 15px rgba(0, 0, 0, 0.9);
            text-align: center;
            position: relative;
            background: transparent;
            padding: 18px 15px 12px 15px;
            margin: 12px 8px 8px 8px;
            letter-spacing: 2px;
            z-index: 100;
            white-space: nowrap;
            transform: scale(1.05);
            filter: drop-shadow(0 0 15px rgba(211, 0, 0, 0.25))
                    drop-shadow(0 0 30px rgba(211, 0, 0, 0.15))
                    drop-shadow(0 0 45px rgba(211, 0, 0, 0.1));
            animation: redGlowPulse 3s ease-in-out infinite;
        }
        
        @media (max-width: 480px) {
            .map-header {
                font-size: 30px;
                padding: 12px 10px 8px 10px;
                margin: 10px 5px 6px 5px;
                line-height: 1.1;
                letter-spacing: 1px;
            }
        }

        .map-container::after {
            display: none; /* Remove scanline overlay */
        }

        /* Radar Sweep Animation */
        .radar-sweep {
            display: none !important;
        }
        
        .radar-sweep-old {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200%;
            height: 200%;
            transform: translate(-50%, -50%);
            background: conic-gradient(
                from 0deg, 
                transparent 0deg, 
                rgba(0, 255, 0, 0.05) 60deg, 
                rgba(0, 255, 0, 0.2) 90deg, 
                transparent 91deg
            );
            border-radius: 50%;
            animation: radarSpin 4s linear infinite;
            pointer-events: none;
            z-index: 2;
        }

        @keyframes radarSpin {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        @keyframes blinkText {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* The Land Mass (Lithuania) - Digital Outline */
        .map-img-interactive g {
            fill: rgba(0, 0, 0, 0.35);
            stroke: rgba(211, 0, 0, 0.9);
            stroke-width: 6px;
            stroke-linejoin: round;
            stroke-linecap: round;
            filter: drop-shadow(0 0 20px rgba(211, 0, 0, 0.7)) 
                    drop-shadow(0 0 40px rgba(211, 0, 0, 0.4))
                    drop-shadow(0 0 8px rgba(255, 255, 255, 0.3));
            opacity: 1;
            transition: all 0.3s ease;
        }

        .map-img-interactive:hover g {
            stroke: rgba(211, 0, 0, 1);
            filter: drop-shadow(0 0 30px rgba(211, 0, 0, 0.9)) 
                    drop-shadow(0 0 60px rgba(211, 0, 0, 0.6))
                    drop-shadow(0 0 10px rgba(255, 255, 255, 0.4));
        }

        /* 6. Markers (Clean Dots) */
        .gta-marker {
            position: absolute;
            display: flex;
            align-items: center;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 30;
            transition: transform 0.2s;
        }

        .gta-marker:hover {
            transform: translate(-50%, -50%) scale(1.15);
            z-index: 35;
        }

        .marker-icon {
            width: 12px;
            height: 12px;
            background: #D30000;
            border: 2px solid #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(211, 0, 0, 0.8),
                        0 2px 4px rgba(0, 0, 0, 0.6);
            margin-right: 6px;
            animation: pulseGlow 3s infinite;
        }
        
        /* Specific Icon Images (SVGs embedded) */
        .marker-icon svg {
            width: 24px; height: 24px;
            fill: #000;
        }

        .marker-label {
            font-family: 'MeltdownPhantom', 'Impact', 'Arial Black', sans-serif;
            color: #fff;
            font-size: 11px; /* Smaller text to match smaller dot */
            font-weight: bold;
            text-shadow: 1px 1px 2px #000, -1px -1px 1px #000;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }

        /* Pulsing Blip - Hidden, markers have their own animation */
        .blip-pulse {
            display: none;
        }
        
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(4); opacity: 0; }
        }

        /* 7. Data Feed */
        .data-feed {
            background: #000;
            border-top: 2px solid #333;
            color: var(--gta-green);
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 8px 10px;
            white-space: nowrap;
            overflow: hidden;
            position: relative;
            text-transform: uppercase;
        }
        
        .data-scroll {
            display: inline-block;
            animation: marquee 20s linear infinite;
        }
        
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        
        /* 8. Slide-in District Menu (Replaces old Modal) */
        .district-menu-slide {
            position: absolute;
            top: 20px; right: -250px; /* Hidden right */
            width: 220px;
            background: rgba(0,0,0,0.95);
            border: 3px solid var(--gta-green);
            padding: 0;
            transition: right 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 50;
            box-shadow: -10px 10px 20px rgba(0,0,0,0.8);
            display: block !important; /* Override old display:none */
        }
        
        .district-menu-slide.active {
            right: 20px;
        }
        
        .dm-header {
            background: var(--gta-green);
            color: #000;
            font-family: 'Pricedown', 'Bungee', 'Impact', sans-serif;
            font-size: 28px;
            padding: 10px;
            text-align: center;
            border-bottom: 2px solid #000;
        }
        
        .dm-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .dm-item {
            padding: 12px 15px;
            color: var(--gta-green);
            font-family: 'Impact', sans-serif;
            font-size: 18px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            text-transform: uppercase;
            transition: 0.2s;
            display: flex;
            justify-content: space-between;
        }
        
        .dm-item:hover {
            background: var(--gta-green);
            color: #000;
            padding-left: 20px;
        }
        
        .dm-close {
            width: 100%;
            background: #333;
            color: #fff;
            border: none;
            padding: 10px;
            font-family: 'Impact', sans-serif;
            cursor: pointer;
            text-transform: uppercase;
        }
        .dm-close:hover { background: #555; }


        /* City Markers -> "Blips" */
        .district-marker {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: transparent;
            border: none;
            color: #e0e0e0;
            font-family: Arial, Helvetica, sans-serif; /* GTA Menu Font */
            font-weight: 900;
            text-shadow: 2px 2px 0 #000, -1px -1px 0 #000;
            font-size: 14px;
            letter-spacing: 1px;
            text-transform: uppercase;
            pointer-events: none; /* Let clicks pass to the blip */
            transform: translate(-50%, -50%);
            position: absolute;
            transition: 0.2s;
        }

        /* Pixel Art Icon Styles */
        .blip-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--gta-gold);
            border-radius: 6px;
            box-shadow: 0 0 15px rgba(0,0,0,0.8);
            margin-bottom: 5px;
            transition: transform 0.2s, border-color 0.2s, background-color 0.2s;
            pointer-events: auto;
            cursor: pointer;
        }
        
        .blip-icon:hover {
            transform: scale(1.3);
            background: var(--gta-gold);
            border-color: #fff;
            z-index: 30;
        }

        /* District Selection Modal (GTA SA Style) */
        .district-modal {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 85%;
            max-width: 380px;
            background: rgba(0, 0, 0, 0.95);
            border: 4px solid var(--gta-gold);
            z-index: 1000;
            padding: 20px;
            text-align: center;
            box-shadow: 0 10px 50px rgba(0,0,0,1);
            animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes modalPop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .district-header {
            font-family: 'Pricedown', 'Bungee', 'Impact', sans-serif;
            font-size: 42px;
            color: var(--gta-gold);
            margin-bottom: 20px;
            text-shadow: 3px 3px 0 #000;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        .district-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 280px;
            overflow-y: auto;
            padding-right: 5px;
            margin-bottom: 15px;
        }

        .district-list::-webkit-scrollbar { width: 5px; }
        .district-list::-webkit-scrollbar-track { background: #111; }
        .district-list::-webkit-scrollbar-thumb { background: var(--gta-gold); }
        
        .district-item {
            background: #222;
            color: #fff;
            padding: 15px;
            font-family: 'Impact', sans-serif;
            font-size: 20px;
            letter-spacing: 1px;
            border-left: 6px solid #444;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        
        .district-item:hover {
            background: var(--gta-gold);
            color: #000;
            border-left-color: #fff;
            padding-left: 25px;
            transform: scale(1.02);
        }
        
        .district-item.grove { border-left-color: var(--gta-green); }
        .district-item.grove:hover { background: var(--gta-green); color: #fff; border-left-color: #fff; }
        
        .district-item.ballas { border-left-color: #d0a; }
        .district-item.ballas:hover { background: #d0a; color: #fff; border-left-color: #fff; }
        
        .district-item.vagos { border-left-color: #fb0; }
        .district-item.vagos:hover { background: #fb0; color: #000; border-left-color: #fff; }

        .blip-icon:hover {
            transform: scale(1.5) rotate(90deg);
            background-color: #fff;
        }

        /* Fake "Crosshair" Cursor in center */
        .map-cursor {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            border: 2px solid rgba(255,255,255,0.5);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 20;
        }
        .map-cursor::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 4px;
            background: #fff;
            transform: translate(-50%, -50%);
        }

        .map-img-interactive {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: transform 1s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .zone-poly {
            position: absolute;
            border: 2px solid var(--gta-green);
            background: rgba(63, 165, 53, 0.2);
            display: none;
            pointer-events: none;
        }

        
        /* Mission Passed Overlay */
        .mission-passed-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 300;
            pointer-events: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        /* Mission Passed Overlay - Consolidated below */
        
        /* Map & Stats */
        .placeholder-box {
            background: transparent !important;
            padding: 0;
            border: none;
            text-align: center;
            margin-top: 0;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            margin: 10px 0;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }
        
        /* Filters - Grid Layout for Visibility */
        .filters {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            padding-bottom: 5px;
            margin-bottom: 15px;
            width: 100%;
        }
        
        .filter-btn {
            background: rgba(0,0,0,0.9);
            border: 2px solid var(--gta-grey);
            color: #fff;
            padding: 10px 16px;
            font-family: 'GraffitiTwo', 'Impact', sans-serif;
            font-size: 14px;
            white-space: nowrap;
            cursor: pointer;
            flex: 0 0 auto;
            transition: all 0.1s;
            border-radius: 4px;
        }
        
        @media (max-width: 480px) {
            .filter-btn {
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        .filter-btn:active {
            transform: scale(0.95);
        }

        .filter-btn.back-btn {
            border-color: #a00;
            color: #aaa;
        }
        
        .filter-btn.active {
            background: var(--gta-gold);
            color: #000;
            border-color: var(--gta-gold);
        }
        
        .loading {
            text-align: center;
            font-size: 36px;
            color: var(--gta-gold);
            margin-top: 50px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink { 50% { opacity: 0.5; } }

        /* Intro Screen */
        /* Preloader */
        #pre-loader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 200000;
            display: none; /* Default hidden (Fail-Open) */
            align-items: center;
            justify-content: center;
            font-family: 'Impact', sans-serif;
            font-size: 24px;
            color: #444;
            transition: opacity 0.5s;
        }

        /* Map Section Background */
        #map {
            background-image: url('2boys.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        /* Main Menu (High Fidelity GTA SA PC) */
        #intro-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('bosas.jpg');
            background-size: cover;
            background-position: center top;
            background-repeat: no-repeat;
            z-index: 100000;
            display: block; /* Changed from flex to allow absolute pos */
            transition: opacity 1s ease-out;
        }
        
        @media (max-width: 480px) {
            #intro-screen {
                background-position: center 10%;
            }
        }
        
        .vinewood-bg {
            display: block;
            position: absolute;
            top: 0; right: 0;
            width: 60%; height: 50%;
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/a/a8/Vinewood_Sign_GTAV.png/640px-Vinewood_Sign_GTAV.png');
            background-size: contain;
            background-position: top right;
            background-repeat: no-repeat;
            -webkit-mask-image: linear-gradient(225deg, rgba(0,0,0,1) 40%, rgba(0,0,0,0) 80%);
            mask-image: linear-gradient(225deg, rgba(0,0,0,1) 40%, rgba(0,0,0,0) 80%);
            opacity: 0.7;
            pointer-events: none;
        }

        .menu-header {
            font-family: 'MeltdownPhantom', 'Impact', 'Arial Black', sans-serif;
            font-size: 65px;
            font-weight: normal;
            color: #fff;
            text-shadow: 4px 4px 10px #000, 0 0 40px rgba(0, 0, 0, 0.9), 3px 3px 0 #000, -1px -1px 0 #000;
            position: absolute;
            top: 35px; left: 15px;
            margin: 0;
            line-height: 1.2;
            text-align: left;
            background: radial-gradient(ellipse at center, rgba(0, 0, 0, 0.7) 0%, rgba(0, 0, 0, 0.5) 40%, transparent 80%);
            padding: 20px 45px 20px 30px;
            letter-spacing: 2px;
        }
        
        @media (max-width: 480px) {
            .menu-header {
                font-size: 38px;
                top: 20px;
                left: 8px;
                padding: 12px 30px 12px 20px;
                line-height: 1.25;
                letter-spacing: 1px;
            }
        }

        .menu-options {
            position: absolute;
            bottom: 15%; left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        .start-btn {
            font-family: 'Impact', 'Arial Black', sans-serif;
            font-size: 36px;
            color: #ffffff;
            background: radial-gradient(ellipse at center, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.6) 40%, transparent 80%);
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: block;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            transform: scaleX(1.1);
            padding: 20px 50px;
            text-shadow: 3px 3px 8px #000, 0 0 30px rgba(255, 255, 255, 0.5), 2px 2px 0 #000;
            box-shadow: 0 0 40px rgba(255, 255, 255, 0.3);
        }
        
        @media (max-width: 480px) {
            .start-btn {
                font-size: 28px;
                padding: 15px 40px;
            }
        }
        
        .start-btn:hover {
            color: #fff;
            text-shadow: 3px 3px 8px #000, 0 0 40px rgba(255, 255, 255, 0.9), 2px 2px 0 #000;
            transform: scaleX(1.1) scale(1.05);
            box-shadow: 0 0 50px rgba(255, 255, 255, 0.5);
        }
        
        .menu-item-dummy {
            font-family: 'Impact', 'Arial Black', sans-serif;
            font-size: 36px;
            color: #444; /* Dark Grey */
            text-transform: uppercase;
            letter-spacing: 2px;
            transform: scaleX(1.1);
            pointer-events: none;
        }

        /* High-End CSS Fog Wipe */
        .smoke-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100005;
            pointer-events: none;
            display: none;
            overflow: hidden;
        }

        .fog-layer {
            position: absolute;
            top: 0; left: 0;
            width: 200%; height: 100%;
            background: linear-gradient(to right, 
                transparent 0%, 
                rgba(255, 255, 255, 0.2) 20%, 
                rgba(255, 255, 255, 0.9) 45%, 
                #fff 50%, 
                rgba(255, 255, 255, 0.9) 55%, 
                rgba(255, 255, 255, 0.2) 80%, 
                transparent 100%
            );
            transform: translateX(-100%);
            will-change: transform;
        }

        /* Layer variations for depth */
        .fog-layer:nth-child(1) { opacity: 1.0; z-index: 3; }
        .fog-layer:nth-child(2) { opacity: 0.6; height: 120%; top: -10%; left: -10%; z-index: 2; filter: blur(10px); }
        .fog-layer:nth-child(3) { opacity: 0.4; height: 140%; top: -20%; left: -5%; z-index: 1; filter: blur(20px); }

        @keyframes fogWipe {
            0% { transform: translateX(-100%); }
            45% { transform: translateX(-10%); } /* Hold slightly */
            55% { transform: translateX(10%); }
            100% { transform: translateX(100%); }
        }

        .smoke-active .fog-layer {
            animation: fogWipe 2.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        .smoke-active .fog-layer:nth-child(2) { animation-duration: 2.6s; }
        .smoke-active .fog-layer:nth-child(3) { animation-duration: 2.7s; }

        /* Video Bars */
        .cinematic-bar {
            position: fixed;
            left: 0;
            width: 100%;
            height: 12vh; /* 12% height */
            background: #000;
            z-index: 100002; /* Above video */
            transition: transform 0.5s ease-out;
            pointer-events: none;
        }
        .bar-top { top: 0; transform: translateY(-100%); }
        .bar-bottom { bottom: 0; transform: translateY(100%); }
        
        .video-mode .bar-top { transform: translateY(0); }
        .video-mode .bar-bottom { transform: translateY(0); }
        
        #video-intro {
            background: #000; /* Ensure black background behind video */
        }

        /* Full Screen Modals */
        .modal-3d {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 99999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* Terminal Style */
        .terminal-box {
            border: 2px solid var(--gta-green);
            padding: 20px;
            background: rgba(0, 20, 0, 0.95);
            width: 90%;
            max-width: 400px;
            font-family: 'Courier New', monospace;
            box-shadow: 0 0 20px rgba(63, 165, 53, 0.2);
            text-align: center;
        }
        
        .stat-bar-container {
            background: #333;
            height: 15px;
            width: 150px;
            border: 2px solid #000;
            margin-left: auto;
        }
        .stat-bar-fill {
            height: 100%;
            background: var(--gta-green);
        }

        /* Character Overlay - OPTIMIZED */
        .char-overlay {
            position: fixed;
            bottom: 0; 
            right: 0; 
            width: 350px;
            height: 500px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: bottom right;
            z-index: 9000;
            transform: translateX(100%); 
            transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1);
            pointer-events: none;
            /* Removed expensive filter: drop-shadow */
        }
        
        .char-visible {
            transform: translateX(0); 
        }
        
        .char-bubble {
            position: absolute;
            bottom: 300px; 
            right: 50px; 
            width: auto;
            background: transparent;
            border: none;
            color: var(--gta-gold);
            padding: 0;
            font-family: 'Pricedown', 'Bungee', 'Impact', sans-serif;
            font-size: 48px;
            line-height: 0.9;
            text-shadow: 3px 3px 0 #000; /* Keep hard shadow, cheap */
            -webkit-text-stroke: 1px #000;
            opacity: 0;
            transform: scale(0.5) rotate(-5deg);
            transition: opacity 0.4s, transform 0.4s; /* Removed complex bezier for performance */
            pointer-events: auto;
            text-align: right;
        }
        
        .char-visible .char-bubble {
            opacity: 1;
            transform: scale(1) rotate(0deg);
            transition-delay: 0.3s;
        }

        /* Cinematic Video Frame - OPTIMIZED */
        .video-frame-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 3;
            pointer-events: none;
            /* Replaced box-shadow with cheaper gradient */
            background: radial-gradient(circle, transparent 50%, rgba(0,0,0,0.9) 100%);
        }

        /* Animations */
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.8) translateY(20px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        .product-card {
            /* ... existing styles ... */
            animation: popIn 0.6s cubic-bezier(0.22, 1, 0.36, 1) backwards;
        }

        /* Wasted Overlay */
        .wasted-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 100001; /* Above everything */
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: grayscale(100%) contrast(1.2) blur(2px);
            animation: wastedFade 2s ease-out;
        }
        @keyframes wastedFade { from { opacity: 0; } to { opacity: 1; } }
        
        .wasted-text {
            font-family: 'Pricedown', 'Bungee', 'Impact', sans-serif;
            font-size: 80px;
            color: #fff; /* GTA Wasted is usually white/grey with black outline, rarely red in older ones */
            text-shadow: 4px 4px 0 #000;
            background: rgba(0,0,0,0.7);
            padding: 10px 40px;
            border-radius: 10px;
            transform: scale(0);
            animation: wastedPop 0.5s 0.5s forwards cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes wastedPop { to { transform: scale(1); } }

        /* Graffiti Tags */
        .graffiti {
            position: absolute;
            width: 60px;
            height: 40px;
            opacity: 0.4;
            cursor: pointer;
            transition: 0.3s;
            z-index: 5;
            filter: brightness(0.5) sepia(1);
        }
        .graffiti:hover { transform: scale(1.1); opacity: 0.8; }
        .graffiti.found {
            opacity: 1;
            filter: brightness(1) sepia(0) hue-rotate(90deg); /* Greenish */
            pointer-events: none;
        }

        /* 3D Tilt Context */
        .product-grid {
            perspective: 1000px;
        }
        .product-card {
            transform-style: preserve-3d;
            /* existing styles... */
        }

        /* --- GTA SA SATELLITE MAP THEME (OVERRIDE) --- */
        .map-container {
            position: relative;
            height: 450px;
            background-color: transparent !important;
            overflow: hidden;
            border: 4px solid #000;
            font-family: 'Courier New', monospace;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        .map-grid {
            display: none;
            animation: gridPan 20s linear infinite;
            pointer-events: none;
            z-index: 1;
        }

        @keyframes gridPan {
            0% { transform: perspective(500px) rotateX(20deg) translateY(0); }
            100% { transform: perspective(500px) rotateX(20deg) translateY(40px); }
        }

        .scanline-bar {
            display: none !important;
        }

        @keyframes scanlineMove {
            0% { top: -10%; }
            100% { top: 110%; }
        }

        .noise-overlay {
            display: none !important;
        }

        .map-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .map-layer.outline path {
            stroke: #000;
            stroke-width: 60px;
            fill: none;
            stroke-linejoin: round;
        }
        
        .map-layer.dark path {
            fill: #2a3a2a; 
            transform: translate(8px, 8px);
        }

        .map-layer.mid path {
            fill: #3a4e3a;
            transform: translate(4px, 4px);
        }

        .map-layer.main path {
            fill: #5c7a5c; 
            stroke: #1a2a1a;
            stroke-width: 2px;
        }

        .radar-beam {
            position: absolute;
            top: 50%; left: 50%;
            width: 60%; height: 60%;
            background: conic-gradient(from 0deg, transparent 300deg, rgba(0, 255, 0, 0.2) 360deg);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: radarRotate 4s linear infinite;
            pointer-events: none;
            z-index: 5;
        }
        
        @keyframes radarRotate {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .gta-marker {
            position: absolute;
            display: flex;
            align-items: center;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 30;
            transition: transform 0.2s;
        }

        .gta-marker:hover {
            transform: translate(-50%, -50%) scale(1.1);
            z-index: 35;
        }

        .marker-icon {
            width: 6px; 
            height: 6px;
            background: #D30000; /* Red dot */
            border: 1px solid rgba(255, 255, 255, 0.8); /* Subtle white border */
            border-radius: 50%; /* Circle */
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 6px;
            box-shadow: 0 0 8px rgba(211, 0, 0, 0.7); /* Red glow */
            position: relative;
            animation: pulseGlow 2s infinite ease-in-out;
        }
        
        .marker-icon svg {
            width: 24px; height: 24px;
            fill: #000;
        }

        .marker-label {
            font-family: 'MeltdownPhantom', 'Impact', 'Arial Black', sans-serif;
            color: #fff;
            font-size: 11px; /* Smaller text to match smaller dot */
            font-weight: bold;
            text-shadow: 1px 1px 2px #000, -1px -1px 1px #000;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }

        /* Mobile optimization for map markers */
        @media (max-width: 480px) {
            .marker-icon {
                width: 5px;
                height: 5px;
                margin-right: 4px;
            }
            
            .marker-label {
                font-size: 9px;
                letter-spacing: 0.2px;
            }
        }

        .blip-pulse {
            display: none;
        }
        
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(4); opacity: 0; }
        }

        .data-feed {
            background: #000;
            border-top: 2px solid #333;
            color: var(--gta-green);
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 8px 10px;
            white-space: nowrap;
            overflow: hidden;
            position: relative;
            text-transform: uppercase;
        }
        
        .data-scroll {
            display: inline-block;
            animation: marquee 20s linear infinite;
        }
        
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        
        .district-menu-slide {
            position: absolute;
            top: 20px; right: -250px; 
            width: 220px;
            background: rgba(0,0,0,0.95);
            border: 3px solid var(--gta-green);
            padding: 0;
            transition: right 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 50;
            box-shadow: -10px 10px 20px rgba(0,0,0,0.8);
            display: block !important; 
        }
        
        .district-menu-slide.active {
            right: 20px;
        }
        
        .dm-header {
            background: var(--gta-green);
            color: #000;
            font-family: 'Pricedown', 'Bungee', 'Impact', sans-serif;
            font-size: 28px;
            padding: 10px;
            text-align: center;
            border-bottom: 2px solid #000;
        }
        
        .dm-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .dm-item {
            padding: 12px 15px;
            color: var(--gta-green);
            font-family: 'Impact', sans-serif;
            font-size: 18px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            text-transform: uppercase;
            transition: 0.2s;
            display: flex;
            justify-content: space-between;
        }
        
        .dm-item:hover {
            background: var(--gta-green);
            color: #000;
            padding-left: 20px;
        }
        
        .dm-close {
            width: 100%;
            background: #333;
            color: #fff;
            border: none;
            padding: 10px;
            font-family: 'Impact', sans-serif;
            cursor: pointer;
            text-transform: uppercase;
        }
        .dm-close:hover { background: #555; }
        /* --- CLEAN MAP CONTAINER --- */
        .map-container {
            position: relative;
            height: 550px;
            background-color: transparent !important; 
            overflow: hidden;
            border: none !important;
            border-radius: 0;
            box-shadow: none !important;
        }
        
        .satellite-view {
            background-color: transparent;
            background-image: none;
            position: relative;
            backdrop-filter: none;
            
            /* FLAT & CLEAN */
            transform: none;
            transform-origin: center center;
            transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            will-change: transform; /* GPU Acceleration */
            border: none;
            border-radius: 0;
            box-shadow: 0 0 20px rgba(211, 0, 0, 0.15);
            overflow: hidden;
            margin: 15px;
        }
        
        @media (max-width: 480px) {
            .satellite-view {
                margin: 10px;
                border-width: 1px;
                border-radius: 8px;
            }
        }
        
        /* Zooming removes tilt for clarity */
        .satellite-view.zoomed {
            transform: scale(1.5);
        }
        
        .satellite-view.zoomed .map-img-interactive g {
            stroke-width: 8px;
        }
        
        /* Scanline Effect */
        .satellite-view::before {
            display: none;
        }
        
        @keyframes scanDown {
            0% { top: -10%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 110%; opacity: 0; }
        }

        /* Map Outline (Digital) */
        .map-layer path {
            stroke: #004400; 
            stroke-width: 1px;
            fill: #000800; 
            vector-effect: non-scaling-stroke;
        }

        /* --- SIGNAL EMITTERS (CITIES) --- */
        /* Hide new city pins - use GTA markers instead */
        .city-pin {
            display: none !important;
        }
        
        .pin-core {
            display: none !important;
        }
        
        .pin-pulse {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 100%; height: 100%;
            border: 2px solid rgba(0, 255, 0, 0.5);
            border-radius: 50%;
            animation: pulseRipple 2s infinite;
            box-sizing: border-box;
        }
        
        .pin-pulse::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 100%; height: 100%;
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 50%;
            animation: pulseRipple 2s infinite 0.6s;
            box-sizing: border-box;
        }
        
        @keyframes pulseRipple {
            0% { width: 10%; height: 10%; opacity: 1; border-width: 4px; }
            100% { width: 100%; height: 100%; opacity: 0; border-width: 0px; }
        }
        
        /* Hide new city labels - use GTA marker labels instead */
        .city-label {
            display: none !important;
        }
        
        /* Hover State */
        /* City pin hover styles removed - using GTA markers */
        
        .scanner-text {
            display: none;
            position: absolute;
            top: 20px; left: 20px;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: bold;
            background: rgba(0,0,0,0.8);
            padding: 8px 15px;
            border: 2px solid rgba(255, 0, 0, 0.6);
            border-radius: 4px;
            animation: blinkText 2s infinite;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.7);
            z-index: 10;
            pointer-events: none;
        }
        
        @media (max-width: 480px) {
            .scanner-text {
                font-size: 12px;
                padding: 6px 12px;
            }
        }
        @keyframes blinkText { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Clean Slide-in Menu */
        .district-menu-slide {
            background: rgba(0,0,0,0.95) !important;
            border-left: 4px solid #f0c330 !important;
            box-shadow: -10px 0 30px rgba(0,0,0,0.8) !important;
        }
        
        .dm-header {
            background: #f0c330 !important;
            color: #000 !important;
            border-bottom: 4px solid #000 !important;
            font-size: 32px !important;
        }
        
        .dm-item {
            background: #222 !important;
            color: #fff !important;
            border: 2px solid #444 !important;
            font-family: 'Impact', sans-serif !important;
        }
        
        .dm-item:hover {
            background: #f0c330 !important;
            color: #000 !important;
            border-color: #fff !important;
        }
        /* Ensure single-layer SVG fallback looks perfect */
        .map-img-interactive g path {
            fill: rgba(20, 20, 20, 0.15) !important; /* Dimmer, more transparent fill */
            stroke: rgba(211, 0, 0, 0.9) !important;
            stroke-width: 6px !important;
            stroke-linejoin: round !important;
            stroke-linecap: round !important;
            vector-effect: non-scaling-stroke;
        }
        
        /* Hide any previous broken layers if they exist */
        .map-layer { display: contents; } 
        /* --- GTA V SATELLITE NIGHT MODE --- */
        .satellite-view {
            width: 100%; height: 100%;
            background: transparent !important;
            position: relative;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
        }

        /* Background Effects */
        .sat-bg {
            display: none;
        }

        .sat-grid {
            display: none;
            transform: perspective(1000px) rotateX(20deg);
            pointer-events: none;
        }

        .sat-vignette {
            display: none !important;
        }

        /* Zoom Layer */
        .map-zoom-layer {
            width: 100%; height: 100%;
            transition: transform 1.2s var(--spring-smooth);
            transform-origin: center center;
        }

        /* Map SVG Styling */
        .map-img-interactive {
            width: 100%; height: 100%;
            filter: drop-shadow(0 0 15px rgba(0,0,0,0.8));
        }
        
        .map-img-interactive g path {
            fill: rgba(20, 20, 20, 0.15) !important; /* Dimmer, more transparent fill */
            stroke: rgba(211, 0, 0, 0.9) !important;
            stroke-width: 6px !important;
            stroke-linejoin: round !important;
            stroke-linecap: round !important;
            vector-effect: non-scaling-stroke;
        }

        /* Blips */
        .sat-blip {
            position: absolute;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 20;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: opacity 0.5s;
        }

        .satellite-view.zoomed .sat-blip { opacity: 0; pointer-events: none; }

        .blip-dot {
            width: 12px; height: 12px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px #fff;
        }

        .blip-ring {
            position: absolute; top: 50%; left: 50%;
            width: 40px; height: 40px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: blipPulse 2s infinite;
        }

        @keyframes blipPulse { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; } }

        .blip-label {
            margin-top: 8px;
            color: #fff;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 0 0 5px #000;
            opacity: 0.7;
            transition: 0.3s;
        }

        .sat-blip:hover .blip-label { opacity: 1; text-shadow: 0 0 10px #fff; }

        /* HUD */
        /* Hide sat-hud and coords */
        .sat-hud {
            display: none !important;
        }
        
        .hud-coords {
            display: none !important;
            padding: 6px 10px;
            border-radius: 3px;
            border: 1px solid rgba(255, 0, 0, 0.5);
        }

        .hud-reset {
            background: rgba(0, 20, 0, 0.8);
            border: 1px solid #2ecc71;
            color: #2ecc71;
            padding: 8px 12px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            pointer-events: auto;
            text-transform: uppercase;
            transition: all 0.2s ease;
            letter-spacing: 1px;
            opacity: 1; /* Always visible for utility */
            box-shadow: 0 0 10px rgba(46, 204, 113, 0.2);
            text-shadow: 0 0 5px rgba(46, 204, 113, 0.5);
        }
        
        .hud-reset:hover {
            background: #2ecc71;
            color: #000;
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.6);
            text-shadow: none;
        }
        
        .satellite-view.zoomed .hud-reset { opacity: 1; pointer-events: auto; }
        
        /* Professional Panel Close Button */
        .panel-close-btn {
            position: absolute; 
            top: 12px; 
            right: 12px; 
            background: rgba(200, 0, 0, 0.2); 
            border: 1px solid #ff4444; 
            color: #ff4444; 
            width: 28px; 
            height: 28px; 
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-family: 'Arial', sans-serif;
            font-weight: bold;
            transition: all 0.2s;
            z-index: 10;
        }
        
        .panel-close-btn:hover {
            background: #ff4444;
            color: #fff;
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.6);
            transform: rotate(90deg);
        }

        /* --- CLOUD LAYERS & GLITCH --- */
        .sat-clouds {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 12;
            pointer-events: none;
            opacity: 0;
            display: none;
        }
        
        .sat-clouds.layer2 {
            display: none;
        }

        @keyframes drift { from { background-position: 0 0; } to { background-position: 100% 0; } }

        /* Glitch Effect on SVG when zooming */
        .satellite-view.glitching .map-img-interactive {
            animation: rgbSplit 0.4s steps(5);
        }
        
        @keyframes rgbSplit {
            0% { transform: translate(0); }
            25% { transform: translate(-3px, 3px); filter: drop-shadow(-3px 0 0 rgba(255,0,0,0.7)) drop-shadow(3px 0 0 rgba(0,0,255,0.7)); }
            50% { transform: translate(3px, -3px); filter: drop-shadow(3px 0 0 rgba(255,0,0,0.7)) drop-shadow(-3px 0 0 rgba(0,0,255,0.7)); }
            75% { transform: translate(-2px, 0); }
            100% { transform: translate(0); }
        }



        /* District Panel (Reuse existing, ensure it looks good) */
        .district-panel {
            background: #0a0a0a !important;
            border-left: 2px solid #fff !important;
        }
        
        .dm-item {
            font-family: 'Courier New', monospace !important;
            border: 1px solid #333 !important;
            margin-bottom: 5px !important;
            background: #111 !important;
        }
        .dm-item:hover {
            background: #fff !important;
            color: #000 !important;
        }
        /* --- DISTRICT POLYGON SYSTEM --- */
        .district-polygons {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s ease 0.3s;
            z-index: 15;
        }
        
        .satellite-view.zoomed .district-polygons {
            opacity: 1;
            pointer-events: auto;
        }
        
        .district-polygons svg {
            width: 100%; height: 100%;
        }
        
        .district-poly {
            fill: #1a1a1a;
            stroke: #333;
            stroke-width: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0;
            transform-origin: center;
        }
        
        .satellite-view.zoomed .district-poly {
            opacity: 1;
        }
        
        /* Stock Status Colors */
        .district-poly.has-stock {
            fill: rgba(46, 125, 50, 0.6); /* Green */
            stroke: #4caf50;
            stroke-width: 3px;
        }
        
        .district-poly.no-stock {
            fill: rgba(50, 50, 50, 0.6); /* Grey */
            stroke: #555;
        }
        
        .district-poly.hot-zone {
            fill: rgba(255, 193, 7, 0.5); /* Gold - Featured */
            stroke: #ffc107;
            stroke-width: 3px;
            animation: hotPulse 2s infinite;
        }
        
        @keyframes hotPulse {
            0%, 100% { fill: rgba(255, 193, 7, 0.4); }
            50% { fill: rgba(255, 193, 7, 0.7); }
        }
        
        .district-poly:hover {
            fill: rgba(255, 255, 255, 0.3) !important;
            stroke: #fff !important;
            stroke-width: 4px !important;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.5));
        }
        
        /* District Label */
        .district-label {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #fff;
            padding: 8px 12px;
            color: #fff;
            font-family: 'Impact', sans-serif;
            font-size: 14px;
            text-transform: uppercase;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 100;
            white-space: nowrap;
            transform: translate(-50%, -100%);
            margin-top: -10px;
        }
        
        .district-label.visible {
            opacity: 1;
        }
        
        .district-label .stock-count {
            display: block;
            font-size: 11px;
            color: #4caf50;
            margin-top: 2px;
        }
        
        .district-label .stock-count.empty {
            color: #666;
        }
        
        /* City District Containers */
        .city-districts {
            display: none;
        }
        
        .city-districts.active {
            display: block;
        }

        /* --- BURNER PHONE UI (UPGRADED - APPLE GLASS) --- */
        .phone-container {
            position: fixed;
            bottom: -120%; left: 50%;
            transform: translateX(-50%);
            width: 320px;
            height: 640px;
            max-height: 90vh;
            
            /* GLASSMOPHISM */
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            
            border-radius: 36px 36px 0 0;
            
            /* Refined Borders */
            
            /* SMOOTH SLIDE ANIMATION */
            transition: bottom 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 10000;
            border: 1px solid rgba(255,255,255,0.08);
            border-bottom: none;
            
            box-shadow: 
                0 -30px 80px rgba(0,0,0,0.9),
                inset 0 1px 0 rgba(255,255,255,0.15);
                
            z-index: 20000;
            transition: bottom 0.7s var(--spring-bounce);
            
            display: flex;
            flex-direction: column;
            padding: 20px;
            padding-top: 40px; 
            box-sizing: border-box;
        }
        
        .phone-container::before {
            /* Antenna Stub */
            content: '';
            position: absolute;
            top: -30px; right: 20px;
            width: 25px; height: 40px;
            background: #111;
            border-radius: 5px 5px 0 0;
            border: 4px solid #222;
            border-bottom: none;
            z-index: -1;
        }
        
        .phone-speaker {
            position: absolute;
            top: 15px; left: 50%;
            transform: translateX(-50%);
            width: 60px; height: 8px;
            background: repeating-linear-gradient(90deg, #000, #000 2px, #444 2px, #444 3px);
            border-radius: 4px;
            border: 1px solid #000;
        }
        
        .phone-container.active {
            bottom: 0;
        }

        
        .phone-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .phone-screen {
            background: #8b9616; /* Richer LCD Green */
            border: 8px solid #000;
            border-radius: 6px;
            height: 240px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            color: #111;
            display: flex;
            flex-direction: column;
            box-shadow: 
                inset 0 0 20px rgba(0,0,0,0.6),
                0 0 0 2px #333; /* Plastic rim */
            position: relative;
            overflow: hidden;
        }
        
        /* Screen Backlight Flicker & Scanlines */
        .phone-screen::after {
            content: '';
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: 
                repeating-linear-gradient(0deg, rgba(0,0,0,0.08), rgba(0,0,0,0.08) 1px, transparent 1px, transparent 2px),
                radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 80%);
            pointer-events: none;
            animation: screenFlicker 4s infinite;
        }
        
        @keyframes screenFlicker {
            0% { opacity: 0.9; }
            95% { opacity: 0.9; }
            96% { opacity: 0.8; }
            97% { opacity: 0.95; }
            98% { opacity: 0.85; }
            100% { opacity: 0.9; }
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            font-weight: bold;
            border-bottom: 2px solid #111;
            padding-bottom: 4px;
            margin-bottom: 8px;
            opacity: 0.8;
        }
        
        .screen-header {
            background: #111;
            color: #8b9616;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
            padding: 2px 0;
            text-transform: uppercase;
        }
        
        .contact-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 4px;
            scrollbar-width: none;
        }
        
        .contact-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: bold;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            
            transition: transform 0.1s var(--spring-smooth), background 0.2s;
            animation: slideInStagger 0.4s var(--spring-bounce) backwards;
        }
        
        .contact-item:active {
             transform: scale(0.96);
        }
        
        .contact-item:hover, .contact-item.selected {
            background: rgba(17, 17, 17, 0.1);
        }
        
        .contact-item .signal {
            font-family: monospace;
            font-weight: normal;
        }
        
        .dialing-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            display: none; /* Hidden by default */
        }
        
        .dialing-screen.active {
            display: flex;
        }
        
        .dial-text {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            animation: blink 1s infinite;
        }
        
        .dial-number {
            font-size: 24px;
            letter-spacing: 2px;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        
        .phone-keypad {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .key-row {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        
        .key-btn {
            flex: 1;
            background: linear-gradient(to bottom, #ddd, #bbb);
            color: #000;
            padding: 12px 0;
            text-align: center;
            border-radius: 8px;
            font-weight: bold;
            font-family: sans-serif;
            cursor: pointer;
            border-bottom: 4px solid #888;
            box-shadow: 0 4px 5px rgba(0,0,0,0.3);
            font-size: 14px;
            transition: transform 0.05s;
        }
        
        .key-btn.call {
            background: linear-gradient(to bottom, #66bb6a, #43a047);
            color: #fff;
            border-bottom-color: #2e7d32;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        .key-btn.end {
            background: linear-gradient(to bottom, #ef5350, #e53935);
            color: #fff;
            border-bottom-color: #b71c1c;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        .key-btn:active {
            transform: translateY(4px);
            border-bottom-width: 0px;
            box-shadow: none;
        }
        
        .key-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .num-key {
            background: linear-gradient(to bottom, #333, #222);
            color: #fff;
            text-align: center;
            padding: 10px 0;
            border-radius: 6px;
            font-family: sans-serif;
            font-weight: bold;
            border-bottom: 3px solid #000;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .num-key:active {
            transform: translateY(3px);
            border-bottom-width: 0px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }

        /* --- CINEMATIC HANDOFF THEME --- */
        .character-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); /* Dim background */
            z-index: 25000;
            display: none; /* Hidden by default */
            pointer-events: none;
        }
        
        .character-overlay.active {
            display: block;
            pointer-events: auto;
        }
        
        /* Character Cutout */
        .char-body {
            position: absolute;
            bottom: -100%; 
            left: 50%; 
            transform: translateX(-50%);
            
            /* Image Sizing */
            width: auto;
            height: 85vh;
            max-height: 600px;
            max-width: 90vw;
            
            object-fit: contain;
            object-position: bottom center;
            
            transition: bottom 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1;
            filter: drop-shadow(0 10px 30px rgba(0,0,0,0.8));
            pointer-events: none;
        }
        
        .character-overlay.active .char-body {
            bottom: 0; /* Slide up to bottom */
            animation: characterBounce 0.5s ease-out 0.8s; /* Bounce after slide */
        }
        
        @keyframes characterBounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-20px); }
        }
        
        /* Dialogue Box (Comic Style) */
        .char-dialogue-box {
            position: absolute;
            top: 15%; 
            left: 50%;
            transform: translateX(-50%) scale(0.8);
            width: 85%;
            max-width: 350px;
            background: #fff;
            border: 4px solid #000;
            padding: 15px 20px;
            font-family: 'Impact', sans-serif;
            font-size: 18px;
            color: #000;
            border-radius: 5px;
            opacity: 0;
            transition: all 0.5s 0.6s; /* Delay after character appears */
            z-index: 3;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.6);
        }
        
        .char-dialogue-box::after {
            content: '';
            position: absolute;
            bottom: -18px; 
            left: 50%;
            transform: translateX(-50%);
            border-width: 18px 18px 0;
            border-style: solid;
            border-color: #000 transparent transparent;
            display: block;
            width: 0;
        }
        
        .char-dialogue-box::before {
            content: '';
            position: absolute;
            bottom: -14px; 
            left: 50%;
            transform: translateX(-50%);
            border-width: 14px 14px 0;
            border-style: solid;
            border-color: #fff transparent transparent;
            display: block;
            width: 0;
            z-index: 1;
        }
        
        .character-overlay.active .char-dialogue-box {
            opacity: 1;
            transform: translateX(-50%) scale(1);
        }
        
        .char-name {
            color: var(--gta-green);
            font-size: 13px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .char-dialogue {
            line-height: 1.3;
        }

        /* Hide old digital avatar elements */
        .avatar-frame, .avatar-name { display: none !important; }
        /* --- NEW POLISH --- */
        .touch-ripple {
            position: absolute;
            width: 20px; height: 20px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: rippleExpand 0.6s ease-out;
            pointer-events: none;
            z-index: 50;
        }
        @keyframes rippleExpand {
            to { width: 200px; height: 200px; opacity: 0; }
        }
        
        /* Film Grain */
        .satellite-view::after {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Force Refresh Button removed for production -->
    
    <!-- Version Indicator removed for production -->
    
    <!-- Wasted Overlay -->
    <div id="wasted-overlay" class="wasted-overlay" onclick="closeWasted()">
        <div class="wasted-text">WASTED</div>
    </div>
    

    <div id="pre-loader">LOADING SYSTEM...</div>
    <script>
        // Progressive Enhancement: Only show loader if JS is working
        var pl = document.getElementById('pre-loader');
        pl.style.display = 'flex';
        
        // CRITICAL FAILSAFE: Force hide after 3s even if main JS crashes
        setTimeout(function(){
            pl.style.display = 'none';
        }, 3000);
    </script>

    <!-- Cinematic Bars -->
    <div class="cinematic-bar bar-top"></div>
    <div class="cinematic-bar bar-bottom"></div>

    <!-- Fog Wipe Transition -->
    <div id="smoke-overlay" class="smoke-container">
        <div class="fog-layer"></div>
        <div class="fog-layer"></div>
        <div class="fog-layer"></div>
    </div>

    <!-- Intro Screen (Main Menu) -->
    <div id="intro-screen">
        <div class="vinewood-bg"></div>
        <div class="menu-header">BIG<br>COMPANY<br>BOT</div>
        
        <div class="menu-options">
            <button class="start-btn" onclick="startApp()">GO TO SHOP</button>
        </div>
    </div>


    <!-- Character Layer -->
    <div id="char-layer" class="char-overlay">
        <div id="char-text" class="char-bubble">WELCOME!</div>
    </div>

    <!-- Audio Elements -->
    <!-- Radio Toggle Button -->
    <div class="radio-pill" onclick="toggleRadio()">
        <div class="radio-visualizer" id="radio-viz">
            <div class="viz-bar b1"></div>
            <div class="viz-bar b2"></div>
            <div class="viz-bar b3"></div>
            <div class="viz-bar b4"></div>
        </div>
        <span class="radio-text-scroll" id="radio-display">â™« BIG POPPA</span>
    </div>

    <div class="bg"></div>
    <div class="scanlines"></div>


    <!-- Mission Passed Overlay -->
    <div class="mission-passed-overlay" id="mp-overlay" style="display:none;">
        <div class="mp-text">MISSION PASSED!</div>
        <div class="mp-sub">RESPECT +</div>
        <div class="mp-instruction">Check bot chat for product details</div>
    </div>
    <audio id="mp-sound" src="https://ia800501.us.archive.org/33/items/GTASAMissionPassed/GTA%20SA%20Mission%20Passed.mp3" preload="auto"></audio>


    <!-- CART - Shop Style -->
    <div id="basket-modal" class="cart-modal" style="display:none;">
        <div class="cart-backdrop" onclick="closeBasket()"></div>
        
        <div class="cart-container">
            <!-- Header Bar -->
            <div class="cart-header-bar">
                <div class="cart-header-title">
                    <span class="cart-header-icon">ðŸ›’</span>
                    <span>YOUR CART</span>
                </div>
                <div class="cart-header-count" id="inv-count">0 ITEMS</div>
                <button class="cart-header-close" onclick="closeBasket()">âœ•</button>
            </div>
            
            <!-- Items Grid -->
            <div class="cart-content">
                <div id="basket-items" class="cart-grid">
                    <!-- Items rendered here as product cards -->
                </div>
                
                <!-- Empty State -->
                <div class="cart-empty" id="cart-empty-state">
                    <div class="empty-icon">ðŸ›’</div>
                    <div class="empty-text">CART EMPTY</div>
                    <div class="empty-sub">ADD ITEMS FROM THE SHOP</div>
                </div>
            </div>
            
            <!-- Footer / Checkout Section -->
            <div class="cart-checkout-section">
                
                <!-- Integrated Checkout Module -->
                <div class="checkout-module">
                    
                    <!-- 1. Promo Field -->
                    <div class="promo-field-group">
                        <input type="text" id="discount-input" placeholder="ENTER PROMO CODE" class="modern-input">
                        <button onclick="applyDiscount()" class="modern-apply-btn">APPLY</button>
                    </div>
                    <div id="discount-msg" class="cart-promo-msg"></div>

                    <!-- 2. Totals Row -->
                    <div class="modern-totals">
                        <div class="mt-left">
                            <div class="mt-label">WALLET</div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="mt-value-sm">â‚¬0.00</div>
                                <button class="refill-btn-small" onclick="openRefill()">+ REFILL</button>
                            </div>
                        </div>
                        <div class="mt-right">
                            <div class="mt-label">TOTAL</div>
                            <div class="mt-value-lg" id="basket-total">â‚¬0.00</div>
                        </div>
                    </div>

                </div>
                
                <!-- Checkout Button -->
                <button class="btn-buy cart-checkout-btn" onclick="initCheckout()">
                    CHECKOUT
                </button>
                
                <div class="cart-secure-text">ðŸ”’ SECURE â€¢ SOLANA NETWORK</div>
            </div>
            
            <!-- Bottom Navigation (Unified Shop Style) -->
            <div class="bottom-nav">
                <div class="nav-item" onclick="closeBasket(); sfx.select(); showSection('shop')">
                    <div class="nav-icon"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-2 .89-2 2v11c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zM10 4h4v2h-4V4zm10 13H4V8h16v9z"/></svg></div>
                    <span>SHOP</span>
                </div>
                <div class="nav-item" onclick="closeBasket(); sfx.select(); showSection('map')">
                    <div class="nav-icon"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg></div>
                    <span>MAP</span>
                </div>
                <div class="nav-item active">
                    <div class="nav-icon"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M19 6h-2c0-2.76-2.24-5-5-5S7 3.24 7 6H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-7-3c1.66 0 3 1.34 3 3H9c0-1.66 1.34-3 3-3zm7 15H5V8h14v10z"/></svg></div>
                    <span>CART <span id="cart-nav-count" style="color:var(--gta-gold)">(0)</span></span>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CART STYLES - Shop Menu Style (GTA San Andreas)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        /* Cart Item - NEW DESIGN (High Visibility) */
        .cart-item-modern {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #333; /* Bright solid background */
            border: 2px solid #555;
            border-radius: 12px;
            padding: 12px 15px;
            margin-bottom: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            position: relative;
        }

        .cart-item-modern:hover {
            border-color: var(--gta-green);
            background: #3a3a3a;
        }

        /* Left Side: Icon + Info */
        .cim-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            min-width: 0; /* Fix flex overflow */
        }

        .cim-icon-box {
            width: 50px;
            height: 50px;
            background: rgba(63, 165, 53, 0.2);
            border: 1px solid var(--gta-green);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            flex-shrink: 0;
        }

        .cim-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
        }

        .cim-name {
            font-family: 'Segoe UI', sans-serif;
            font-weight: 800;
            font-size: 17px;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }

        .cim-details {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #ccc;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Right Side: Price + Remove */
        .cim-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            margin-left: 15px;
        }

        .cim-price {
            font-family: 'Pricedown', 'Bungee', 'Impact', sans-serif;
            font-size: 22px;
            color: var(--gta-green);
            text-shadow: 1px 1px 0 #000;
        }

        .cim-remove-btn {
            background: #600; /* Dark Red */
            color: #fff;
            border: 1px solid #900;
            border-radius: 6px;
            padding: 4px 10px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .cim-remove-btn:hover {
            background: #f00; /* Bright Red */
            border-color: #f55;
            box-shadow: 0 0 10px rgba(255,0,0,0.5);
        }

        .cart-item-modern.removing {
            transform: translateX(100%);
            opacity: 0;
            height: 0;
            margin: 0;
            padding: 0;
            border: none;
            transition: all 0.3s ease;
        }

        .cim-price {
            font-family: 'Pricedown', 'Bungee', 'Impact', sans-serif;
            font-size: 18px;
            color: var(--gta-green);
            letter-spacing: 0.5px;
            text-shadow: 0 0 10px rgba(46, 204, 113, 0.2);
        }

        .cim-delete {
            background: transparent;
            border: 1px solid transparent;
            color: #555;
            padding: 4px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cim-delete:hover {
            background: rgba(255, 50, 50, 0.15);
            color: #ff4444;
            transform: rotate(90deg);
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .cart-modal {
            position: fixed;
            inset: 0;
            z-index: 30000; /* Increased from 2000 to be above everything */
            display: flex;
            align-items: flex-end; /* Align to bottom for slide-up effect */
            justify-content: center;
        }
        
        .cart-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.95); /* Increased opacity for better visibility */
            animation: fadeIn 0.2s ease;
            z-index: 1; /* Behind the content */
        }

        /* New Refill Modal Design */
        .refill-box {
            width: 90%;
            max-width: 340px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 20px;
            position: relative;
            z-index: 30002;
            box-shadow: 0 20px 60px rgba(0,0,0,0.9);
            overflow: hidden;
            animation: slideUpSheet 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .refill-options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 5px;
        }
        
        .refill-custom-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .refill-input {
            width: 100%;
            background: #000;
            border: 1px solid #333;
            color: #fff;
            padding: 16px 40px 16px 16px;
            font-size: 28px;
            font-family: 'Courier New', monospace;
            border-radius: 12px;
            box-sizing: border-box;
            text-align: center;
            transition: border-color 0.2s;
        }
        
        .refill-input:focus {
            border-color: var(--gta-green);
            outline: none;
        }
        
        .currency-symbol {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gta-green);
            font-size: 24px;
            pointer-events: none;
        }
        
        .refill-submit-btn {
            width: 100%;
            background: var(--gta-green);
            color: #000;
            border: none;
            padding: 16px;
            font-size: 16px;
            font-weight: 800;
            border-radius: 12px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 0 15px rgba(63, 165, 53, 0.3);
            transition: all 0.2s;
        }
        
        .refill-submit-btn:active {
            transform: scale(0.96);
        }
        
        /* CONFLICTING STYLE REMOVED - SEE TOP OF FILE FOR ACTUAL CART STYLES */
        /* .cart-container { ... } REMOVED */
        
        /* REMOVED DUPLICATE HEADER STYLES TO FIX LAYOUT */
        
        /* Content Area - BRIGHT */
        .cart-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px 20px;
            min-height: 200px;
            max-height: 60vh;
            background: #222; /* BRIGHT background - matches container */
        }
        
        .cart-content::-webkit-scrollbar { width: 6px; }
        .cart-content::-webkit-scrollbar-thumb { background: var(--gta-green); }
        .cart-content::-webkit-scrollbar-track { background: #111; }
        
        /* Legacy Cart Styles Removed */
        
        /* Subtle gradient overlay on hover */
        .cart-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(92, 184, 92, 0.1), transparent);
            transition: left 0.5s;
        }
        
        .cart-item:hover::before {
            left: 100%;
        }

        .cart-item:hover {
            background: linear-gradient(135deg, rgba(10, 10, 10, 0.95) 0%, rgba(30, 30, 30, 0.9) 100%);
            border-color: #fff;
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 8px 20px rgba(92, 184, 92, 0.3),
                        0 0 15px rgba(92, 184, 92, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .cart-item.removing {
            animation: itemRemove 0.3s ease forwards;
        }

        .item-emoji {
            font-size: 40px;
            text-align: center;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
            margin-bottom: 5px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .item-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .item-name {
            font-family: 'Impact', sans-serif;
            font-weight: normal;
            font-size: 14px;
            color: #ccc;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            line-height: 1.2;
        }
        
        .cart-item:hover .item-name {
            color: #fff;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
        }

        .item-meta {
            font-family: 'Courier New', monospace;
            font-size: 9px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .item-price {
            font-family: 'Pricedown', 'Bungee', 'Impact', sans-serif;
            font-size: 28px;
            color: var(--gta-green);
            text-shadow: 2px 2px 0 #000, 0 0 10px rgba(92, 184, 92, 0.5);
            margin-top: 4px;
            letter-spacing: 1px;
        }

        /* Quantity Badge */
        .item-quantity {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--gta-green);
            color: #000;
            font-family: 'Impact', sans-serif;
            font-size: 12px;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 1;
        }

        /* Delete Button - GTA Style */
        .item-delete {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(192, 57, 43, 0.2);
            border: 2px solid #c0392b;
            color: #c0392b;
            font-family: 'Impact', sans-serif;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 4px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .item-delete:hover {
            background: #c0392b;
            color: #fff;
            border-color: #fff;
            box-shadow: 0 0 15px rgba(192, 57, 43, 0.6);
            transform: scale(1.1);
        }
        
        .item-delete:active {
            transform: scale(0.95);
        }
        
        /* RESPECT + Animation */
        @keyframes respectSlide {
            0% { opacity: 0; transform: translateX(-20px); }
            20% { opacity: 1; transform: translateX(0); }
            80% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(0); }
        }

        .respect-plus {
            font-family: 'Pricedown', 'Bungee', 'Impact', sans-serif;
            color: var(--gta-green);
            font-size: 24px;
            animation: respectSlide 3s ease forwards;
            position: absolute;
            right: 0;
            top: -30px;
            text-shadow: 1px 1px 0 #000;
            pointer-events: none;
            z-index: 100;
        }
        
        /* Empty State */
        .cart-empty {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
        }
        
        .cart-empty.show {
            display: flex;
        }
        
        .empty-icon {
            font-size: 60px;
            margin-bottom: 15px;
            opacity: 0.4;
        }
        
        .empty-text {
            font-family: 'Pricedown', 'Impact', sans-serif;
            font-size: 24px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .empty-sub {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #555;
            margin-bottom: 20px;
        }
        
        .empty-btn {
            padding: 12px 30px;
            font-size: 14px;
        }
        
        /* Checkout Section */
        .cart-checkout-section {
            background: rgba(0, 0, 0, 0.9);
            border-top: 2px solid #333;
            padding: 15px 20px;
        }
        
        /* Promo Code */
        .cart-promo {
            display: flex;
            gap: 8px;
            margin-bottom: 5px;
        }
        
        .cart-promo-input {
            flex: 1;
            background: #000;
            border: 1px solid #444;
            padding: 10px 12px;
            color: var(--gta-green);
            font-family: 'Courier New', monospace;
            font-size: 13px;
            text-transform: uppercase;
            outline: none;
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        .cart-promo-input::placeholder {
            color: #444;
            font-weight: normal;
        }
        
        .cart-promo-input:focus {
            border-color: var(--gta-green);
            box-shadow: 0 0 10px rgba(63, 165, 53, 0.2);
        }
        
        .cart-promo-btn {
            background: #333;
            border: 1px solid #555;
            padding: 10px 15px;
            color: #fff;
            font-family: 'Impact', sans-serif;
            font-size: 12px;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .cart-promo-btn:hover {
            background: var(--gta-green);
            border-color: var(--gta-green);
            color: #000;
        }
        
        .cart-promo-msg {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: var(--gta-green);
            min-height: 16px;
            margin-bottom: 10px;
        }
        
        /* Totals Box */
        .cart-totals-box {
            background: #111;
            border: 1px solid #333;
            padding: 12px 15px;
            margin-bottom: 15px;
        }
        
        .cart-total-line {
            display: flex;
            justify-content: space-between;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #888;
            padding: 5px 0;
        }
        
        .cart-total-final {
            border-top: 1px dashed #333;
            margin-top: 8px;
            padding-top: 10px;
            font-family: 'Pricedown', 'Bungee', 'Impact', sans-serif;
            font-size: 24px;
            color: var(--gta-gold);
        }
        
        .cart-total-final span:first-child {
            color: #fff;
        }
        
        /* Retro Checkout Button (Unified with Shop) */
        .cart-checkout-btn {
            width: 100%;
            padding: 10px 0;
            margin-top: 10px;
            font-family: 'Pricedown', 'Impact', sans-serif;
            font-size: 22px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            border: none;
            
            /* Retro Green Style */
            background: var(--gta-green);
            color: #000;
            position: relative;
            overflow: hidden;
            transition: all 0.1s;
            box-shadow: 0 3px 0 #1e5626; /* Retro 3D press effect */
            border-radius: 2px;
        }
        
        .cart-checkout-btn::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
            pointer-events: none;
        }

        .cart-checkout-btn:active {
            transform: translateY(3px);
            box-shadow: 0 0 0 #1e5626;
        }

        /* Removed Wanted Stars Styles */
        .wanted-stars { display: none; }
        
        .cart-secure-text {
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            color: #555;
            margin-top: 10px;
            letter-spacing: 1px;
        }

        /* Wanted Level Stars (Red Glow) */
        .wanted-stars {
            display: flex;
            gap: 4px;
            margin-left: auto;
            align-self: center;
        }
        .wanted-star {
            color: #333;
            font-size: 20px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .wanted-star.active {
            color: #e74c3c;
            text-shadow: 0 0 10px rgba(231, 76, 60, 0.8);
            transform: scale(1.1);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           NAVIGATION BAR - Floating Capsule (Apple + GTA Style)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .bottom-nav {
            position: fixed !important;
            bottom: 30px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            width: 90% !important;
            max-width: 350px !important;
            height: 65px !important;
            background: rgba(0, 0, 0, 0.6) !important;
            backdrop-filter: blur(10px) !important;
            backdrop-filter: blur(10px) !important;
            border: 1px solid #333 !important;
            border-radius: 40px !important;
            display: flex !important;
            justify-content: space-evenly !important;
            align-items: center !important;
            z-index: 20000 !important;
            box-shadow: 0 15px 40px rgba(0,0,0,0.6) !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #555;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }
        
        .nav-item.active {
            color: #fff !important;
        }
        
        .nav-item.active .nav-icon {
            transform: translateY(-3px);
        }

        .nav-item.active .nav-icon svg {
            fill: #fff !important;
            filter: drop-shadow(0 0 8px rgba(255,255,255,0.4));
        }
        
        .nav-item span {
            font-family: 'GraffitiTwo', 'Impact', sans-serif;
            font-size: 11px;
            letter-spacing: 1px;
            margin-top: 3px;
            text-transform: uppercase;
            opacity: 0.8;
        }
        
        .nav-item.active span {
            opacity: 1;
            color: #fff;
        }

        /* Cart Counter */
        #basket-count, #cart-nav-count {
            color: var(--gta-gold) !important;
            font-weight: bold;
        }

        /* MISSION PASSED OVERLAY */
        .mission-passed-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 99999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .mp-text {
            font-family: 'Pricedown', 'Bungee', 'Impact', sans-serif;
            font-size: 90px;
            color: #C4A000; /* Authentic Gold */
            text-shadow: 
                4px 4px 0 #000,
                -1px -1px 0 #000,  
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000;
            transform: scale(3); /* Start larger */
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.22, 1, 0.36, 1); /* Slam effect */
        }
        
        .mp-active .mp-text {
            transform: scale(1);
            opacity: 1;
        }

        .mp-sub {
            font-family: 'Pricedown', 'Bungee', 'Impact', sans-serif;
            font-size: 40px;
            color: #fff;
            text-shadow: 
                2px 2px 0 #000,
                -1px -1px 0 #000,
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000;
            margin-top: 10px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease 0.5s;
        }

        .mp-active .mp-sub {
            opacity: 1;
            transform: translateY(0);
        }
        
        .mp-instruction {
            font-family: 'Pricedown', 'Bungee', 'Impact', sans-serif;
            font-size: 24px;
            color: #FFD700; /* Bright gold for visibility */
            text-shadow: 
                2px 2px 0 #000,
                -1px -1px 0 #000,
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000;
            margin-top: 30px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease 1s; /* Delayed appearance */
            text-align: center;
            letter-spacing: 2px;
        }
        
        .mp-active .mp-instruction {
            opacity: 1;
            transform: translateY(0);
        }

        /* MOBILE OPTIMIZATION & CHECKOUT FIX */
        .cart-content {
             /* Ensure content scrolls behind the fixed footer area if needed, 
                but mainly we rely on the footer section padding */
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CART SUMMARY POLISH - RETRO MINIMALIST
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .cart-checkout-section {
            padding: 15px 20px 130px; /* Top/Side padding reduced, Bottom kept for nav */
            background: #000;
            border-top: 2px solid #333;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.8);
            position: relative;
            z-index: 20;
        }

        /* Compact Promo Area */
        .cart-promo {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .cart-promo-input {
            flex: 1;
            background: #111;
            border: 1px solid #333;
            border-radius: 2px; /* Sharper corners for retro feel */
            padding: 8px 10px;
            color: var(--gta-green);
            font-family: 'Courier New', monospace;
            font-size: 12px;
            text-transform: uppercase;
            outline: none;
            height: 36px;
        }
        
        .cart-promo-input::placeholder { color: #444; }

        .cart-promo-btn {
            background: #222;
            border: 1px solid #444;
            border-radius: 2px;
            color: #ccc;
            font-family: 'Impact', sans-serif;
            font-size: 12px;
            padding: 0 15px;
            height: 36px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cart-promo-btn:hover {
            background: #fff;
            color: #000;
        }

        /* Modern Integrated Checkout - Polished */
        .checkout-module {
            background: linear-gradient(180deg, rgba(30, 30, 30, 0.6) 0%, rgba(20, 20, 20, 0.8) 100%);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .refill-btn-small {
            background: rgba(46, 204, 113, 0.15);
            border: 1px solid rgba(46, 204, 113, 0.4);
            color: #2ecc71;
            font-size: 10px;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Courier New', monospace;
            letter-spacing: 0.5px;
            margin-left: 5px;
        }
        .refill-btn-small:hover {
            background: #2ecc71;
            color: #000;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(46, 204, 113, 0.3);
        }

        /* Refill Modal Styles */
        .refill-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .refill-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            padding: 15px;
            border-radius: 12px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        .refill-btn:hover {
            background: rgba(46, 204, 113, 0.2);
            border-color: #2ecc71;
            transform: scale(1.05);
        }
        .refill-custom {
            display: flex;
            gap: 10px;
            position: relative;
            z-index: 99999;
            pointer-events: auto;
        }
        
        .refill-custom input,
        .refill-custom button {
            position: relative;
            z-index: 99999;
            pointer-events: auto !important;
        }

        .promo-field-group {
            display: flex;
            gap: 0;
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 4px;
            transition: border-color 0.2s;
        }
        
        .promo-field-group:focus-within {
            border-color: var(--gta-green);
            box-shadow: 0 0 10px rgba(106, 180, 70, 0.2);
        }

        .modern-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #fff;
            padding: 10px 12px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 13px;
            outline: none;
            letter-spacing: 0.5px;
        }
        
        .modern-input::placeholder {
            color: #555;
            font-weight: 500;
        }
        
        .modern-input:focus {
            border-color: transparent;
        }

        .modern-apply-btn {
            background: rgba(255, 255, 255, 0.1);
            color: #aaa;
            border: none;
            padding: 14px 24px; /* Much larger touch target */
            border-radius: 8px;
            font-size: 14px; /* Bigger text */
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            margin: 2px;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-height: 48px; /* iOS recommended touch target */
            min-width: 80px;
        }
        
        .modern-apply-btn:hover {
            background: var(--gta-green);
            color: #000;
            box-shadow: 0 0 10px var(--gta-green);
        }
        
        .modern-apply-btn:active {
            transform: scale(0.95); /* Visual feedback on tap */
        }

        .modern-totals {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .mt-left, .mt-right {
            display: flex;
            flex-direction: column;
        }
        
        .mt-right {
            align-items: flex-end;
        }

        .mt-label {
            font-size: 9px;
            color: #666;
            letter-spacing: 2px;
            font-weight: 800;
            margin-bottom: 6px;
            text-transform: uppercase;
        }

        .mt-value-sm {
            font-size: 14px;
            color: #888;
            font-family: 'Courier New', monospace;
            font-weight: 600;
            background: rgba(255,255,255,0.05);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .mt-value-lg {
            font-size: 32px;
            color: #fff;
            font-weight: 700;
            letter-spacing: -1px;
            line-height: 1;
            text-shadow: 0 0 20px rgba(255,255,255,0.2);
        }
        
        /* Checkout Button Glow */
        .cart-checkout-btn {
            box-shadow: 0 0 20px rgba(106, 180, 70, 0.4);
            border: 1px solid rgba(106, 180, 70, 0.5);
        }
        
        .cart-checkout-btn:active {
             box-shadow: 0 0 10px rgba(106, 180, 70, 0.6);
        }

        .cart-total-line {
            display: flex;
            justify-content: space-between;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }

        .cart-total-final {
            margin-top: 5px;
            padding-top: 0;
            border-top: none;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .cart-total-final span:first-child {
            font-family: 'Impact', sans-serif;
            font-size: 18px;
            color: #fff;
            letter-spacing: 1px;
        }

        #basket-total {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 18px;
            color: var(--gta-green);
            margin: 0;
            letter-spacing: 0;
        }

        /* Retro Checkout Button (Matches Shop Green Button) */
        .cart-checkout-btn {
            width: 100%;
            padding: 12px;
            background: var(--gta-green);
            font-family: 'Pricedown', 'Impact', sans-serif;
            font-size: 20px;
            color: #000;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 0 10px rgba(46, 204, 113, 0.2);
        }

        .cart-checkout-btn:hover {
            background: #fff;
            box-shadow: 0 0 15px #fff;
            transform: scale(1.02);
        }

        .cart-checkout-btn:active {
            transform: scale(0.98);
        }

        @media (max-width: 600px) {
            .cart-container {
                width: 100% !important;
                height: 100% !important;
                max-width: 100% !important;
                max-height: 100% !important;
                border: none !important;
                border-radius: 0 !important;
            }
            
            .cart-header-bar {
                padding-top: max(15px, env(safe-area-inset-top));
            }
            
            .mp-text {
                font-size: 40px;
            }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CART SUMMARY POLISH ("Gear" / Apple Quality)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        /* Promo Input Area (Compact) */
        .cart-promo {
            display: flex;
            gap: 5px;
            margin-top: 40px; /* Added Separation */
            margin-bottom: 10px;
            background: transparent;
            padding: 0;
            border: none;
            position: relative;
        }

        .cart-promo-input {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
            border-radius: 4px;
            padding: 0 10px;
            color: var(--gta-green);
            font-family: 'Courier New', monospace;
            font-size: 12px;
            text-transform: uppercase;
            outline: none;
            height: 32px;
            transition: all 0.3s;
            box-shadow: none;
        }
        
        .cart-promo-input::placeholder {
            color: #555;
            content: "ENTER CODE...";
        }

        .cart-promo-input:focus {
            border-color: var(--gta-green);
            background: rgba(0, 0, 0, 0.5);
        }

        .cart-promo-btn {
            background: #222;
            border: 1px solid #444;
            border-radius: 4px;
            color: #eee;
            font-family: 'Impact', sans-serif;
            letter-spacing: 1px;
            padding: 0 15px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }

        .cart-promo-btn:hover {
            background: #fff;
            color: #000;
            border-color: #fff;
        }

        /* Totals Box - Ultra Compact */
        .cart-totals-box {
            background: transparent;
            border: none;
            border-top: none;
            border-radius: 0;
            padding: 5px 5px 0 5px;
            margin-bottom: 5px;
            box-shadow: none;
        }

        .cart-total-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #666;
            margin-bottom: 3px;
        }

        .cart-total-final {
            margin-top: 5px;
            padding-top: 5px;
            border-top: none;
            margin-bottom: 0;
            display: flex;
            align-items: center;
        }

        .cart-total-final span:first-child {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-weight: 700;
            font-size: 28px;
            color: #fff;
            letter-spacing: -0.5px;
        }

        #basket-total {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-weight: 400;
            font-size: 28px;
            color: #fff;
            margin-left: auto;
            margin-right: 15px;
            letter-spacing: -0.5px;
        }
        
        /* Bottom Navigation - Shop Style */
        .cart-nav-bar {
            display: flex;
            justify-content: space-evenly;
            background: rgba(0, 0, 0, 0.95);
            border-top: 2px solid #333;
            padding: 10px 0 15px;
        }
        
        .cart-nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
            padding: 8px 20px;
            position: relative;
        }
        
        .cart-nav-btn span {
            font-family: 'Impact', sans-serif;
            font-size: 11px;
            letter-spacing: 1px;
        }
        
        .cart-nav-btn:hover {
            color: #fff;
        }
        
        .cart-nav-btn.active {
            color: var(--gta-green);
        }
        
        .cart-nav-btn.active::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 3px;
            background: var(--gta-green);
        }
        
        .cart-nav-badge {
            position: absolute;
            top: 0;
            right: 10px;
            background: var(--gta-gold);
            color: #000;
            font-size: 10px !important;
            font-weight: 700;
            padding: 2px 6px;
            min-width: 18px;
            text-align: center;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px) scale(0.95); 
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1); 
            }
        }
        
        @keyframes itemRemove {
            to {
                opacity: 0;
                transform: translateX(-100%);
                height: 0;
                padding: 0;
                margin: 0;
            }
        }
    </style>

    <!-- District Selection Modal (New) -->
    <div id="district-modal" class="modal-3d" style="display:none; align-items:center; justify-content:center; z-index: 50000;">
        <div class="terminal-box" style="width: 90%; max-width: 400px; text-align: center; padding: 20px;">
            <div style="border-bottom: 2px solid var(--gta-green); padding-bottom:10px; margin-bottom:15px; font-size:24px; color:var(--gta-gold); font-family: 'Pricedown';">
                SELECT DISTRICT
            </div>
            <div id="district-modal-header" style="margin-bottom: 15px; color: #aaa; font-family: 'Impact'; font-size: 18px;">
                CITY
            </div>
            <div id="district-modal-content" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding-bottom: 20px; max-height: 50vh; overflow-y: auto;">
                <!-- Buttons go here -->
            </div>
            <button onclick="closeDistrictModal()" style="background:#900; color:#fff; border:1px solid #fff; padding:10px 20px; font-family:'Pricedown'; width:100%; cursor:pointer; font-size: 18px;">CANCEL</button>
        </div>
    </div>

    <!-- Invoice Modal (Apple-Style Bottom Sheet + GTA Aesthetic) -->
    <div id="invoice-modal" class="cart-modal" style="display:none; align-items: flex-end; justify-content: center;">
        <div class="cart-backdrop" onclick="closeInvoice()" style="backdrop-filter: blur(4px);"></div>
        
        <div class="invoice-sheet">
            <!-- Mobile Handle -->
            <div class="sheet-handle"></div>

            <!-- Header -->
            <div class="sheet-header">
                <div class="sheet-title">PAYMENT REQUEST</div>
                <button class="sheet-close" onclick="closeInvoice()">Done</button>
            </div>

            <!-- Main Content -->
            <div class="sheet-content">
                
                <!-- Amount Hero -->
                <div class="amount-hero">
                    <div class="amount-label">TOTAL AMOUNT DUE</div>
                    <div class="amount-value" id="invoice-amount" onclick="triggerCopy(this, 'invoice-amount')">
                        0.00 SOL
                    </div>
                </div>

                <!-- QR Card -->
                <div class="qr-card">
                    <div id="qrcode"></div>
                    <div class="scan-line"></div>
                </div>

                <!-- Smart Address Field -->
                <div class="address-field" onclick="triggerCopy(this, 'invoice-address')">
                    <div class="address-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 7h-3a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h3a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2zM9 7h3a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2z"/></svg>
                    </div>
                    <div class="address-text" id="invoice-address">Generating Address...</div>
                    <div class="copy-badge">COPY</div>
                </div>

                <!-- Status & Timer -->
                <div class="status-row">
                    <div class="status-dot"></div>
                    <div class="status-text">Listening for transaction...</div>
                </div>
            </div>
        </div>
        
        <script>
            function triggerCopy(el, id) {
                copyText(id);
                
                // Visual Feedback
                const originalTransform = el.style.transform;
                el.style.transform = "scale(0.96)";
                setTimeout(() => el.style.transform = originalTransform || "scale(1)", 150);
                
                // If it's the address field, change the badge
                const badge = el.querySelector('.copy-badge');
                if(badge) {
                    const oldText = badge.innerText;
                    badge.innerText = "COPIED";
                    badge.style.background = "var(--gta-green)";
                    badge.style.color = "#000";
                    setTimeout(() => {
                        badge.innerText = oldText;
                        badge.style.background = "rgba(46, 204, 113, 0.1)";
                        badge.style.color = "var(--gta-green)";
                    }, 2000);
                }
            }
        </script>

        <style>
            /* Sheet / Card Hybrid Styles */
            .invoice-sheet {
                width: 100%;
                max-width: 420px;
                background: rgba(18, 18, 18, 0.92);
                backdrop-filter: blur(30px);
                -webkit-backdrop-filter: blur(30px);
                border-radius: 24px 24px 0 0;
                border-top: 1px solid rgba(255, 255, 255, 0.15);
                box-shadow: 0 -10px 40px rgba(0,0,0,0.6);
                position: relative;
                z-index: 30001;
                animation: slideUpSheet 0.4s cubic-bezier(0.16, 1, 0.3, 1);
                padding-bottom: env(safe-area-inset-bottom);
                overflow: visible; /* Changed from hidden to allow clicks */
                pointer-events: auto; /* Ensure clicks work */
            }

            @media (min-width: 600px) {
                .invoice-sheet {
                    border-radius: 24px;
                    margin-bottom: 20px;
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    box-shadow: 0 20px 50px rgba(0,0,0,0.6);
                }
            }

            @keyframes slideUpSheet {
                from { transform: translateY(100%); }
                to { transform: translateY(0); }
            }

            .sheet-handle {
                width: 40px;
                height: 4px;
                background: rgba(255, 255, 255, 0.2);
                border-radius: 10px;
                margin: 12px auto 8px;
            }

            .sheet-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px 25px;
                border-bottom: 1px solid rgba(255,255,255,0.05);
            }

            .sheet-title {
                font-family: 'Courier New', monospace;
                font-size: 12px;
                color: rgba(255,255,255,0.5);
                letter-spacing: 1px;
                font-weight: bold;
                text-transform: uppercase;
            }

            .sheet-close {
                background: none;
                border: none;
                color: var(--gta-green);
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                padding: 5px;
            }

            .sheet-content {
                padding: 30px 25px 40px;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .amount-hero { margin-bottom: 30px; text-align: center; }
            .amount-label { font-size: 11px; color: #666; letter-spacing: 1px; margin-bottom: 6px; font-family: -apple-system, sans-serif; text-transform: uppercase; font-weight: 600; }
            .amount-value {
                font-family: 'Pricedown';
                font-size: 56px;
                color: #fff;
                text-shadow: 0 0 20px rgba(46, 204, 113, 0.4);
                line-height: 1;
                transition: transform 0.2s;
                cursor: pointer;
                -webkit-user-select: none;
            }

            .qr-card {
                background: #fff;
                padding: 15px;
                border-radius: 20px;
                margin-bottom: 30px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                position: relative;
                overflow: hidden;
            }
            .scan-line {
                position: absolute;
                top: 0; left: 0; right: 0; height: 2px;
                background: rgba(46, 204, 113, 0.8);
                box-shadow: 0 0 10px var(--gta-green);
                animation: scan 2.5s ease-in-out infinite;
                opacity: 0.7;
            }
            @keyframes scan { 
                0% {top:-10%; opacity: 0;} 
                15% {opacity: 1;}
                85% {opacity: 1;}
                100% {top:110%; opacity: 0;} 
            }

            .address-field {
                width: 100%;
                background: rgba(255,255,255,0.05);
                border: 1px solid rgba(255,255,255,0.1);
                border-radius: 16px;
                padding: 12px 16px;
                display: flex;
                align-items: center;
                gap: 12px;
                cursor: pointer;
                transition: background 0.2s, transform 0.1s;
                margin-bottom: 25px;
            }
            .address-field:active { background: rgba(255,255,255,0.1); }

            .address-icon { color: #666; display: flex; }
            .address-text {
                flex: 1;
                font-family: 'Courier New', monospace;
                font-size: 13px;
                color: #ccc;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .copy-badge {
                font-size: 11px;
                font-weight: bold;
                color: var(--gta-green);
                background: rgba(46, 204, 113, 0.1);
                padding: 6px 12px;
                border-radius: 100px;
                transition: all 0.2s;
                min-width: 50px;
                text-align: center;
            }

            .status-row {
                display: flex;
                align-items: center;
                gap: 10px;
                opacity: 0.7;
            }
            .status-dot {
                width: 8px; height: 8px;
                background: var(--gta-green);
                border-radius: 50%;
                box-shadow: 0 0 10px var(--gta-green);
                animation: pulse 1.5s infinite;
            }
            .status-text {
                font-size: 12px;
                color: #888;
                font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            }
        </style>
    </div>

    <!-- Refill Modal (Redesigned Centered) -->
    <div id="refill-modal" class="cart-modal" style="display:none; align-items: center; justify-content: center;">
        <div class="cart-backdrop" onclick="closeRefill()" style="backdrop-filter: blur(4px);"></div>
        
        <div class="refill-box">
            <div class="sheet-header" style="border-bottom: 1px solid #333;">
                <div class="sheet-title">TOP UP WALLET</div>
                <button class="sheet-close" onclick="closeRefill()">âœ•</button>
            </div>
            
            <div style="padding: 25px;">
                <!-- Presets -->
                <div class="refill-options-grid">
                    <button class="refill-btn" onclick="initRefill(5)">â‚¬5</button>
                    <button class="refill-btn" onclick="initRefill(10)">â‚¬10</button>
                    <button class="refill-btn" onclick="initRefill(20)">â‚¬20</button>
                    <button class="refill-btn" onclick="initRefill(50)">â‚¬50</button>
                </div>
                
                <div style="text-align:center; color:#666; margin: 20px 0; font-size:12px; position:relative;">
                    <span style="background:#1a1a1a; padding:0 10px; position:relative; z-index:1;">OR CUSTOM AMOUNT</span>
                    <div style="height:1px; background:#333; position:absolute; top:50%; width:100%; left:0; z-index:0;"></div>
                </div>
                
                <div class="refill-custom-box">
                     <input type="number" id="custom-refill" placeholder="0" class="refill-input">
                     <span class="currency-symbol">â‚¬</span>
                </div>
                
                <button id="refill-pay-btn" class="refill-submit-btn" onclick="initCustomRefill()">DEPOSIT FUNDS</button>
            </div>
        </div>
    </div>

    <div class="content">
        <!-- Video Intro -->
        <div id="video-intro" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:99990; align-items:center; justify-content:center;">
            <div class="video-frame-overlay"></div> <!-- CINEMATIC OVERLAY -->
            <div id="video-loading" style="position:absolute; color:#555; font-family:'Courier New'; z-index:1;">BUFFERING...</div>
            <video id="intro-vid" style="width:100%; height:100%; object-fit:contain; position:relative; z-index:2; transform: translateZ(0); will-change: transform;" playsinline webkit-playsinline preload="auto" muted>
                <source src="/webapp_fresh/intro.mp4" type="video/mp4">
            </video>
            <div id="play-overlay" style="display:none; position:absolute; z-index:4; color:#fff; border:2px solid #fff; padding:10px 20px; cursor:pointer; background:rgba(0,0,0,0.7);" onclick="forcePlayVideo()">[ RETRY PLAY ]</div>
            <div style="position:absolute; bottom:20px; right:20px; color:rgba(255,255,255,0.5); font-family:'Courier New'; font-size:12px; cursor:pointer; z-index:4; border:1px solid #555; padding:5px; background:rgba(0,0,0,0.5);" onclick="skipIntro()">[ SKIP INTRO ]</div>
        </div>

        <!-- SHOP SECTION -->
        <div id="shop" class="section active">
            <!-- Street Sign Header - Full Scene (Shop Only) -->
            <div class="street-sign-container">
                <!-- Pole -->
                <div class="sign-pole"></div>
                <div class="sign-bracket"></div>
                <!-- Sign with Bird -->
                <div class="street-sign">
                    <!-- Bird sitting on sign -->
                    <div class="bird">
                        <div class="bird-body">
                            <div class="bird-head">
                                <div class="bird-beak"></div>
                                <div class="bird-eye"></div>
                            </div>
                            <div class="bird-tail"></div>
                            <div class="bird-legs"></div>
                        </div>
                    </div>
                    <!-- Damage -->
                    <div class="bent-corner"></div>
                    <div class="rust-stain"></div>
                    <div class="bullet-hole h1"></div>
                    <div class="bullet-hole h2"></div>
                    <div class="sticker-residue"></div>
                    <span class="graffiti-tag">GSF</span>
                    <span class="sign-text">BIG COMPANY BOT</span>
                </div>
            </div>

            <!-- Shop Header -->
            <div class="shop-header">BIG COMPANY BOT</div>

            <!-- LSPD Search -->
            <div class="search-container">
                <span class="search-label">LSPD DATABASE > SEARCH:</span>
                <input type="text" class="search-input" placeholder="ENTER SUSPECT/ITEM NAME..." oninput="filterSearch(this.value)">
            </div>

            <div class="filters" id="city-filters">
                <button class="filter-btn active" onclick="filterProducts('all')">ALL ZONES</button>
            </div>
            <div class="product-grid" id="product-grid">
                <div class="loading" id="stock-loader">
                    LOADING STOCK...
                    <br><br>
                    <button onclick="loadProducts()" style="font-size:16px; background:#333; color:#fff; border:1px solid #fff; padding:5px 10px; cursor:pointer;">[ FORCE RELOAD ]</button>
                </div>
            </div>
        </div>

        <!-- MAP SECTION -->
        <div id="map" class="section">
            <div class="placeholder-box" style="padding: 0; border: none;">
                <div class="map-header">BIG COMPANY BOT</div>
                <div class="map-container" id="map-container">
                    <div class="satellite-view">
                        <div class="map-zoom-layer" id="map-zoom-layer">
                    <svg id="map-img" class="map-img-interactive" viewBox="0 0 1024 1024" preserveAspectRatio="xMidYMid meet">
                        <defs>
                            <!-- PAPER MAP TEXTURE -->
                            <pattern id="city-texture" width="60" height="60" patternUnits="userSpaceOnUse">
                                <!-- Land Base -->
                                <rect width="60" height="60" fill="transparent"/> <!-- Transparent background -->
                                
                                <!-- Roads (Light Grey Lines) -->
                                <path d="M 30 0 L 30 60 M 0 30 L 60 30" stroke="#52575d" stroke-width="3" fill="none"/>
                                <path d="M 0 0 L 60 60" stroke="#52575d" stroke-width="1" fill="none" opacity="0.5"/>
                                
                                <!-- City Blocks (Lighter Grey Areas) -->
                                <rect x="5" y="5" width="20" height="20" fill="#2d3236"/>
                                <rect x="35" y="35" width="20" height="20" fill="#2d3236"/>
                                
                                <!-- Parks (Green Patches) -->
                                <rect x="35" y="5" width="15" height="15" fill="#5a6e5a" opacity="0.8"/>
                            </pattern>
                        </defs>
                        <g transform="translate(0,1024) scale(0.1,-0.1)">
                            <!-- Fill with Grid, Stroke with Neon Green -->
                            <path d="M6713 9109 c-27 -17 -33 -27 -33 -57 0 -33 -1 -34 -14 -17 -13 19
-16 18 -66 -13 -28 -18 -63 -32 -78 -32 -50 0 -67 -11 -96 -60 -17 -28 -39
-51 -52 -54 -46 -12 -105 -75 -143 -151 l-36 -76 -102 -35 -102 -35 -81 41
c-44 22 -100 43 -124 46 -39 6 -50 2 -122 -43 -43 -27 -105 -59 -137 -72 l-57
-23 -83 26 c-61 19 -105 43 -172 91 -49 36 -106 76 -125 90 -33 23 -48 25
-183 31 l-147 7 0 27 0 28 -65 -6 c-50 -3 -75 -1 -104 13 l-38 17 -64 -47
c-45 -33 -69 -45 -83 -40 -12 3 -59 12 -106 20 -47 7 -141 33 -210 58 -121 42
-127 43 -180 32 -30 -6 -79 -20 -108 -30 -47 -17 -52 -22 -52 -49 0 -27 -9
-37 -72 -78 -84 -54 -88 -54 -148 26 -32 43 -40 61 -40 96 0 38 -5 48 -49 89
-85 80 -104 92 -140 81 -33 -9 -98 -56 -143 -102 -17 -18 -36 -28 -55 -28 -17
0 -56 -9 -89 -20 -73 -26 -104 -20 -152 30 -25 25 -63 48 -120 70 l-82 32 -98
-12 c-57 -7 -158 -11 -247 -8 -135 4 -160 8 -246 36 -121 40 -245 45 -294 11
-62 -42 -207 -110 -258 -120 -38 -8 -63 -21 -92 -49 -22 -21 -53 -42 -70 -46
-16 -4 -55 -19 -85 -34 -50 -24 -62 -26 -132 -21 -82 6 -140 -1 -146 -18 -11
-32 -51 -76 -77 -84 -16 -5 -65 -36 -108 -69 l-79 -60 -76 11 c-85 13 -87 12
-96 -54 -6 -38 -13 -45 -85 -94 l-79 -53 -12 -77 c-25 -171 -33 -194 -65 -203
-17 -4 -66 -3 -113 4 -73 11 -86 10 -110 -4 -24 -15 -28 -25 -33 -85 -4 -37
-7 -113 -8 -168 -1 -73 -8 -125 -27 -195 -24 -88 -25 -104 -18 -215 4 -66 6
-179 5 -250 -3 -119 -1 -135 22 -185 13 -30 34 -64 46 -74 35 -32 71 -125 96
-251 13 -67 38 -151 55 -188 21 -48 38 -112 55 -210 30 -183 26 -268 -17 -346
-28 -51 -61 -141 -52 -141 2 0 23 12 46 26 40 25 42 26 55 8 7 -10 13 -32 13
-49 0 -18 9 -58 20 -90 26 -74 26 -101 0 -108 -16 -4 -20 -14 -20 -47 0 -38 2
-41 23 -34 12 4 38 17 57 30 47 33 118 33 146 2 41 -47 73 -106 79 -149 7 -44
7 -45 68 -67 34 -12 81 -22 104 -22 24 0 64 -8 91 -18 66 -25 197 -116 218
-151 19 -31 91 -71 130 -71 16 0 35 -11 52 -32 15 -17 58 -46 100 -65 61 -28
85 -33 146 -33 42 0 79 -5 89 -13 10 -7 21 -35 26 -66 10 -60 33 -85 89 -96
39 -7 63 9 82 56 7 16 22 32 35 35 21 5 244 0 502 -12 128 -5 132 -5 170 19
61 40 97 43 142 14 l38 -26 5 -88 c3 -48 11 -112 18 -141 10 -46 16 -55 52
-73 32 -16 50 -19 89 -14 47 7 48 6 55 -21 4 -16 17 -36 28 -45 17 -14 18 -19
7 -33 -19 -23 -6 -34 98 -85 l90 -44 3 -86 c2 -47 0 -121 -6 -165 l-9 -78 -41
-18 c-26 -11 -53 -34 -74 -64 -18 -25 -39 -46 -47 -46 -8 0 -26 -4 -40 -10
-26 -10 -26 -10 -9 -39 17 -29 17 -30 -14 -56 -30 -25 -32 -32 -32 -88 0 -34
-5 -100 -11 -147 -6 -47 -12 -121 -14 -165 -1 -44 -10 -109 -19 -145 -25 -104
-21 -160 17 -238 19 -37 50 -110 70 -162 51 -130 50 -130 81 -101 13 13 30 35
36 51 9 21 20 29 48 34 63 10 101 7 140 -13 20 -10 63 -26 94 -35 49 -14 57
-20 63 -46 8 -36 24 -46 88 -55 53 -8 56 -14 26 -41 -45 -41 -43 -50 20 -88
40 -25 71 -36 97 -36 22 0 48 -7 58 -15 11 -8 28 -15 37 -15 11 0 29 -20 46
-52 24 -44 34 -53 73 -64 25 -8 70 -14 101 -14 65 0 74 -6 125 -85 21 -33 65
-87 97 -120 l58 -60 52 -207 c48 -194 50 -208 35 -225 -10 -10 -26 -47 -37
-81 l-19 -63 24 -16 c18 -12 24 -24 24 -53 l0 -37 74 -21 c56 -17 88 -33 127
-67 48 -41 57 -44 88 -39 20 4 58 18 84 31 41 20 53 22 85 13 54 -15 59 -13
71 20 12 35 16 36 59 10 37 -23 66 -19 167 20 49 19 52 19 110 2 46 -13 80
-16 146 -12 85 5 86 5 139 53 36 32 58 46 69 41 9 -3 43 -16 76 -27 75 -26 82
-31 91 -70 7 -31 51 -107 63 -107 3 0 23 5 43 10 31 9 42 8 63 -6 14 -9 43
-20 65 -24 39 -7 39 -7 157 104 65 62 136 123 158 135 22 13 52 37 66 54 25
29 30 30 90 28 41 -1 74 4 91 13 26 14 29 13 43 -7 8 -12 15 -34 15 -49 0 -33
5 -34 65 -8 26 11 66 20 90 20 41 0 44 2 59 40 10 26 16 70 16 122 0 76 -3 88
-40 159 l-40 77 28 10 c18 6 34 23 46 51 18 38 22 41 58 41 22 0 73 14 113 31
l74 31 57 -46 c62 -51 59 -50 118 -35 36 9 56 26 135 115 94 106 119 152 136
252 6 37 10 42 34 42 15 0 50 -7 77 -15 44 -13 58 -13 132 2 70 13 86 20 100
42 43 68 85 111 109 111 26 0 71 -44 145 -142 l36 -49 -39 -36 -40 -36 22 -23
22 -23 -26 -10 c-31 -12 -44 -50 -27 -82 7 -12 17 -42 24 -66 6 -25 14 -44 19
-44 4 1 60 1 126 1 116 0 119 0 156 30 21 16 47 30 58 30 11 0 39 11 63 25 48
28 48 31 60 198 l6 99 -37 54 c-21 30 -50 63 -65 74 -18 13 -31 35 -39 65
l-11 45 -79 -41 c-83 -44 -130 -51 -183 -30 -27 10 -28 14 -28 76 0 62 4 74
71 203 57 112 70 143 66 172 -5 40 16 173 33 210 7 15 31 34 60 46 66 30 120
108 120 175 0 61 -23 123 -60 165 -42 48 -42 109 1 187 l31 57 -21 62 c-34
100 -23 178 23 178 7 0 26 10 41 22 25 20 27 25 21 72 -3 28 -9 78 -11 111
l-6 60 60 45 c48 36 63 54 76 93 25 73 66 90 220 91 l120 1 95 49 c52 27 97
53 99 59 2 6 27 45 56 87 34 50 54 91 59 120 4 25 11 68 16 95 5 28 9 73 9
101 1 47 5 55 36 83 39 34 81 40 145 21 19 -6 64 -14 99 -19 63 -8 63 -8 73
20 14 42 39 44 115 8 74 -34 137 -50 168 -43 11 3 31 21 44 41 20 32 23 45 19
103 -4 55 -1 74 16 107 30 58 92 123 129 135 41 14 100 57 128 92 l22 28 -20
26 c-30 40 -60 52 -136 52 -54 0 -75 4 -94 20 -33 26 -88 26 -148 0 l-47 -20
-90 25 c-80 22 -117 43 -118 68 0 4 20 44 44 90 24 45 50 107 56 137 16 69 44
131 68 154 19 16 19 18 -4 74 -38 92 -30 137 31 194 46 42 54 79 55 245 l0
131 -27 6 c-16 3 -57 11 -93 17 -36 7 -85 23 -109 37 -34 20 -61 27 -113 29
-66 2 -70 4 -136 57 -98 78 -222 254 -222 317 0 8 -18 39 -39 68 -29 39 -61
65 -123 100 -66 38 -93 60 -131 111 -30 40 -65 74 -95 90 -106 60 -290 195
-345 256 -33 35 -95 92 -139 126 -82 63 -118 116 -118 172 0 34 -40 48 -115
40 -61 -6 -64 -6 -111 30 l-48 37 -30 -29 -31 -29 -155 9 c-121 6 -166 13
-205 29 -33 14 -86 25 -155 30 -58 5 -116 11 -130 15 -47 13 -89 52 -101 97
-21 78 -70 172 -113 217 -39 41 -45 55 -70 158 -29 116 -114 343 -131 349 -6
1 -25 -7 -42 -18z" fill="transparent" stroke="rgba(255, 255, 255, 0.95)" stroke-width="30"/>
                        </g>
                    </svg>
                    
                            <!-- Signal Emitters -->
                            <!-- City Pins - Dynamic Container -->
                            <div id="city-pins-container">
                                <!-- Dynamic pins will be injected here -->
                            </div>
                            
                            <!-- District Polygon Overlays -->
                            <div class="district-polygons">
                                <!-- District polygons will be generated dynamically based on your cities -->
                                <!-- No hardcoded districts - add your cities via admin panel -->
                            </div>
                            
                            <!-- Floating District Label -->
                            <div id="district-hover-label" class="district-label">
                                <span class="district-name">DISTRICT</span>
                                <span class="stock-count">0 ITEMS</span>
                            </div>
                        </div> <!-- End Zoom Layer -->
                    </div>

                    <!-- District Panel -->
                    <div id="district-panel" class="district-panel">
                        <div class="panel-header" id="panel-header">SELECT ZONE</div>
                        <div class="panel-list" id="panel-list"></div>
                    </div>
                </div>
                <!-- Removed Redundant Button -->
            </div>
        </div>

        <!-- STATS SECTION with Character Selection -->
        <div id="stats" class="section">
            <div class="placeholder-box">
                <div style="font-size: 32px; margin-bottom: 20px; color: var(--gta-gold);">PLAYER STATS</div>
                <div style="display: flex; gap: 20px; align-items: center; justify-content: center; margin-bottom: 20px;">
                    <img src="https://placehold.co/150x200/000000/3fa535?text=CJ" id="char-img" style="height: 150px; border: 2px solid #fff;">
                    <div>
                        <button class="filter-btn" onclick="changeSkin('cj')">CJ</button>
                        <button class="filter-btn" onclick="changeSkin('sweet')">SWEET</button>
                        <button class="filter-btn" onclick="changeSkin('ryder')">RYDER</button>
                    </div>
                </div>
                <div class="stat-row" style="align-items:center;">
                    <span>RESPECT</span>
                    <div class="stat-bar-container"><div class="stat-bar-fill" style="width:100%"></div></div>
                </div>
                <div class="stat-row" style="align-items:center;">
                    <span>STAMINA</span>
                    <div class="stat-bar-container"><div class="stat-bar-fill" style="width:70%"></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" id="nav-shop" onclick="sfx.select(); showSection('shop')">
            <div class="nav-icon"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-2 .89-2 2v11c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zM10 4h4v2h-4V4zm10 13H4V8h16v9z"/></svg></div>
            <span>SHOP</span>
        </div>
        <div class="nav-item" id="nav-map" onclick="sfx.select(); showSection('map')">
            <div class="nav-icon"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg></div>
            <span>MAP</span>
        </div>
        <div class="nav-item" id="nav-basket" onclick="sfx.select(); openBasket()">
            <div class="nav-icon"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M19 6h-2c0-2.76-2.24-5-5-5S7 3.24 7 6H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-7-3c1.66 0 3 1.34 3 3H9c0-1.66 1.34-3 3-3zm7 15H5V8h14v10z"/></svg></div>
            <span>CART <span id="basket-count" style="color:var(--gta-gold)">(0)</span></span>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        
        // Global Error Handler
        window.onerror = function(msg, url, line, col, error) {
            const grid = document.getElementById('product-grid');
            if(grid && grid.innerHTML.includes('LOADING')) {
                grid.innerHTML = '<div class="loading" style="color:red">CRITICAL ERROR<br><small>Line ' + line + ': ' + msg + '</small><br><button onclick="location.reload()" style="background:#333;color:#fff;border:1px solid #fff;padding:8px;cursor:pointer;">RELOAD APP</button></div>';
            }
            console.error('Global Error:', msg, line, error);
            return false;
        };
        
        function log(msg) { 
            // Disabled
        }

        // --- GLOBAL STATE (Moved to top to prevent TDZ errors) ---
        let allProducts = [];
        let appLocations = {}; // Dynamic cities/districts from API
        let currentStation = 0;
        // BIG COMPANY BOT RADIO - Notorious B.I.G. Playlist
        const stations = [
            { name: "RADIO OFF", src: null },
            { name: "â™« NOTORIOUS THUGS", src: "/webapp_fresh/music/notorious_thugs.mp3" },
            { name: "â™« BIG POPPA", src: "/webapp_fresh/music/big_poppa.mp3" },
            { name: "â™« JUICE", src: "/webapp_fresh/music/juice.mp3" },
            { name: "â™« PARTY AND BULLSHIT", src: "/webapp_fresh/music/party_and_bullshit.mp3" },
            { name: "â™« HYPNOTIZE", src: "/webapp_fresh/music/hypnotize.mp3" }
        ];
        // Use persistent player
        let audioPlayer = document.getElementById('global-audio-player');
        let introAudio = null;
        let basket = [];
        let activePaymentId = null;
        let pollInterval = null;
        tg.expand();
        tg.MainButton.hide();
        
        // --- Sound FX System (Synthesized) ---
        const charSystem = {
            el: null,
            text: null,
            timer: null,
            
            init: function() {
                this.el = document.getElementById('char-layer');
                this.text = document.getElementById('char-text');
            },
            
            show: function(charName, message, duration=4000) {
                if(!this.el) this.init();
                
                let url = "https://upload.wikimedia.org/wikipedia/en/c/ce/Carl_Johnson_GTA_SA.png"; 
                if(charName === 'ryder') url = "https://upload.wikimedia.org/wikipedia/en/3/3f/Ryder_GTA_SA.png"; 
                if(charName === 'smoke') url = "https://upload.wikimedia.org/wikipedia/en/1/17/Big_Smoke_GTA_SA.png";
                
                this.el.style.backgroundImage = `url('${url}')`;
                this.text.innerText = message;
                
                this.el.classList.add('char-visible');
                
                if(this.timer) clearTimeout(this.timer);
                this.timer = setTimeout(() => {
                    this.el.classList.remove('char-visible');
                }, duration);
            }
        };

        const sfx = {
            ctx: null,
            // ... (keep sfx object)
            init: function() {
                if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            },
            playTone: function(freq, type, duration, vol=0.1) {
                this.init();
                if(this.ctx.state === 'suspended') this.ctx.resume();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            tick: function() { this.playTone(800, 'triangle', 0.05, 0.05); }, 
            select: function() { this.playTone(300, 'square', 0.1, 0.1); }, 
            cash: function() { 
                this.playTone(1200, 'sine', 0.1, 0.1); 
                setTimeout(() => this.playTone(1600, 'sine', 0.2, 0.1), 100);
            },
            wasted: function() { this.playTone(50, 'sawtooth', 1.0, 0.3); },
            spray: function() { this.playTone(400, 'sawtooth', 0.2, 0.05); },
            type: function() { this.playTone(1800, 'square', 0.03, 0.03); },
            glitch: function() { 
                this.playTone(100, 'sawtooth', 0.1, 0.2);
                setTimeout(() => this.playTone(500, 'square', 0.05, 0.1), 50);
            },
            scratch: function() {
                this.init();
                if(this.ctx.state === 'suspended') this.ctx.resume();
                const bufferSize = this.ctx.sampleRate * 0.2; // 200ms scratch
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = Math.random() * 2 - 1;
                }
                const noise = this.ctx.createBufferSource();
                noise.buffer = buffer;
                const filter = this.ctx.createBiquadFilter();
                filter.type = 'highpass';
                filter.frequency.value = 1000;
                const gain = this.ctx.createGain();
                gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.2);
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(this.ctx.destination);
                noise.start();
            }
        };

        // --- Day/Night Cycle ---
        function checkDayNight() {
            const hour = new Date().getHours();
            const isNight = hour < 6 || hour > 20;
            if(isNight) {
                document.querySelector('.bg').style.backgroundImage = "linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.9)), url('https://upload.wikimedia.org/wikipedia/commons/thumb/5/5a/Los_Angeles_night_lights.jpg/1280px-Los_Angeles_night_lights.jpg')";
            }
        }

        // 3D Tilt Disabled (Mobile Optimization)
        // Graffiti Hunt Disabled (Optimization)

        // --- Cheat Codes ---
        let keyBuffer = "";
        document.addEventListener('keydown', (e) => {
            keyBuffer += e.key.toLowerCase();
            if(keyBuffer.length > 20) keyBuffer = keyBuffer.slice(-20);
            
            if(keyBuffer.endsWith("hesoyam")) {
                activateCheat();
            }
        });
        
        function activateCheat() {
            sfx.cash();
            document.getElementById('money').innerText = "$25000000";
            document.getElementById('money').style.color = "#fff";
            charSystem.show('cj', "HESOYAM ACTIVATED!", 2000);
            // Reset color
            setTimeout(() => document.getElementById('money').style.color = "var(--gta-green)", 1000);
        }

        // --- Wasted Logic ---
        function triggerWasted() {
            const el = document.getElementById('wasted-overlay');
            el.style.display = 'flex';
            sfx.wasted();
            // Slow motion effect via CSS?
            document.body.style.transition = "filter 2s";
            document.body.style.filter = "grayscale(1)";
        }
        
        function closeWasted() {
            document.getElementById('wasted-overlay').style.display = 'none';
            document.body.style.filter = "none";
        }

        // --- Graffiti Scavenger Hunt (Disabled for performance) ---
        
        // --- Init New Systems ---
        checkDayNight();
        
        // ... existing logic ...

        // --- Character System ---
        // charSystem moved to top

        // Init
        function hideLoader() {
            const pl = document.getElementById('pre-loader');
            if(pl && pl.style.display !== 'none') {
                pl.style.opacity = '0';
                setTimeout(() => pl.style.display = 'none', 500);
            }
        }

        window.onload = () => {
            hideLoader();
            loadProducts(); // CRITICAL: Load Data
            loadUserBalance(); // Load user balance on init
            try { sfx.init(); } catch(e) {} 
        };
        
        // FORCE LOAD: Backup trigger if onload fails or is overwritten
        setTimeout(() => {
            const grid = document.getElementById('product-grid');
            if(grid && grid.innerHTML.includes('LOADING')) {
                loadProducts();
            }
        }, 2000); // Increased to 2s to ensure DOM is ready
        
        // Force load after 5s timeout
        setTimeout(() => {
            const grid = document.getElementById('product-grid');
            if(grid && grid.innerHTML.includes('LOADING')) {
                grid.innerHTML = '<div class="loading" style="color:orange">TIMEOUT<br><button onclick="loadProducts()" style="background:#333;color:#fff;border:1px solid #fff;padding:8px;cursor:pointer;font-family:\'Pricedown\',serif;">FORCE LOAD</button></div>';
            }
        }, 5000);
        
        // Failsafe: Force hide loader after 3 seconds max
        setTimeout(hideLoader, 3000);

        // Global Asset Preload (Removed to fix RefError)
        
        function openRefill() {
            const modal = document.getElementById('refill-modal');
            modal.style.display = 'flex';
            // Reset any previous overrides
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
        }
        
        function closeRefill() {
            document.getElementById('refill-modal').style.display = 'none';
        }
        
        function initCustomRefill() {
            const input = document.getElementById('custom-refill');
            const btn = document.getElementById('refill-pay-btn');
            
            if(!input) return;
            
            const val = input.value;
            
            if(!val || parseFloat(val) <= 0) {
                input.style.borderColor = 'red';
                setTimeout(() => input.style.borderColor = '#333', 500);
                return;
            }
            
            if(btn) btn.innerText = 'PROCESSING...';
            
            initRefill(val).then(() => {
                if(btn) setTimeout(() => btn.innerText = 'DEPOSIT FUNDS', 1000);
            }).catch((e) => {
                if(btn) btn.innerText = 'DEPOSIT FUNDS';
                safeAlert("Error: " + e.message);
            });
        }

        function safeAlert(msg) {
            // Use try-catch because Telegram methods exist but throw errors in browser
            try {
                if(window.Telegram && window.Telegram.WebApp) {
                    // Check version - showPopup requires version 6.2+
                    const version = parseFloat(window.Telegram.WebApp.version || '0');
                    if(version >= 6.2 && window.Telegram.WebApp.showPopup) {
                        window.Telegram.WebApp.showPopup({
                            title: 'Notice',
                            message: msg,
                            buttons: [{type: 'ok'}]
                        });
                        return;
                    } else if(version >= 6.1 && window.Telegram.WebApp.showAlert) {
                        window.Telegram.WebApp.showAlert(msg);
                        return;
                    }
                }
            } catch(e) {
                console.log('Telegram popup not available, using fallback');
            }
            // Fallback to native alert
            alert(msg);
        }

        async function initRefill(amount) {
            const btns = document.querySelectorAll('.refill-btn');
            btns.forEach(b => b.disabled = true);
            
            try {
                const user = tg.initDataUnsafe?.user;
                const userId = user ? user.id : 0; 
                
                const response = await fetch('/webapp_fresh/api/create_refill', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: userId, amount: amount })
                });
                
                const data = await response.json();
                
                if(data.success) {
                    closeRefill();
                    const invModal = document.getElementById('invoice-modal');
                    
                    document.getElementById('invoice-amount').innerText = `${data.pay_amount} SOL`;
                    document.getElementById('invoice-address').innerText = data.pay_address;
                    
                    // Generate QR
                    const qrContainer = document.getElementById('qrcode');
                    qrContainer.innerHTML = "";
                    new QRCode(qrContainer, {
                        text: data.pay_address,
                        width: 150,
                        height: 150,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.L
                    });
                    
                    invModal.style.display = 'flex';
                    activePaymentId = data.payment_id;
                    
                    // Start Polling
                    if(pollInterval) clearInterval(pollInterval);
                    pollInterval = setInterval(() => pollPayment(data.payment_id), 3000);
                } else {
                    safeAlert("âš ï¸ " + (data.error || "Error creating refill"));
                }
            } catch(e) {
                safeAlert("Network Error: " + e.message);
            } finally {
                btns.forEach(b => b.disabled = false);
            }
        }

        function startApp() {
            log("startApp called");
            
            // Fix Input Obstruction - Add padding and hide nav when keyboard opens
            const dInput = document.getElementById('discount-input');
            const rInput = document.getElementById('custom-refill');
            const nav = document.querySelector('.bottom-nav');
            
            function handleInputFocus(inputElement, parentModal, isRefill = false) {
                if(nav) {
                    // Hide nav completely when typing
                    nav.style.opacity = '0';
                    nav.style.pointerEvents = 'none';
                    nav.style.transition = 'opacity 0.2s ease';
                }
                
                if(isRefill && parentModal) {
                    // Gentle lift for Refill Modal (reduced from 250px)
                    parentModal.style.transform = 'translateY(-120px)'; 
                    parentModal.style.transition = 'transform 0.3s ease';
                } else if (parentModal) {
                    // Add padding to modal content to prevent keyboard overlap (Cart)
                    parentModal.style.paddingBottom = '350px';
                    parentModal.style.transition = 'padding-bottom 0.3s ease';
                }
                
                setTimeout(() => {
                    if(inputElement) {
                        inputElement.scrollIntoView({behavior: 'smooth', block: 'center'});
                    }
                }, 150);
            }
            
            function handleInputBlur(parentModal) {
                if(nav) {
                    // Show nav again
                    nav.style.opacity = '1';
                    nav.style.pointerEvents = 'auto';
                }
                // Remove padding and reset transform
                if(parentModal) {
                    parentModal.style.paddingBottom = '0';
                    parentModal.style.transform = '';
                }
            }
            
            if(dInput) {
                const cartContainer = document.querySelector('.cart-container');
                dInput.addEventListener('focus', () => handleInputFocus(dInput, cartContainer, false));
                dInput.addEventListener('blur', () => handleInputBlur(cartContainer));
            }
            
            if(rInput) {
                // Visual Feedback for Amount
                rInput.addEventListener('input', () => {
                    const btn = document.getElementById('refill-pay-btn');
                    if(btn) {
                        const val = parseFloat(rInput.value);
                        if(val && val > 0) {
                            btn.style.opacity = '1';
                        } else {
                            btn.style.opacity = '0.5';
                        }
                    }
                });
            }
            
            // Unlock Audio Context
            if(window.AudioContext || window.webkitAudioContext) {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                ctx.resume();
            }
            
            // 1. Init Global Player (Persistent & Visible to DOM)
            audioPlayer = document.getElementById('global-audio-player');
            if(audioPlayer) {
                const station = stations[1];  // Big Poppa
                audioPlayer.src = station.src;
                // Mute initially (iOS unlock trick)
                audioPlayer.volume = 0; 
                audioPlayer.muted = true; 
                currentStation = 1;     // Sync state
                
                // FORCE PLAY IMMEDIATELY
                const radioPromise = audioPlayer.play();
                if(radioPromise !== undefined) {
                    radioPromise.then(() => console.log("Radio Playing Silently"))
                                .catch(e => console.error("Radio Start Fail", e));
                }
            }
            
            // Init Music Player (Auto-advance)
            initMusicPlayer();
            
            // Init Audio Locally
            const audioFx = new Audio('/webapp_fresh/ah_shit.mp3');
            audioFx.preload = 'auto';
            
            try {
                const btn = document.querySelector('.start-btn');
                if(btn) {
                    // Flash White
                    btn.style.color = "#fff";
                    btn.style.textShadow = "0 0 20px #fff";
                    btn.style.pointerEvents = "none"; 
                }

                // 1. Smoke ON
                const smoke = document.getElementById('smoke-overlay');
                if(smoke) {
                    smoke.style.display = 'block';
                    void smoke.offsetWidth;
                    smoke.classList.add('smoke-active');
                    log("Smoke active");
                } else {
                    log("Smoke NOT found");
                }

                // 2. Audio
                audioFx.volume = 1.0;
                const p = audioFx.play();
                if(p !== undefined) {
                    p.catch(e => log("Audio error: " + e));
                }
                log("Audio requested");

                // 3. Video Prep
                const vid = document.getElementById('intro-vid');
                if(vid) {
                    vid.muted = true;
                    vid.preload = "auto";
                    log("Video prepped");
                } else {
                    log("Video element NOT found!");
                }

                // 4. Transition
                log("Waiting for audio end...");
                audioFx.onended = performTransition;
                
                // Fallback in case onended doesn't fire (browser policy) or file duration issues
                setTimeout(() => {
                    // Only trigger if we haven't transitioned yet (Intro screen still visible)
                    const intro = document.getElementById('intro-screen');
                    if(intro && intro.style.opacity !== '0') {
                         performTransition();
                    }
                }, 15000); // Increased to 15s to ensure audio finishes

            } catch (err) {
                log("Start Crash: " + err);
                skipIntro(true);
            }
        }

        function performTransition() {
            log("performTransition called");
            try {
                // Fade In Radio (Fast)
                if(audioPlayer) {
                    // RESTART TRACK & UNMUTE
                    audioPlayer.currentTime = 0;
                    audioPlayer.muted = false;
                    
                    // Ensure it's actually playing
                    if(audioPlayer.paused) {
                        audioPlayer.play().catch(e => console.error("Resume fail", e));
                    }

                    // Fast Fade Volume Up (0.5 seconds total)
                    let vol = 0;
                    audioPlayer.volume = 0;
                    const fade = setInterval(() => {
                        vol += 0.1;
                        if(vol >= 0.5) {
                            vol = 0.5;
                            clearInterval(fade);
                        }
                        if(audioPlayer) audioPlayer.volume = vol;
                    }, 100);

                    const radioText = document.getElementById('radio-display');
                    const radioViz = document.querySelector('.radio-visualizer');
                    if(radioText) {
                        radioText.innerText = stations[1].name;
                        radioText.style.color = "#D30000";
                    }
                    if(radioViz) radioViz.classList.add('viz-active');
                } else {
                    // If for some reason it's missing, try to start it
                    toggleRadio(true);
                }
                log("Radio toggled");
                
                // 1. Switch Content (Behind the Smoke Curtain)
                const menu = document.getElementById('intro-screen');
                if(menu) menu.style.opacity = '0'; // Hide menu

                // DIRECT TO SHOP (No Emoji)
                showSection('shop');
                // Welcome message removed
                log("Switched to Shop");

                // 2. Trigger Wipe OUT (Reveal)
                const smoke = document.getElementById('smoke-overlay');
                if(smoke) {
                    // Switch animation classes
                    smoke.classList.remove('smoke-active');
                    void smoke.offsetWidth; // Force reflow
                    smoke.classList.add('smoke-dissipate');
                    
                    log("Smoke dissipate triggered");

                    // Cleanup after animation
                    setTimeout(() => {
                        smoke.style.display = 'none';
                        smoke.classList.remove('smoke-dissipate');
                        if(menu) menu.style.display = 'none';
                        
                        // Final Cleanup
                        skipIntro();
                    }, 1500); // Match CSS animation duration
                } else {
                    // Fallback
                    skipIntro();
                }

            } catch (e) {
                log("Transition Error: " + e);
                skipIntro(true);
            }
        }

        function forcePlayVideo() {
            const vid = document.getElementById('intro-vid');
            document.getElementById('play-overlay').style.display = 'none';
            document.getElementById('video-loading').style.display = 'block';
            
            vid.muted = false;
            vid.play().then(() => {
                document.getElementById('video-loading').style.display = 'none';
            }).catch(e => {
                vid.muted = true;
                vid.play();
            });
        }
        
        function skipIntro(immediate = false) {
            log(`skipIntro called (immediate=${immediate})`);
            document.body.classList.remove('video-mode');
            toggleRadio(true); 

            // Ensure Emoji is gone just in case
            const emoji = document.getElementById('emoji-intro');
            if(emoji) emoji.style.display = 'none';

            // Audio removed from here to prevent double play (handled by startApp)

            showSection('shop'); 
            // Welcome message removed
        }

        // Globals moved to top to avoid TDZ


        // --- Logic ---

        // Navigation Logic
        function showSection(id) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            const sec = document.getElementById(id);
            if(sec) sec.classList.add('active');
            
            const nav = document.getElementById('nav-'+id);
            if(nav) nav.classList.add('active');
        }

        // Coordinates for known cities (top%, left%)
        // City coordinates for positioning on the map
        // Add your cities here with their map coordinates (top%, left%)
        // Example: 'cityname': { top: 50, left: 50 }
        const CITY_COORDINATES = {
            // Lithuania city coordinates (top%, left% on the SVG map)
            // Based on REAL geography with Kaunas as reference point
            // Scale: ~6km per 1% (calculated from Kaunas-KlaipÄ—da distance)
            // NOTE: Include BOTH ASCII and Lithuanian character versions for matching!
            'kaunas': { top: 50, left: 45 },        // CENTER - Reference point (54.90Â°N, 23.90Â°E)
            'klaipeda': { top: 35, left: 10 },      // West coast - 215km W, 90km N of Kaunas
            'klaipÄ—da': { top: 35, left: 10 },      // West coast (Lithuanian chars)
            'vilnius': { top: 54, left: 61 },       // Capital - 100km ESE of Kaunas (54.69Â°N, 25.28Â°E)
            'panevezys': { top: 34, left: 51 },     // North - 110km N of Kaunas (55.73Â°N, 24.35Â°E)
            'panevÄ—Å¾ys': { top: 34, left: 51 },     // North (Lithuanian chars)
            'pasvalys': { top: 28, left: 51 },      // Far north - 150km N of Kaunas (56.06Â°N, 24.40Â°E)
            'siauliai': { top: 31, left: 39 },      // Northwest - 120km NW of Kaunas (55.93Â°N, 23.32Â°E)
            'Å¡iauliai': { top: 31, left: 39 },      // Northwest (Lithuanian chars)
            'taurage': { top: 42, left: 27 },       // West - 120km W of Kaunas (55.25Â°N, 22.29Â°E)
            'tauragÄ—': { top: 42, left: 27 },       // West (Lithuanian chars)
            'marijampole': { top: 58, left: 38 },   // South - 60km SW of Kaunas (54.57Â°N, 23.35Â°E)
            'marijampolÄ—': { top: 58, left: 38 }    // South (Lithuanian chars)
        };

        function renderMapPins() {
            const container = document.getElementById('city-pins-container');
            if (!container) return;
            container.innerHTML = '';

            // HARDCODED BLACKLIST: Cities that should NEVER appear (removed by admin)
            const BLACKLISTED_CITIES = [];
            
            // Get all cities from appLocations
            const cities = Object.keys(appLocations).filter(city => {
                const cityLower = city.toLowerCase();
                if (BLACKLISTED_CITIES.includes(cityLower)) {
                    console.warn(`ðŸš« BLOCKED BLACKLISTED CITY: ${city}`);
                    return false;
                }
                return true;
            });
            
            cities.forEach((city, index) => {
                const cityLower = city.toLowerCase();
                let coords = CITY_COORDINATES[cityLower];
                
                // If no coords, auto-position in a grid/list for visibility
                if (!coords) {
                    // Position unknown cities in a "New Locations" area
                    // Start around 75% top, distributed horizontally
                    coords = { 
                        top: 75 + (index % 3) * 8, 
                        left: 20 + (index % 4) * 15 
                    };
                }
                
                // Create GTA Marker Element (Classic Style)
                const pin = document.createElement('div');
                pin.className = 'gta-marker';
                pin.style.top = coords.top + '%';
                pin.style.left = coords.left + '%';
                
                // Clean city name for display (remove special chars if any)
                const displayName = city.toUpperCase();
                
                pin.onclick = () => zoomToCity(city, coords.top, coords.left);
                
                pin.innerHTML = `
                    <div class="marker-icon"></div>
                    <span class="marker-label">${displayName}</span>
                    <div class="blip-pulse"></div>
                `;
                
                container.appendChild(pin);
            });
        }

        // Track retry attempts for cold start handling
        let loadRetryCount = 0;
        const MAX_RETRIES = 3;
        const RETRY_DELAYS = [2000, 4000, 6000]; // Increasing delays
        
        async function loadProducts(isAutoRetry = false) {
            const grid = document.getElementById('product-grid');
            
            // CACHE STRATEGY: Instant Load
            const cached = localStorage.getItem('shop_cache');
            
            // CACHE STRATEGY: Locations - DISABLED TO FORCE FRESH FETCH
            // DO NOT load cached locations - always fetch fresh from API
            // This prevents stale data from appearing
            // Clear any existing cached locations to force fresh fetch
            localStorage.removeItem('locations_cache');
            appLocations = {}; // Start with empty object
            
            if(cached) {
                try {
                    const cData = JSON.parse(cached);
                    if(cData && cData.length > 0) {
                        allProducts = cData;
                        grid.innerHTML = ''; // Clear loading immediately
                        renderProducts(allProducts);
                        renderFilters(allProducts);
                        
                        // Try to render map pins if we have cached locations (stored separately or re-fetch)
                        // Since we don't cache locations separately yet, we rely on fetch.
                        // But if products have city data, we can infer some locations? 
                        // Better to just wait for location fetch, or cache locations too.
                    }
                } catch(e) { 
                    console.log("Cache error:", e);
                    localStorage.removeItem('shop_cache'); // Clear bad cache
                }
            }

            const loader = document.getElementById('stock-loader');
            
            // Show connecting message with retry info
            if(!cached) {
                if(isAutoRetry) {
                    grid.innerHTML = `<div class="loading" style="color:var(--gta-gold)">ðŸ”„ CONNECTING... (${loadRetryCount}/${MAX_RETRIES})<br><small style="color:#888;font-size:12px;">Server waking up, please wait...</small></div>`;
                } else {
                    grid.innerHTML = '<div class="loading" style="color:var(--gta-gold)">â³ CONNECTING...</div>';
                }
            }
            if(loader && !cached) loader.innerHTML = "SYNCING...";
            
            try {
                const controller = new AbortController();
                // Increased timeout for cold start (10s instead of 4s)
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                // Fetch products AND locations in parallel with cache-busting
                const cacheBuster = '?v=' + Date.now() + '&_=' + APP_VERSION;
                const [productsRes, locationsRes] = await Promise.all([
                    fetch('/webapp_fresh/api/products' + cacheBuster, { 
                        signal: controller.signal,
                        cache: 'no-store',
                        headers: { 'Cache-Control': 'no-cache' }
                    }),
                    fetch('/webapp_fresh/api/locations' + cacheBuster, { 
                        signal: controller.signal,
                        cache: 'no-store',
                        headers: { 'Cache-Control': 'no-cache' }
                    })
                ]);
                clearTimeout(timeoutId);
                
                const productsData = await productsRes.json();
                const locationsData = await locationsRes.json();
                
                // Reset retry count on success
                loadRetryCount = 0;
                
                // Load locations
                if(locationsData.success && locationsData.locations) {
                    // Load all cities from API (no blacklist)
                    appLocations = locationsData.locations;
                    localStorage.setItem('locations_cache', JSON.stringify(appLocations));
                    console.log("Loaded locations:", Object.keys(appLocations));
                    renderMapPins(); // Render dynamic pins
                }
                
                if(productsData.success && productsData.products) {
                    localStorage.setItem('shop_cache', JSON.stringify(productsData.products));
                    
                    allProducts = productsData.products;
                    grid.innerHTML = ''; // Clear before render
                    renderProducts(allProducts);
                    renderFilters(allProducts);
                    updateStars(Math.floor(Math.random() * 6));
                    // refreshDistrictColors(); // Removed to prevent error if undefined
                } else {
                    if(!cached) grid.innerHTML = '<div class="loading" style="color:red">NO DATA</div>';
                }
            } catch (e) {
                console.error("Fetch error:", e);
                
                // Auto-retry logic for cold start
                if(loadRetryCount < MAX_RETRIES) {
                    loadRetryCount++;
                    const delay = RETRY_DELAYS[loadRetryCount - 1] || 4000;
                    console.log(`ðŸ”„ Auto-retry ${loadRetryCount}/${MAX_RETRIES} in ${delay}ms...`);
                    
                    if(!cached) {
                        grid.innerHTML = `<div class="loading" style="color:var(--gta-gold)">ðŸ”„ WAKING UP SERVER... (${loadRetryCount}/${MAX_RETRIES})<br><small style="color:#888;font-size:12px;">Retry in ${delay/1000}s...</small></div>`;
                    }
                    
                    setTimeout(() => loadProducts(true), delay);
                } else {
                    // All retries exhausted - show manual retry button
                    if(!cached) {
                        grid.innerHTML = `<div class="loading" style="color:red">
                            âš ï¸ SERVER OFFLINE<br>
                            <small style="color:#888;font-size:12px;display:block;margin:8px 0;">Check connection or try again later</small>
                            <button onclick="loadRetryCount=0;loadProducts()" style="background:var(--gta-green);color:#000;border:none;padding:10px 20px;cursor:pointer;font-family:'Pricedown','Bungee',sans-serif;font-size:16px;border-radius:4px;margin-top:8px;">
                                ðŸ”„ RETRY
                            </button>
                        </div>`;
                    }
                }
            }
        }

        function renderProducts(products) {
            console.log("Render Products v2.1 - Strict Cleaning");
            const grid = document.getElementById('product-grid');
            grid.innerHTML = '';
            
            if(!products || products.length === 0) {
                grid.innerHTML = '<div class="loading">NO PRODUCTS AVAILABLE</div>';
                return;
            }
            
            // Filter out sold-out products (available - reserved <= 0)
            const availableProducts = products.filter(p => {
                const actualStock = (p.available || 0) - (p.reserved || 0);
                return actualStock > 0;
            });
            
            if(availableProducts.length === 0) {
                grid.innerHTML = '<div class="loading">NO PRODUCTS AVAILABLE</div>';
                return;
            }
            
            // Group products by Cleaned Name + Type + City + Size + Price
            const groups = {};
            availableProducts.forEach(p => {
                // CLEAN NAME: Remove any sequence of 6+ digits/underscores (IDs)
                // This handles cases where ID is stuck to the name in DB
                let cleanName = p.name.replace(/[\d_]{6,}.*/g, '').trim();
                
                // Also remove trailing numbers if they look like IDs
                cleanName = cleanName.replace(/\s\d+$/, '').trim();

                const key = `${cleanName.toLowerCase()}|${p.type}|${p.city}|${p.size}|${p.price}`;
                
                if(!groups[key]) {
                    groups[key] = { 
                        ...p, 
                        display_name: cleanName, // Store cleaned name for display
                        count: 0, 
                        ids: [] 
                    };
                }
                groups[key].count++;
                groups[key].ids.push(p.id);
            });
            
            const uniqueProducts = Object.values(groups);

            if(uniqueProducts.length === 0) {
                grid.innerHTML = '<div style="text-align:center; width:100%">NO ITEMS FOUND</div>';
                return;
            }
            
            uniqueProducts.forEach((p, index) => {
                const card = document.createElement('div');
                card.className = 'product-card';
                // Staggered Animation
                card.style.animationDelay = `${index * 0.05}s`;
                
                // Remove stock count badge - no longer showing
                
                card.innerHTML = `
                    <div class="product-emoji">${getProductEmoji(p.type, p.display_name)}</div>
                    <div class="product-name">${p.display_name}</div>
                    <div class="product-details">${p.size} | ${p.city}${p.district ? ' | ' + p.district : ''}</div>
                    <div class="product-price">â‚¬${p.price.toFixed(2)}</div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn-buy" style="font-size:14px; flex:1;" onmouseover="sfx.tick()" onclick="sfx.select(); addToBasket([${p.ids}], '${p.display_name}', ${p.price}, event)">ADD</button>
                        <button class="btn-buy" style="flex:2;" onmouseover="sfx.tick()" onclick="sfx.select(); buyNow([${p.ids}], '${p.display_name}', ${p.price})">BUY</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Sound FX (Old removed, using sfx object now)

        // LSPD Search
        function filterSearch(query) {
            const term = query.toLowerCase();
            const filtered = allProducts.filter(p => {
                const actualStock = (p.available || 0) - (p.reserved || 0);
                return actualStock > 0 && (
                    p.name.toLowerCase().includes(term) || 
                    p.city.toLowerCase().includes(term)
            );
            });
            renderProducts(filtered);
        }

        // Filters
        function renderFilters(products) {
            // Only show cities that have available products
            const availableProducts = products.filter(p => {
                const actualStock = (p.available || 0) - (p.reserved || 0);
                return actualStock > 0;
            });
            const cities = [...new Set(availableProducts.map(p => p.city))];
            
            const container = document.getElementById('city-filters');
            container.innerHTML = '<button class="filter-btn active" onclick="filterProducts(\'all\')">ALL ZONES</button>';
            cities.forEach(city => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.innerText = city.toUpperCase();
                btn.onclick = () => filterProducts(city);
                container.appendChild(btn);
            });
        }

        function filterProducts(city, district = null) {
            // UI Update Logic
            const container = document.getElementById('city-filters');
            
            if (city === 'all') {
                renderFilters(allProducts);
                renderProducts(allProducts);
                const label = document.querySelector('.search-label');
                if(label) label.innerText = `LSPD DATABASE > SEARCH:`;
                return;
            }

            // Filter for the selected city first (case-insensitive) AND available products only
            let cityProducts = allProducts.filter(p => {
                const actualStock = (p.available || 0) - (p.reserved || 0);
                return actualStock > 0 && p.city && p.city.toLowerCase() === city.toLowerCase();
            });
            
            // 1. Update Product Grid
            let displayProducts = cityProducts;
            if (district) {
                // Case-insensitive exact match for district
                const dTerm = district.toLowerCase().trim();
                displayProducts = cityProducts.filter(p => p.district && p.district.toLowerCase().trim() === dTerm);
            }
            renderProducts(displayProducts);

            // 2. Update Filter Bar (Show Districts)
            // Get unique districts for this city from the AVAILABLE PRODUCTS list
            const districts = [...new Set(cityProducts.map(p => p.district).filter(d => d))].sort();
            
            container.innerHTML = '';
            
            // Back Button
            const backBtn = document.createElement('button');
            backBtn.className = 'filter-btn back-btn';
            backBtn.innerText = 'ALL ZONES';
            backBtn.onclick = () => filterProducts('all');
            container.appendChild(backBtn);

            // City Button (Reset to City level)
            const cityBtn = document.createElement('button');
            cityBtn.className = 'filter-btn' + (district ? '' : ' active');
            cityBtn.innerText = city.toUpperCase(); 
            cityBtn.onclick = () => filterProducts(city);
            container.appendChild(cityBtn);

            // District Buttons
            districts.forEach(d => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn' + (district && district.toLowerCase() === d.toLowerCase() ? ' active' : '');
                btn.innerText = d.toUpperCase();
                btn.onclick = () => filterProducts(city, d);
                container.appendChild(btn);
            });

            // Update Search Label
            const label = document.querySelector('.search-label');
            if(label) {
                if(district) {
                    label.innerHTML = `LSPD > ${city.toUpperCase()} > <span style="color:#fff">${district.toUpperCase()}</span>`;
                } else {
                    label.innerHTML = `LSPD > <span style="color:#fff">${city.toUpperCase()}</span>`;
                }
            }
        }

        // Stars
        function updateStars(count) {
            const stars = document.querySelectorAll('.star');
            stars.forEach((s, i) => {
                s.classList.remove('active', 'flashing');
                if (i < count) s.classList.add('active');
                if (count === 5) s.classList.add('flashing');
            });
        }

        // Radio - Native HTML5 Audio
        // Radio - Persistent Player Logic
        function toggleRadio(forceStart = false) {
            audioPlayer = document.getElementById('global-audio-player');
            const radioViz = document.getElementById('radio-viz');
            if(!audioPlayer) return;

            // Play Static Sound
            if(window.sfx && sfx.playTone) sfx.playTone(100, 'sawtooth', 0.1, 0.05); 

            if(!forceStart) {
                currentStation = (currentStation + 1) % stations.length;
            } else {
                currentStation = 1;
            }

            const station = stations[currentStation];
            const radioText = document.getElementById('radio-display');
            
            // Update UI
            if(radioText) {
                radioText.innerText = station.name;
                radioText.style.color = "#fff"; 
                setTimeout(() => radioText.style.color = "#D30000", 300);
            }

            // Stop Visualizer
            if(radioViz) radioViz.classList.remove('viz-active');

            if(station.src) {
                audioPlayer.src = station.src;
                audioPlayer.volume = 0.5;
                
                const p = audioPlayer.play();
                if(p !== undefined) {
                    p.then(() => {
                         // Success
                         if(radioViz) radioViz.classList.add('viz-active');
                    }).catch(e => {
                         console.error("Play Error", e);
                         // Silent Fail
                    });
                }
            } else {
                // RADIO OFF
                audioPlayer.pause();
                audioPlayer.src = "";
                if(radioText) radioText.innerText = "RADIO OFF";
            }
        }

        // Next Song
        function nextSong() {
            if(currentStation === 0) currentStation = 1; // If off, start playing
            else {
                currentStation++;
                if(currentStation >= stations.length) currentStation = 1; // Loop back to first song
            }
            playCurrentStation();
        }

        // Previous Song
        function prevSong() {
            if(currentStation === 0) currentStation = stations.length - 1; // If off, play last song
            else {
                currentStation--;
                if(currentStation === 0) currentStation = stations.length - 1; // Skip "RADIO OFF"
            }
            playCurrentStation();
        }

        // Play Current Station
        function playCurrentStation() {
            audioPlayer = document.getElementById('global-audio-player');
            if(!audioPlayer) return;

            const station = stations[currentStation];
            const radioText = document.getElementById('radio-display');
            const radioViz = document.getElementById('radio-viz');
            
            if(radioText) {
                radioText.innerText = station.name;
                radioText.style.color = "#D30000";
            }

            if(station.src) {
                audioPlayer.src = station.src;
                audioPlayer.volume = 0.5;
                
                const p = audioPlayer.play();
                if(p !== undefined) {
                    p.then(() => {
                         if(radioViz) radioViz.classList.add('viz-active');
                    }).catch(e => {
                         console.error("Play Error", e);
                    });
                }
            }
        }

        // Auto-play next song when current one ends
        function initMusicPlayer() {
            audioPlayer = document.getElementById('global-audio-player');
            if(audioPlayer) {
                audioPlayer.addEventListener('ended', () => {
                    console.log("Song ended, playing next...");
                    nextSong();
                });
            }
        }

        // District Data - Now loaded dynamically from API via appLocations
        // Removed hardcoded districtData - districts now come from /webapp/api/locations

        // Map Zoom (Legacy support, redirects to menu)
        function zoomMap(cityName, topPerc, leftPerc) {
            openDistrictMenu(cityName);
        }

        function openDistrictMenu(city) {
            // Play Select Sound
            if(window.sfx) sfx.select();
            
            const menu = document.getElementById('district-menu');
            const header = document.getElementById('dm-header');
            const list = document.getElementById('dm-list');
            
            if(!menu || !header || !list) return;

            header.innerText = city.toUpperCase();
            list.innerHTML = '';
            
            // Add "ALL HOODS"
            const allBtn = document.createElement('div');
            allBtn.className = 'dm-item';
            allBtn.innerHTML = '<span>ALL HOODS</span><span>â˜…</span>';
            allBtn.onclick = () => {
                if(window.sfx) sfx.select();
                filterProducts(city); 
                closeDistrictMenu();
                showSection('shop');
                if(window.charSystem) charSystem.show('cj', `WELCOME TO ${city.toUpperCase()}!`);
            };
            list.appendChild(allBtn);

            // STRICT: Use dynamic locations from API ONLY. No fallbacks.
            let districts = [];
            if(appLocations[city] && appLocations[city].districts) {
                districts = appLocations[city].districts.map(d => ({name: d, type: 'grove'}));
            }
            
            if(districts.length === 0) {
                 districts = [{name: 'All Areas', type: 'grove'}];
            }

            districts.forEach(d => {
                const el = document.createElement('div');
                el.className = 'dm-item';
                el.innerHTML = `<span>${d.name}</span><span>ðŸ”«</span>`;
                el.onclick = () => {
                    if(window.sfx) sfx.select();
                    filterProducts(city, d.name); 
                    closeDistrictMenu();
                    showSection('shop');
                    if(window.charSystem) charSystem.show('cj', `${d.name} - GOOD CHOICE!`);
                };
                list.appendChild(el);
            });
            
            menu.classList.add('active');
        }

        function closeDistrictMenu() {
            const menu = document.getElementById('district-menu');
            if(menu) menu.classList.remove('active');
        }

        function resetMap() {
            closeDistrictMenu();
        }


        // --- Basket Logic ---
        let currentDiscount = null; 

        // --- Apple-Quality Fly-to-Cart Animation ---
        function flyToCart(e) {
            const btn = e.target;
            // FIX: Target the MAIN navigation basket icon (id="nav-basket")
            const cartIcon = document.getElementById('nav-basket');
            
            if(!cartIcon) return;

            // Create Flying Element
            const flyer = document.createElement('div');
            
            // Try to find icon in the card
            let iconContent = 'ðŸ“¦';
            const card = btn.closest('.product-card');
            if(card) {
                const emojiEl = card.querySelector('.product-emoji');
                if(emojiEl) iconContent = emojiEl.innerHTML;
            }
            
            flyer.innerHTML = iconContent;
            flyer.style.position = 'fixed';
            flyer.style.zIndex = '10000';
            flyer.style.width = '50px';
            flyer.style.height = '50px';
            flyer.style.display = 'flex';
            flyer.style.alignItems = 'center';
            flyer.style.justifyContent = 'center';
            flyer.style.color = '#fff';
            
            // Fix SVG size inside flyer
            const svg = flyer.querySelector('svg');
            if(svg) {
                svg.style.width = '100%';
                svg.style.height = '100%';
                svg.style.filter = 'drop-shadow(0 0 5px white)';
            }
            flyer.style.pointerEvents = 'none';
            flyer.style.transformOrigin = 'center';
            flyer.style.transition = 'transform 0.6s cubic-bezier(0.19, 1, 0.22, 1), opacity 0.6s ease-in';
            
            // Start Position
            const rect = btn.getBoundingClientRect();
            const startX = rect.left + rect.width/2 - 25;
            const startY = rect.top - 20;
            
            flyer.style.left = `${startX}px`;
            flyer.style.top = `${startY}px`;
            
            document.body.appendChild(flyer);

            // End Position (Cart)
            const cartRect = cartIcon.getBoundingClientRect();
            const endX = cartRect.left + cartRect.width/2 - 25;
            const endY = cartRect.top + cartRect.height/2 - 25;

            const deltaX = endX - startX;
            const deltaY = endY - startY;

            // Animate (Next Frame)
            requestAnimationFrame(() => {
                flyer.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(0.2)`;
                flyer.style.opacity = '0.2';
            });

            // Cleanup & Bounce
            setTimeout(() => {
                flyer.remove();
                // Haptic Bounce on Icon
                const icon = cartIcon.querySelector('.nav-icon');
                if(icon) {
                    icon.style.transition = 'transform 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    icon.style.transform = 'scale(1.4)';
                    setTimeout(() => icon.style.transform = 'scale(1)', 150);
                }
                
                // Flash Count (Main Nav)
                const countBadge = document.getElementById('basket-count');
                if(countBadge) {
                    countBadge.style.color = '#fff';
                    countBadge.style.transform = 'scale(1.5)';
                    countBadge.style.transition = 'all 0.2s';
                    setTimeout(() => {
                        countBadge.style.color = 'var(--gta-gold)';
                        countBadge.style.transform = 'scale(1)';
                    }, 200);
                }
            }, 600);
        }

        async function addToBasket(ids, name, price, e) {
            // 1. Smart ID Selection (Robust)
            let id = ids;
            if(Array.isArray(ids)) {
                // Get list of IDs currently in basket (as strings for safe comparison)
                const basketIds = basket.map(i => String(i.id));
                
                // Find the first candidate ID that is NOT in the basket
                const availableId = ids.find(candidate => !basketIds.includes(String(candidate)));
                
                if(availableId) {
                    id = availableId;
                    console.log(`SmartAdd: Found unused ID ${id}`);
                } else {
                    // All unique IDs are already in basket.
                    // Fallback: Pick the first one (this will likely trigger "Max stock" error unless that specific item has qty > 1)
                    id = ids[0];
                    console.log(`SmartAdd: All IDs used, falling back to ${id}`);
                }
            }

            // 2. Check basket limit
            if(basket.length >= 10) {
                if(window.charSystem) charSystem.show('cj', 'BASKET FULL! MAX 10 ITEMS.');
                safeAlert('âš ï¸ Maximum 10 items per order');
                return;
            }
            
            // 3. Get details
            const product = allProducts.find(p => p.id === id);
            if(!product) {
                console.error('Product not found:', id);
                safeAlert('âš ï¸ Product not found');
                return;
            }
            
            // 4. Check stock availability (client-side pre-check)
            const countInBasket = basket.filter(item => item.id === id).length;
            if(countInBasket >= product.available) {
                if(window.charSystem) charSystem.show('cj', 'OUT OF STOCK!');
                // Show helpful message if it's a group
                if(Array.isArray(ids)) {
                     safeAlert(`âš ï¸ Max stock reached! You have all ${ids.length} available units in your basket.`);
                } else {
                     safeAlert(`âš ï¸ Only ${product.available} available.`);
                }
                return;
            }
            
            // 5. Call Backend API to Reserve Product
            try {
                const user = tg.initDataUnsafe?.user;
                const userId = user ? user.id : 0;
                
                if(!userId) {
                    safeAlert('âš ï¸ Could not identify user');
                    return;
                }
                
                const response = await fetch('/webapp_fresh/api/basket/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user_id: userId,
                        product_id: id
                    })
                });
                
                const data = await response.json();
                
                if(!data.success) {
                    // Product unavailable or race condition
                    if(window.charSystem) charSystem.show('cj', 'PRODUCT TAKEN!');
                    safeAlert(data.error || 'âš ï¸ Product unavailable');
                    // Refresh products to update stock
                    await loadProducts();
                    return;
                }
                
                // 6. Add to local basket with server timestamp
            if(e) flyToCart(e);
                
                // Haptic feedback
                if(window.Telegram?.WebApp?.HapticFeedback) {
                    Telegram.WebApp.HapticFeedback.impactOccurred('medium');
                }
            
            basket.push({
                id: id,
                name: name,
                price: price,
                city: product.city || 'Unknown',
                district: product.district || 'Unknown',
                    type: product.type || 'misc',
                    timestamp: data.timestamp // Server timestamp for reservation tracking
            });
            
            updateBasketUI();
            currentDiscount = null;
            if(window.charSystem) charSystem.show('cj', 'NICE CHOICE!');
            const nav = document.getElementById('nav-basket');
            if(nav) {
                nav.style.color = '#fff';
                setTimeout(() => nav.style.color = '', 200);
            }
                
                // Update product stock in allProducts array
                if(data.product) {
                    const prod = allProducts.find(p => p.id === id);
                    if(prod) {
                        prod.reserved = data.product.reserved;
                    }
                }
                
            } catch(err) {
                console.error('Error adding to basket:', err);
                safeAlert('âš ï¸ Network error. Please try again.');
            }
        }
        
        async function buyNow(ids, name, price, e) {
            await addToBasket(ids, name, price, e);
            openBasket();
        }

        async function checkDiscounts(code = "") {
            const msg = document.getElementById('discount-msg');
            if(msg) {
                msg.innerText = code ? "VALIDATING..." : "CHECKING DISCOUNTS...";
                msg.style.color = "#aaa";
            }
            
            try {
                const user = tg.initDataUnsafe?.user;
                const userId = user ? user.id : 0;
                
                const response = await fetch('/webapp_fresh/api/validate_discount', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        code: code,
                        user_id: userId,
                        items: basket
                    })
                });
                
                const data = await response.json();
                
                if(data.success) {
                    currentDiscount = {
                        code: data.code_valid ? code : null,
                        reseller_discount: data.reseller_discount,
                        code_discount: data.code_valid ? data.code_discount : 0,
                        final_total: data.final_total,
                        message: data.message
                    };
                    
                    if (msg) {
                        if (data.code_valid) {
                            msg.innerText = data.message;
                            msg.style.color = "var(--gta-green)";
                            
                            // RESPECT +
                            if(window.sfx) sfx.cash();
                            const promoBox = document.querySelector('.cart-promo');
                            if(promoBox) {
                                const rp = document.createElement('div');
                                rp.className = 'respect-plus';
                                rp.innerText = 'RESPECT +';
                                promoBox.appendChild(rp);
                                setTimeout(() => rp.remove(), 3000);
                            }
                        } else if (code) {
                            msg.innerText = data.message || "INVALID CODE";
                            msg.style.color = "#f00";
                        } else if (data.reseller_discount > 0) {
                            msg.innerText = "RESELLER DISCOUNT ACTIVE";
                            msg.style.color = "var(--gta-gold)";
                        } else {
                            msg.innerText = "";
                        }
                    }
                    renderBasketContent();
                }
            } catch(e) {
                console.error(e);
                if(msg && code) {
                    msg.innerText = "ERROR CHECKING CODE";
                    msg.style.color = "#f00";
                }
            }
        }

        function applyDiscount() {
             const input = document.getElementById('discount-input');
             checkDiscounts(input.value.trim());
        }

        // --- Checkout & Payment ---
        // payment globals moved to top

        function copyText(elementId) {
            const el = document.getElementById(elementId);
            const text = el.innerText.replace(' SOL', '');
            navigator.clipboard.writeText(text).then(() => {
                const original = el.style.color;
                el.style.color = '#fff';
                setTimeout(() => el.style.color = original, 200);
                safeAlert("COPIED TO CLIPBOARD");
            });
        }

        async function initCheckout() {
            if(basket.length === 0) return;
            
            // Find the checkout button (last button in basket modal)
            const btn = document.querySelector('#basket-modal .btn-buy:last-of-type');
            const originalText = btn ? btn.innerText : "CHECKOUT";
            if(btn) {
                btn.innerText = "CONNECTING...";
                btn.disabled = true;
            }
            
            try {
                const user = tg.initDataUnsafe?.user;
                const userId = user ? user.id : 0; 
                
                const payload = {
                    user_id: userId,
                    items: basket,
                    discount_code: currentDiscount ? currentDiscount.code : null
                };

                const response = await fetch('/webapp_fresh/api/create_invoice', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if(data.success) {
                    // SPECIAL CASE: Balance-only payment (no crypto needed)
                    if(data.balance_only) {
                        document.getElementById('basket-modal').style.display = 'none';
                        
                        // Start polling immediately since it's already marked as paid
                        activePaymentId = data.payment_id;
                        
                        // Show loading overlay
                        safeAlert("âœ… Paid with balance! Processing order...");
                        
                        // Poll once immediately to trigger purchase finalization
                        pollInterval = setInterval(() => pollPayment(data.payment_id), 1000);
                        
                        if(btn) {
                            btn.innerText = originalText;
                            btn.disabled = false;
                        }
                        return;
                    }
                    
                    // NORMAL CASE: Crypto payment needed
                    document.getElementById('basket-modal').style.display = 'none';
                    const invModal = document.getElementById('invoice-modal');
                    
                    // Display balance info if used
                    let amountText = `${data.pay_amount} SOL`;
                    if(data.balance_used && data.balance_used > 0) {
                        amountText = `${data.pay_amount} SOL`;
                        // Add balance breakdown below
                        const amountHero = document.querySelector('.amount-hero');
                        if(amountHero) {
                            // Remove old balance info if exists
                            const oldBalanceInfo = amountHero.querySelector('.balance-info');
                            if(oldBalanceInfo) oldBalanceInfo.remove();
                            
                            // Add new balance info
                            const balanceInfo = document.createElement('div');
                            balanceInfo.className = 'balance-info';
                            balanceInfo.style.cssText = 'font-size: 14px; color: var(--gta-green); margin-top: 10px; font-family: Impact; letter-spacing: 1px;';
                            balanceInfo.innerHTML = `
                                <div style="opacity: 0.7;">Original: â‚¬${data.total_after_discounts.toFixed(2)}</div>
                                <div style="color: var(--gta-gold);">Balance Used: -â‚¬${data.balance_used.toFixed(2)}</div>
                            `;
                            amountHero.appendChild(balanceInfo);
                        }
                    }
                    
                    document.getElementById('invoice-amount').innerText = amountText;
                    document.getElementById('invoice-address').innerText = data.pay_address;
                    
                    // Generate QR
                    const qrContainer = document.getElementById('qrcode');
                    qrContainer.innerHTML = "";
                    new QRCode(qrContainer, {
                        text: data.pay_address,
                        width: 150,
                        height: 150,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.L
                    });
                    
                    invModal.style.display = 'flex';
                    activePaymentId = data.payment_id;
                    
                    // Start Polling
                    if(pollInterval) clearInterval(pollInterval);
                    pollInterval = setInterval(() => pollPayment(data.payment_id), 3000);
                } else {
                    // Handle errors (including stock issues)
                    let errorMsg = data.error || "Unknown error";
                    if(data.details && Array.isArray(data.details)) {
                        errorMsg = data.details.join('\n');
                    }
                    safeAlert("âš ï¸ " + errorMsg);
                    
                    // If items are unavailable, reload products to refresh availability
                    if(errorMsg.includes('unavailable') || errorMsg.includes('out of stock')) {
                        await loadProducts();
                        renderBasketContent(); // Re-render to show updated availability
                    }
                }
            } catch(e) {
                safeAlert("Network Error: " + e.message);
            } finally {
                if(btn) {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            }
        }
        
        async function pollPayment(paymentId) {
            try {
                const response = await fetch(`/webapp_fresh/api/check_payment/${paymentId}`);
                const data = await response.json();
                
                if(data.status === 'paid') {
                    clearInterval(pollInterval);
                    
                    // Check if it's a refill (payment_id starts with REFILL_)
                    if(paymentId.startsWith('REFILL_')) {
                        // Refill success
                        closeInvoice();
                        
                        // Update balance if provided
                        if(data.new_balance !== undefined) {
                            await loadUserBalance();
                        }
                        
                        // Show success alert
                        safeAlert(`âœ… Top-up successful! New balance: â‚¬${parseFloat(data.new_balance || 0).toFixed(2)}`);
                    } else {
                        // Purchase success - show Mission Passed
                    onPaymentSuccess();
                    }
                } else if (data.status === 'expired' || data.status === 'refunded') {
                    clearInterval(pollInterval);
                    closeInvoice();
                    triggerWasted(); // WASTED!
                }
            } catch(e) {
                console.log("Poll error", e);
            }
        }
        
        async function loadUserBalance() {
            try {
                const user = tg.initDataUnsafe?.user;
                const userId = user ? user.id : 0;
                
                if(!userId) return;
                
                const response = await fetch(`/webapp_fresh/api/user_balance?user_id=${userId}`);
                const data = await response.json();
                
                if(data.balance !== undefined) {
                    // Update all balance displays
                    document.querySelectorAll('.mt-value-sm, [id*="balance"]').forEach(el => {
                        if(el.innerText.includes('EUR') || el.innerText.includes('â‚¬')) {
                            el.innerText = `â‚¬${parseFloat(data.balance).toFixed(2)}`;
                        }
                    });
                    console.log('âœ… Balance updated:', data.balance);
                }
            } catch(e) {
                console.error('Error loading balance:', e);
            }
        }
        
        function closeInvoice() {
            document.getElementById('invoice-modal').style.display = 'none';
            if(pollInterval) clearInterval(pollInterval);
        }
        
        function onPaymentSuccess() {
            closeInvoice();
            basket = []; // Clear basket
            localStorage.removeItem('basket_cache'); // Clear basket cache
            updateBasketUI();
            
            // Pause Radio for Mission Passed
            if(audioPlayer && !audioPlayer.paused) {
                audioPlayer.pause();
            }
            
            // Play Mission Passed Logic
            const overlay = document.getElementById('mp-overlay');
            const sound = document.getElementById('mp-sound');
            
            overlay.style.display = 'flex';
            if(sound) {
                sound.currentTime = 0;
                sound.play().catch(e => console.log("Audio play failed", e));
                
                // Resume radio after sound (approx 8s)
                setTimeout(() => {
                    if(audioPlayer && audioPlayer.paused) audioPlayer.play().catch(e => console.log("Radio resume failed", e));
                }, 8000);
            }
            
            // Force reflow
            void overlay.offsetWidth;
            overlay.classList.add('mp-active');
            
            // Hide Mission Passed after 6 seconds, then refresh data
            setTimeout(() => {
                overlay.classList.remove('mp-active');
                overlay.style.display = 'none';
                
                // ðŸ”„ CRITICAL: Refresh products and balance after purchase
                console.log('ðŸ”„ Refreshing products and balance after purchase...');
                localStorage.removeItem('shop_cache'); // Force fresh product load
                loadProducts(); // Reload products to show updated stock
                loadUserBalance(); // Update balance display
            }, 6000);
        }

        function closeApp() {
            tg.close();
        }

        // Skins
        function changeSkin(skin) {
            const img = document.getElementById('char-img');
            if(skin === 'cj') img.src = "https://static.wikia.nocookie.net/gtawiki/images/c/ce/Carl_Johnson.png";
            if(skin === 'ryder') img.src = "https://static.wikia.nocookie.net/gtawiki/images/6/67/Ryder-GTASA.png";
            if(skin === 'sweet') img.src = "https://static.wikia.nocookie.net/gtawiki/images/1/1b/Sweet-GTASA.png";
        }

        
        function getProductEmoji(type, name = '') {
            // Check Name First (Specifics)
            const n = name.toLowerCase();
            if(n.includes('lemon') || n.includes('haze') || n.includes('skunk') || n.includes('weed')) return 'ðŸŒ¿';
            if(n.includes('kush') || n.includes('og') || n.includes('wido')) return 'ðŸ¥¦';
            if(n.includes('xan') || n.includes('tab') || n.includes('pill')) return 'ðŸ’Š';
            if(n.includes('snow') || n.includes('pure') || n.includes('coke')) return 'ðŸŒ¨ï¸';
            if(n.includes('speed') || n.includes('amp')) return 'âš¡';
            if(n.includes('lsd') || n.includes('acid')) return 'ðŸ‘…';
            if(n.includes('shroom')) return 'ðŸ„';
            if(n.includes('alus') || n.includes('beer')) return 'ðŸº';
            if(n.includes('deg') || n.includes('vodka')) return 'ðŸ¾';
            if(n.includes('pienas')) return 'ðŸ¥›';
            if(n.includes('kava')) return 'â˜•';
            
            // Fallback to Type
            if(!type) return 'ðŸ“¦';
            const t = type.toLowerCase();
            if(t.includes('weed') || t.includes('cannabis')) return 'ðŸŒ¿';
            if(t.includes('pill') || t.includes('xtc')) return 'ðŸ’Š';
            if(t.includes('powder') || t.includes('coke')) return 'ðŸŒ¨ï¸';
            return 'ðŸ“¦';
        }

        // Init - Removed immediate call, using window.onload instead

        // --- 3D GLOBE LOGIC ---
        let globeRotation = { x: -10, y: 20 };
        let isDragging = false;
        let lastTouch = { x: 0, y: 0 };

        function initGlobe() {
            const globe = document.getElementById('globe');
            if(!globe) return;

            // Touch Events
            globe.addEventListener('touchstart', (e) => {
                isDragging = true;
                const touch = e.touches[0];
                lastTouch = { x: touch.clientX, y: touch.clientY };
            });
            
            globe.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const touch = e.touches[0];
                const deltaX = touch.clientX - lastTouch.x;
                const deltaY = touch.clientY - lastTouch.y;
                
                globeRotation.y += deltaX * 0.5;
                globeRotation.x -= deltaY * 0.5;
                updateGlobeRotation();
                lastTouch = { x: touch.clientX, y: touch.clientY };
            });
            
            globe.addEventListener('touchend', () => isDragging = false);

            // Mouse Events
            globe.addEventListener('mousedown', (e) => {
                isDragging = true;
                lastTouch = { x: e.clientX, y: e.clientY };
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const deltaX = e.clientX - lastTouch.x;
                const deltaY = e.clientY - lastTouch.y;
                globeRotation.y += deltaX * 0.5;
                globeRotation.x -= deltaY * 0.5;
                updateGlobeRotation();
                lastTouch = { x: e.clientX, y: e.clientY };
            });

            document.addEventListener('mouseup', () => isDragging = false);

            // Pins
            document.querySelectorAll('.city-pin').forEach(pin => {
                pin.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const city = pin.getAttribute('data-city');
                    selectCity(city);
                });
            });
            
            // Auto-spin
            setInterval(() => {
                if(!isDragging) {
                    globeRotation.y += 0.1;
                    updateGlobeRotation();
                }
            }, 50);
        }

        function updateGlobeRotation() {
            const globe = document.getElementById('globe');
            if(globe) globe.style.transform = `rotateX(${globeRotation.x}deg) rotateY(${globeRotation.y}deg)`;
        }

        function selectCity(city) {
            if(window.sfx) sfx.select();
            
            // Rotate to city (custom rotations for specific cities)
            // You can add your cities here if you want custom 3D globe rotation
            const rots = {
                // Example: 'YourCity': { x: -10, y: 20 }
            };
            if(rots[city]) globeRotation = rots[city];
            updateGlobeRotation();
            
            openDistrictPanel(city);
        }

        function openDistrictPanel(city) {
            const panel = document.getElementById('district-panel');
            const header = document.getElementById('panel-header');
            const list = document.getElementById('panel-list');
            if(!panel) return;

            header.innerText = city.toUpperCase();
            list.innerHTML = '';

            // STRICT: Use dynamic locations from API ONLY. No fallbacks.
            let districts = [];
            if(appLocations[city] && appLocations[city].districts) {
                districts = appLocations[city].districts;
            }
            
            (districts.length > 0 ? districts : ['All Areas']).forEach(d => {
                const item = document.createElement('div');
                item.className = 'dm-item'; 
                item.innerText = d;
                item.style.padding = '15px';
                item.style.borderBottom = '1px solid #333';
                item.style.cursor = 'pointer';
                item.onmouseover = () => item.style.background = '#f0c330';
                item.onmouseout = () => item.style.background = 'transparent';
                
                item.onclick = () => {
                    closePanel();
                    showSection('shop');
                    filterProducts(city, d);
                    if(window.charSystem) charSystem.show('cj', `${d.toUpperCase()} SELECTED!`);
                };
                list.appendChild(item);
            });
            
            panel.classList.add('active');
        }

        function closePanel() {
            const panel = document.getElementById('district-panel');
            if(panel) panel.classList.remove('active');
        }

        // Initialize after DOM
        // setTimeout(initGlobe, 1000); // Disabled for Metro Map

        // --- SATELLITE VIEW LOGIC (BURNER PHONE MODE) ---
        
        let isZoomed = false;
        let currentZoomedCity = null;

        // --- ASSETS (Embedded) ---
const CHAR_ASSETS = {
    'cj': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAQACAYAAACXqOHAAAARD0lEQVR4nO3dsW0TYQCGYRtdH6wwAUpDzQqRmMANDRUTuE2RgjYTUNHQeAIkVqCmiZgAdGQCs4Gb4PzOvc/Tuvl8p7Ne/cV5tQIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD4P9ajB8BIm83mMHoD52ueZ7+RLNaL0QMAgKcnAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAETaMHwEg315ejJ3DGdvt59AQ4GScAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAEeQ8AnNCn738W/Z6DpX8/WDInAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABE2jB8CS3VxfrpZs6d8PlswJAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQdPoAVD29dfF6Aln7f3rh9ETYLGcAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAEDSNHgBl/u8eGMUJAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQevRA6Dsbnt1GL3hnO32936j4EScAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAEDSNHlB3t706jN5wzj58/rFasi8f346ecNZ+/31Y9PPh/h+329+vR29YMicAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAEeQ8ADLT09xwA58sJAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQdPoAXDMq5cX62Ofv7n9dni6Nc/Pz9t3R6/fY7n+j7v+d9sr149hnAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABA0jR5Qt9vfr0dvAMbw/DOSEwAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAILWowfQttlsDqM3LNk8zyd9xt2/533/aHMCAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAADAqucf6+9Cfvrm81YAAAAASUVORK5CYII=',
    'ryder': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAQACAYAAACXqOHAAAARZ0lEQVR4nO3dMYoTYQCG4Y2kl8EbSMDGI4iVBxAhhVZWXiCtV9gLWFlpERDPIB7BRgheYfAE8QQbhWX9Z+d9nna3+JhhhpcfklxdAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwN9t/uF/YLWmaTqP3sByzfPsHclqPRg9AAD4/wQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCC/dc29Nk3TefQGuMk8z96xLJYTAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAgjajB8BI1/vdefQGlutwPHlHslpOAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACPIZV9KmafI9ANxonmfvSFbLCQAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEHb0QNgpPcvHo2ewIIdjvPoCXBnnAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABC0HT0Ayj79ejh6wqK9efx79ARYLScAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAEbUcPgDK/dw+M4gQAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAICgzegBUHa9351Hb1iyw/HkHQV3xAkAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABB29ED6q73u/PoDUv24fWzq1X7/H30gkV78uXtqp+Pd+7/RYfjaTN6w5o5AQCAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIMj3AMBAq/+eA2CxnAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABC0HT0ALvn56uPm0t+fPn95/n9r7p8f375evH635frf8vrvd64fwzgBAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgaDt6QN3heNqM3gCM4flnJCcAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAEbUYPoG2apvPoDWs2z/OdPuPu3/2+f7Q5AQCAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAA4KrnD2LgRh7+dJDiAAAAAElFTkSuQmCC',
    'smoke': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAQACAYAAACXqOHAAAARZ0lEQVR4nO3dMYoTYQCG4UTSy+ANJGDjEcTKA4iQQisrL5DWK+wFrKy0CIhnEI9gIwSvMHiCeIJdRYn/JO/z1IF8ZDbDyw87Wa0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADg99Z/8Bq4WtM0nUZvYLnmeXaP5GrdGz0AAPj/BAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIL91zUWbpuk0egPcZp5n91gWywkAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABB69EDYKSb3fY0egPLtT8c3SO5Wk4AACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAI8j+upE3T5DkA3GqeZ/dIrpYTAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAgjajB8BIb589GD2BBdsf5tET4GycAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAELQZPQDKPvy4P3rCor16+HP0BLhaTgAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAjajB4AZX7vHhjFCQAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEHr0QOg7Ga3PY3esGT7w9E9Cs7ECQAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEGb0QOW7ma3PY3esGTvXj4ZPeGyffw6esGiPfr02vfvH7zx93Wn/eG4XoU5AQCAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIMhzAGAgz1EARnECAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABA0Gb0AC7b9xfv1yPf//HT56eR77903758Puv18fmP/fx/a7d1fbiVEwAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAII2owcs3f5wXI/eAPA33L+4ixMAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACC1qMH0DZN02n0hms2z/NZv+Ou32VfP9qcAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAsOr5BUlgRh7fUH6lAAAAAElFTkSuQmCC',
    'sweet': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAQACAYAAACXqOHAAAAREklEQVR4nO3dIY4TYQCG4ZaMJ83egKzBoDjCJihkDYYzkArMihUYxIYzYDCVKBKOgMJgNtyATDhBuUHN0v278z6Prfk6k2ne/GK6WgEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD8H+vRA2CkzWZzGL2B8zXPs99IFuvJ6AEAwMMTAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCptEDYKTrq4vREzhju/08egKcjBMAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCvAcATujD9z+Lfs/B0r8fLJkTAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAgqbRA2DJrq8uVku29O8HS+YEAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAoGn0ACj78vvp6Aln7c2zv6MnwGI5AQCAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIGgaPQDK/N89MIoTAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAgtajB0DZ7fbyMHrDOdvt7/xGwYk4AQCAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIGgaPaDudnt5GL3hnH1+/3q1aB+/jl5w1l78eLfo5+Ot+3/Ubn+3Hr1hyZwAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQ5D0AMNDi33MAnC0nAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABE2jB8AxP19+Wh/7/PnNt8PDrXl8ft28Onr97sv1v+f13166fgzjBAAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgKBp9IC63f5uPXoDMIbnn5GcAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAELQePYC2zWZzGL1hyeZ5Pukz7v497vtHmxMAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAABWPf8AeUdBkjPqhgAAAAAASUVORK5CYII=',
    'tenpenny': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAQACAYAAACXqOHAAAAREElEQVR4nO3dIXJTYRiG0YbJBrIBVoBkJg5NHTIKNKBxkXHoggZViSsa1xkkK2ADWULYQU1pv/Q+59jMNG9u5t555hfpxQUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADA/7GaHgCTNpvNaXoD5+t4PHpGsljPpgcAAI9PAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIWk0PgEm31/vT9AbO13Z38IxksZwAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQtJ4eAEv2+v3V6Pv//PrxQf/+0j8fLJkTAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAglbTA2DS7fX+NL2B87XdHTwjWSwnAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABK2nB0DZh8830xPO2pdPl9MTYLGcAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAELSeHgBl/t89MMUJAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQavpAVB2e70/TW84Z9vdwTMKHogTAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAgtbTA+pur/en6Q3n7OO3v9MTGPTy8u2i74+rd8+nJ5y17e6wmt6wZE4AACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAI8jsAMMjvHABTnAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABC0nh4Ad/l983111+svXr05Pd6ap+fPrx93Xr/7cv3vef3f7V0/xjgBAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgaD09oG67O6ymNwAz3P9McgIAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAEDQanoAbZvN5jS9YcmOx+OD3uO+v6f9/dHmBAAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgIuef0t/Qs67Yg4AAAAAAElFTkSuQmCC',
};


        // --- THE CREW DATA ---
        const gtaCharacters = [
            {
                id: 'cj',
                name: 'CARL JOHNSON',
                img: CHAR_ASSETS.cj,
                lines: [
                    "Yo! You lookin' for product here? Hold up.",
                    "Grove Street 4 Life! I got the hookup.",
                    "Ah sh*t, here we go again... Check the burner."
                ]
            },
            {
                id: 'ryder',
                name: 'RYDER',
                img: CHAR_ASSETS.ryder,
                lines: [
                    "You drive like a genius, fool! Check the phone!",
                    "Don't expect me to kiss your ass. Just buy it!",
                    "I'm a motherf***in' genius! Look at this stock!"
                ]
            },
            {
                id: 'smoke',
                name: 'BIG SMOKE',
                img: CHAR_ASSETS.smoke,
                lines: [
                    "All we had to do, was follow the damn signal, CJ!",
                    "I'll have two number 9s... and your order ready.",
                    "Remember the name! Big Smoke! Now pick a district."
                ]
            },
            {
                id: 'sweet',
                name: 'SWEET',
                img: CHAR_ASSETS.sweet,
                lines: [
                    "For the hood! We takin' over this city.",
                    "Stay true to the families. Check the supply.",
                    "Don't be a busta! Make the deal."
                ]
            },
            {
                id: 'tenpenny',
                name: 'OFFICER TENPENNY',
                img: CHAR_ASSETS.tenpenny,
                lines: [
                    "I'm watching you... make the deal and get out.",
                    "We can all get along... just pay the price.",
                    "Don't make me come down there!"
                ]
            }
        ];

        function zoomToCity(city, topP, leftP) {
            console.log("Zooming to:", city);
            if(isZoomed) return;
            isZoomed = true;
            currentZoomedCity = city;
            
            // Haptics (Apple Feel)
            if(navigator.vibrate) navigator.vibrate(15);
            if(window.sfx) sfx.select();
            
            const layer = document.getElementById('map-zoom-layer');
            const container = document.querySelector('.satellite-view');
            
            // Screen Flash (Transition Mask)
            const flash = document.createElement('div');
            flash.style.position = 'fixed';
            flash.style.top = '0'; flash.style.left = '0';
            flash.style.width = '100vw'; flash.style.height = '100vh';
            flash.style.background = '#fff';
            flash.style.opacity = '0.3';
            flash.style.pointerEvents = 'none';
            flash.style.zIndex = '9999';
            flash.style.transition = 'opacity 0.4s';
            document.body.appendChild(flash);
            
            requestAnimationFrame(() => { flash.style.opacity = '0'; });
            setTimeout(() => flash.remove(), 400);

            container.classList.add('zoomed');
            
            layer.style.transformOrigin = `${leftP}% ${topP}%`;
            layer.style.transform = 'scale(3.5)';
            
            // Fast Phone Open
            setTimeout(() => {
                openBurnerPhone(city);
            }, 800);
        }

        function resetSatelliteView() {
            if(!isZoomed) return;
            isZoomed = false;
            currentZoomedCity = null;
            
            const layer = document.getElementById('map-zoom-layer');
            const container = document.querySelector('.satellite-view');
            const scanner = document.querySelector('.scanner-text');
            
            container.classList.remove('zoomed');
            layer.style.transform = 'scale(1)';
            
            // Reset Scanner Text
            if(scanner) scanner.innerText = "SCANNING NETWORK...";
            
            // Hide CJ if active
            const cj = document.getElementById('cj-overlay');
            if(cj) cj.classList.remove('active');
            
            closeBurnerPhone();
        }

        function updateWantedLevel() {
             const stars = Math.floor(Math.random() * 5) + 1;
             const el = document.getElementById('wanted-stars');
             if(el) {
                 let str = "";
                 for(let i=0; i<5; i++) {
                     str += i < stars ? "â˜…" : "â˜†";
                 }
                 el.innerText = str;
                 el.style.color = stars >= 3 ? "#b71c1c" : "#111"; 
                 el.style.textShadow = stars >= 4 ? "0 0 5px #d32f2f" : "none";
             }
        }

        function openBurnerPhone(city) {
            const phone = document.getElementById('burner-phone');
            const list = document.getElementById('phone-contacts');
            const header = document.getElementById('phone-header');
            const dialScreen = document.getElementById('dialing-screen');
            
            if(!phone || !list) return;
            
            // Reset UI state
            if(dialScreen) dialScreen.classList.remove('active');
            if(list) list.style.display = 'flex';
            if(header) header.style.display = 'block';
            
            if(header) header.innerText = city.toUpperCase();
            list.innerHTML = '';
            
            // 1. Add "ALL ZONES" contact
            addPhoneContact(city, "ALL ZONES", 5, 0); 
            
            // 2. Add Districts (Dynamic from API)
            let districtsData = appLocations[city];
            if (!districtsData) {
                 const cityKey = Object.keys(appLocations).find(k => k.toLowerCase() === city.toLowerCase());
                 if(cityKey) districtsData = appLocations[cityKey];
            }
            
            let dList = [];
            if (districtsData) {
                if (Array.isArray(districtsData)) {
                    dList = districtsData;
                } else if (districtsData.districts && Array.isArray(districtsData.districts)) {
                    // Handle API object { city_id: ..., districts: [...] }
                    dList = districtsData.districts;
                } else if (typeof districtsData === 'object') {
                    // Fallback if keys are districts (unlikely now but safe)
                    // Filter out non-array properties like 'city_id' just in case
                    dList = Object.keys(districtsData).filter(k => k !== 'city_id' && k !== 'id' && k !== 'name');
                }
            }
            
            // Sort alphabetically
            dList.sort();
            
            dList.forEach((distName, i) => {
                // Calculate signal strength based on product count
                const count = allProducts.filter(p => 
                    p.city && p.city.toLowerCase() === city.toLowerCase() &&
                    p.district && p.district.toLowerCase() === distName.toLowerCase()
                ).length;
                
                // Signal bars (0-5)
                const bars = count > 5 ? 5 : (count > 0 ? 3 : 1);
                addPhoneContact(city, distName, bars, i + 1);
            });
            
            // Reset classes to force restart animation
            phone.classList.remove('active', 'handoff');
            void phone.offsetWidth; // Trigger reflow
            
            phone.classList.add('active');
            
            if(window.sfx) sfx.tick();
            updatePhoneTime();
            updateWantedLevel();
        }
        
        function updatePhoneTime() {
             const t = new Date();
             const str = t.getHours().toString().padStart(2, '0') + ":" + t.getMinutes().toString().padStart(2, '0');
             const span = document.getElementById('phone-time');
             if(span) span.innerText = str;
             
             // Header Clock
             const headerClock = document.getElementById('phone-clock-header');
             if(headerClock) headerClock.innerText = str;
        }
        
        function addPhoneContact(city, name, bars, index = 0) {
            const list = document.getElementById('phone-contacts');
            const item = document.createElement('div');
            item.className = 'contact-item';
            item.style.animationDelay = `${index * 0.06}s`;
            
            let signalStr = "";
            for(let i=0; i<5; i++) {
                signalStr += i < bars ? "|" : ".";
            }
            // Darker text for better visibility on green screen
            const color = bars > 0 ? '#111' : '#555'; 
            
            item.innerHTML = `
                <span>${name.toUpperCase()}</span>
                <span class="signal" style="color:${color}; font-weight:bold;">[${signalStr}]</span>
            `;
            
            item.onclick = () => {
                if(window.sfx) sfx.select();
                simulateCall(city, name);
            };
            
            list.appendChild(item);
        }

        // --- Cart Logic Restoration (Robust V3 - FORCE REBUILD) ---
        function openBasket() {
            const modal = document.getElementById('basket-modal');
            if(modal) {
                modal.style.display = 'flex';
                
                try {
                    renderBasketContent();
                } catch(e) {
                    console.error("Cart render error:", e);
                }
                
                // Force reflow
                void modal.offsetWidth;

                // Use simple Timeout for compatibility
                setTimeout(() => {
                    const container = modal.querySelector('.cart-container');
                    if(container) {
                        container.style.transform = 'translateY(0)';
                        container.classList.add('active');
                        console.log('âœ… Cart animated to visible');
                    } else {
                        console.error('âŒ cart-container not found!');
                    }
                }, 50);

                const content = document.querySelector('.content');
                if(content) content.style.filter = 'blur(5px)';
            }
            if(window.sfx) try { sfx.slide(); } catch(e){}
        }

        function closeBasket() {
            const modal = document.getElementById('basket-modal');
            if(modal) {
                const container = modal.querySelector('.cart-container');
                if(container) {
                    container.style.transform = 'translateY(100%)';
                    container.classList.remove('active');
                }
                
                setTimeout(() => {
                    modal.style.display = 'none';
                    const content = document.querySelector('.content');
                    if(content) content.style.filter = 'none';
                }, 350);
            }
            if(window.sfx) try { sfx.slide(); } catch(e){}
        }

        function updateBasketUI() {
            const count = basket.length;
            const nav = document.getElementById('nav-basket');
            if(nav) {
                 // Try to find span
                 let span = nav.querySelector('span');
                 if(!span) {
                     // If structure changed, create span
                     span = document.createElement('span');
                     nav.appendChild(span);
                 }
                 span.innerHTML = `CART <span style="color:var(--gta-gold)">(${count})</span>`;
            }
            
            const modalCount = document.getElementById('cart-nav-count');
            if(modalCount) modalCount.innerText = `(${count})`;
        }

        function renderBasketContent() {
            const container = document.getElementById('basket-items');
            const emptyState = document.getElementById('cart-empty-state');
            const invCount = document.getElementById('inv-count');
            const totalEl = document.getElementById('basket-total');
            
            if(basket.length === 0) {
                if(container) container.innerHTML = '';
                if(emptyState) emptyState.style.display = 'flex';
                if(invCount) invCount.innerText = "0 ITEMS";
                if(totalEl) totalEl.innerText = "â‚¬0.00";
                return;
            }
            
            if(emptyState) emptyState.style.display = 'none';
            if(invCount) invCount.innerText = `${basket.length} ITEMS`;
            
            if(container) {
                container.innerHTML = '';
                basket.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'cart-item';
                    div.style.animationDelay = `${index * 0.07}s`; // Stagger Effect
                    
                    // Haptic Touch Interaction
                    div.addEventListener('touchstart', () => {
                        if(window.Telegram?.WebApp?.HapticFeedback) {
                            window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
                        }
                    });

                    const typeIcon = getProductEmoji(item.type, item.name);
                    div.innerHTML = `
                        <div class="cart-item-left">
                            <div class="cart-item-icon">${typeIcon}</div>
                        </div>
                        <div class="cart-item-details">
                            <div class="cart-item-title">${item.name}</div>
                            <div class="cart-item-sub">${item.city || 'Unknown'} | ${item.district || 'Zone'}</div>
                        </div>
                        <div class="cart-item-right">
                            <div class="cart-item-price">â‚¬${item.price.toFixed(2)}</div>
                            <button class="btn-cart-remove" onclick="removeFromBasket(${index})"></button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }
            
            let total = basket.reduce((sum, item) => sum + item.price, 0);
            if(currentDiscount && currentDiscount.final_total !== undefined) {
                total = currentDiscount.final_total;
            }
            if(totalEl) totalEl.innerText = "â‚¬" + total.toFixed(2);
        }

        async function removeFromBasket(index) {
            const item = basket[index];
            if(!item) return;
            
            // Haptic feedback
            if(window.Telegram?.WebApp?.HapticFeedback) {
                Telegram.WebApp.HapticFeedback.impactOccurred('light');
            }
            
            // Animate removal
            const cartItems = document.querySelectorAll('.cart-item');
            if(cartItems[index]) {
                cartItems[index].style.transition = 'all 0.3s ease';
                cartItems[index].style.opacity = '0';
                cartItems[index].style.transform = 'translateX(-100%)';
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            try {
                const user = tg.initDataUnsafe?.user;
                const userId = user ? user.id : 0;
                
                if(!userId) {
                    safeAlert('âš ï¸ Could not identify user');
                    return;
                }
                
                // Call Backend API to Unreserve Product
                const response = await fetch('/webapp_fresh/api/basket/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user_id: userId,
                        product_id: item.id,
                        timestamp: item.timestamp || 0
                    })
                });
                
                const data = await response.json();
                
                if(data.success) {
                    // Remove from local basket
                    basket.splice(index, 1);
                    updateBasketUI();
                    renderBasketContent();
                    if(currentDiscount) checkDiscounts(currentDiscount.code);
                } else {
                    safeAlert('âš ï¸ Error removing item');
                }
            } catch(err) {
                console.error('Error removing from basket:', err);
                // Still remove locally even if API call fails (fail-safe)
                basket.splice(index, 1);
                updateBasketUI();
                renderBasketContent();
            }
        }

        function simulateCall(city, districtName) {
            const contacts = document.getElementById('phone-contacts');
            const header = document.getElementById('phone-header');
            const dialScreen = document.getElementById('dialing-screen');
            const dialStatus = document.getElementById('dial-status');
            const dialNum = document.getElementById('dial-number');
            
            // 1. Hide Contacts
            if(contacts) contacts.style.display = 'none';
            if(header) header.style.display = 'none';
            
            // 2. Show Dialing
            if(dialScreen) dialScreen.classList.add('active');
            if(dialStatus) {
                dialStatus.innerText = "DIALING...";
                dialStatus.style.color = "#111";
                dialStatus.style.animation = "blink 1s infinite";
            }
            
            // Generate fake number
            const prefix = "555";
            const suffix = Math.floor(1000 + Math.random() * 9000);
            if(dialNum) dialNum.innerText = `${prefix}-${suffix}`;
            
            // Play ringing sound loop
            let rings = 0;
            const ringInterval = setInterval(() => {
                if(window.sfx) sfx.tick();
                rings++;
                if(rings >= 4) clearInterval(ringInterval);
            }, 800);
            
            // 3. Connect
            setTimeout(() => {
                clearInterval(ringInterval);
                if(dialStatus) {
                    dialStatus.innerText = "CONNECTED";
                    dialStatus.style.animation = 'none';
                }
                if(window.sfx) sfx.select();
                
                // 4. Transition to Shop
                setTimeout(() => {
                    closeBurnerPhone();
                    resetSatelliteView();
                    showSection('shop');
                    filterProducts(city, districtName === "ALL ZONES" ? null : districtName);
                    
                    if(window.charSystem) charSystem.show('cj', `CONNECTED TO ${districtName.toUpperCase()}.`);
                    
                }, 1000);
                
            }, 2500); 
        }

        function handleKey(key) {
            if(window.sfx) sfx.tick();
            // Future: Cheat Code Implementation
            console.log("Key pressed:", key);
        }
        
        function endCall() {
             closeBurnerPhone();
             resetSatelliteView();
        }

        function closeBurnerPhone() {
            const phone = document.getElementById('burner-phone');
            if(phone) phone.classList.remove('active');
            // Only trigger reset if we are still zoomed
            if(isZoomed) resetSatelliteView();
        }
        
        // Remove Metro Init
        function goToStation(){}; // Stub
        
        // FORCE REFRESH FUNCTION - User-triggered cache clear
        function forceRefreshApp() {
            console.log('ðŸ”¥ USER TRIGGERED FORCE REFRESH');
            
            // Clear all storage
            localStorage.clear();
            sessionStorage.clear();
            console.log('âœ… All storage cleared');
            
            // Unregister service workers
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    registrations.forEach(function(registration) {
                        registration.unregister();
                        console.log('âœ… Service worker unregistered');
                    });
                }).catch(function(err) {
                    console.log('Service worker error:', err);
                });
            }
            
            // Hard reload with cache bust
            const cacheBuster = '?_force=' + Date.now() + '&v=' + Math.random();
            console.log('ðŸ”„ Performing hard reload with cache buster:', cacheBuster);
            window.location.href = window.location.href.split('?')[0] + cacheBuster;
        }

        // Apple Polish: Dynamic Parallax
        const mapContainer = document.getElementById('map-container');
        const satelliteView = document.querySelector('.satellite-view');
        
        if(mapContainer && satelliteView) {
            // Ripple on Click
            mapContainer.addEventListener('click', (e) => {
                if(typeof isZoomed !== 'undefined' && isZoomed) return;
                const ripple = document.createElement('div');
                ripple.className = 'touch-ripple';
                const rect = mapContainer.getBoundingClientRect();
                ripple.style.left = `${e.clientX - rect.left}px`;
                ripple.style.top = `${e.clientY - rect.top}px`;
                satelliteView.appendChild(ripple);
                setTimeout(() => ripple.remove(), 600);
            });

            // Parallax removed for performance
            /*
            mapContainer.addEventListener('mousemove', (e) => {
                if(typeof isZoomed !== 'undefined' && isZoomed) return;
                const rect = mapContainer.getBoundingClientRect();
                const x = (e.clientX - rect.left) / rect.width - 0.5;
                const y = (e.clientY - rect.top) / rect.height - 0.5;
                
                // Subtle shift (20px max)
                satelliteView.style.transform = `translate(${x * -20}px, ${y * -20}px)`;
                satelliteView.style.backgroundPosition = `${50 + x * 5}% ${50 + y * 5}%`;
            });
            
            mapContainer.addEventListener('mouseleave', () => {
                if(typeof isZoomed !== 'undefined' && isZoomed) return;
                satelliteView.style.transform = 'none';
                satelliteView.style.backgroundPosition = 'center center';
            });
            */
        }

        // --- Header Clock Logic ---
        function updateHeaderClock() {
            const now = new Date();
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            const clock = document.getElementById('header-clock');
            if(clock) clock.innerText = `${h}:${m}`;
            
            // Also update Phone Time if visible
            const phoneTime = document.getElementById('phone-time');
            if(phoneTime) phoneTime.innerText = `${h}:${m}`;
        }
        setInterval(updateHeaderClock, 1000);
        // Initial Call
        updateHeaderClock();
    </script>
    <!-- BURNER PHONE UI -->
    <div id="burner-phone" class="phone-container">
        <div class="phone-speaker"></div>
        <div class="phone-body">
            <div class="phone-screen">
                <div class="status-bar">
                    <span>ðŸ“¶ LTE</span>
                    <span class="wanted-stars" id="wanted-stars" style="font-size:14px; letter-spacing:1px;">â˜†â˜†â˜†â˜†â˜†</span>
                    <span id="phone-time">12:00</span>
                </div>
                
                <!-- View: Contacts -->
                <div class="screen-header" id="phone-header">CONTACTS</div>
                <div class="contact-list" id="phone-contacts">
                    <!-- Contacts go here -->
                </div>
                
                <!-- View: Dialing -->
                <div id="dialing-screen" class="dialing-screen">
                    <div class="dial-text" id="dial-status">DIALING...</div>
                    <div class="dial-number" id="dial-number">555-0192</div>
                </div>
            </div>
            <div class="phone-keypad">
                <div class="key-row">
                    <div class="key-btn call" onclick="if(window.sfx) sfx.select()">CALL</div>
                    <div class="key-btn end" onclick="endCall()">END</div>
                </div>
                <div class="key-grid">
                    <div class="num-key" onclick="handleKey('1')">1</div><div class="num-key" onclick="handleKey('2')">2</div><div class="num-key" onclick="handleKey('3')">3</div>
                    <div class="num-key" onclick="handleKey('4')">4</div><div class="num-key" onclick="handleKey('5')">5</div><div class="num-key" onclick="handleKey('6')">6</div>
                    <div class="num-key" onclick="handleKey('7')">7</div><div class="num-key" onclick="handleKey('8')">8</div><div class="num-key" onclick="handleKey('9')">9</div>
                    <div class="num-key" onclick="handleKey('*')">*</div><div class="num-key" onclick="handleKey('0')">0</div><div class="num-key" onclick="handleKey('#')">#</div>
                </div>
            </div>
        </div>
    </div>
    <!-- Global Audio Player (Persistent) -->
    <audio id="global-audio-player" crossorigin="anonymous" playsinline preload="auto" style="display:none;"></audio>
</body>